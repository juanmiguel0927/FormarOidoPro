<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Formar O칤do Pro </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 950: '#020617' }
                    },
                    screens: { 'xs': '380px' },
                    animation: {
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'bounce-short': 'bounceShort 0.5s ease-in-out',
                        'confetti': 'confettiDrop 2s ease-in-out forwards',
                    },
                    keyframes: {
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.8) translateY(20px)' },
                            '100%': { opacity: '1', transform: 'scale(1) translateY(0)' }
                        },
                        bounceShort: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.2)' }
                        },
                        confettiDrop: {
                            '0%': { transform: 'translateY(-100vh) rotate(0deg)', opacity: '1' },
                            '100%': { transform: 'translateY(100vh) rotate(720deg)', opacity: '0' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&family=Fira+Code:wght@500;700&display=swap');
        
        :root {
            --bg-main: #fdfbf7; --bg-piano: #f3f4f6; --text-main: #1e293b; --border-ui: #e2e8f0; --card-bg: #ffffff;
            --accent: #8b5cf6; --accent-hover: #7c3aed;
            --c-tonic: #8b5cf6; --c-stable: #10b981; --c-unstable: #f59e0b; --c-tension: #ef4444; 
            --active-glow: 0 0 15px rgba(139, 92, 246, 0.6);
        }

        body.dark-mode {
            --bg-main: #0f172a; --bg-piano: #1e293b; --text-main: #f8fafc; --border-ui: #334155; --card-bg: #1e293b;
            --accent: #a78bfa; --accent-hover: #c4b5fd; --active-glow: 0 0 18px rgba(167, 139, 250, 0.5);
        }

        body { font-family: 'Nunito', sans-serif; background: var(--bg-main); color: var(--text-main); height: 100vh; margin: 0; display: flex; flex-direction: column; transition: background 0.4s ease, color 0.4s ease; overflow: hidden; -webkit-user-select: none; user-select: none; }

        /* PULL TO REFRESH INDICATOR */
        #ptr-indicator { pointer-events: none; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s; transform: translateY(-100%); opacity: 0; z-index: 200; position: absolute; top: 10px; left: 0; width: 100%; display: flex; justify-content: center; }
        .ptr-spinner { width: 30px; height: 30px; border-radius: 50%; background: var(--card-bg); box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; border: 2px solid var(--accent); color: var(--accent); }

        /* PIANO & UI ELEMENTS */
        .piano-viewport { width: 100%; overflow-x: auto; padding: 10px 10px 25px 10px; background: var(--bg-piano); border-top: 2px solid var(--border-ui); display: flex; justify-content: flex-start; scrollbar-width: none; box-shadow: inset 0 4px 6px rgba(0,0,0,0.05); transition: background 0.4s ease, border-color 0.4s ease; -webkit-overflow-scrolling: touch; }
        @media (min-width: 640px) { .piano-viewport { justify-content: center; } }
        .piano-stage { position: relative; height: 140px; min-width: 600px; width: 100%; max-width: 920px; margin: 0 auto; flex-shrink: 0; }
        
        .key-white { position: absolute; top: 0; width: calc(100% / 15); height: 100%; background: linear-gradient(to bottom, #ffffff 0%, #f1f5f9 100%); border: 1px solid #cbd5e1; border-bottom: 4px solid #94a3b8; border-radius: 0 0 6px 6px; z-index: 1; cursor: pointer; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 8px; -webkit-tap-highlight-color: transparent; transition: transform 0.1s; }
        .key-white:active { transform: scale(0.98); border-bottom-width: 2px; }
        .key-black { position: absolute; top: 0; width: calc(100% / 26); height: 60%; background: linear-gradient(to bottom, #1e293b 0%, #0f172a 100%); border: 1px solid #000; border-bottom: 6px solid #000; border-radius: 0 0 4px 4px; z-index: 2; cursor: pointer; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 4px; color: white; -webkit-tap-highlight-color: transparent; transition: transform 0.1s; }
        .key-black:active { transform: scale(0.98); border-bottom-width: 3px; }

        .grid-3-cols { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; width: 100%; }
        .grid-2-cols { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; width: 100%; }
        .control-group { background: var(--card-bg); padding: 4px; border-radius: 14px; border: 1px solid var(--border-ui); box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: background 0.4s ease, border-color 0.4s ease; }
        .control-btn { padding: 8px 2px; border-radius: 10px; font-size: 9px; font-weight: 800; color: #64748b; cursor: pointer; border: 1px solid transparent; background: transparent; transition: all 0.2s; text-align: center; white-space: nowrap; text-transform: uppercase; letter-spacing: 0.05em; overflow: hidden; text-overflow: ellipsis; }
        .active-choice { background: var(--accent) !important; color: white !important; box-shadow: var(--active-glow) !important; border-color: rgba(255,255,255,0.2) !important; transform: scale(1.02); font-weight: 900 !important; }

        .action-line-container { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; width: 100%; align-items: center; }
        @media (min-width: 640px) { .action-line-container { grid-template-columns: 1fr 1.5fr 1fr 0.8fr; } }
        .compact-btn { background: var(--card-bg); border: 1px solid var(--border-ui); border-radius: 12px; padding: 0 8px; font-size: 10px; font-weight: 800; color: #64748b; text-align: center; white-space: nowrap; display: flex; align-items: center; justify-content: center; height: 42px; transition: all 0.1s; }
        .force-upper { text-transform: uppercase; letter-spacing: 0.05em; }
        .btn-new-q { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3); border: none; border-bottom: 3px solid #6d28d9; }
        .btn-new-q:active { transform: translateY(2px); border-bottom-width: 1px; }
        .btn-sprint { background: rgba(244, 63, 94, 0.1); color: #e11d48; border-color: rgba(244, 63, 94, 0.3); }
        .btn-sprint.active-sprint { background: #e11d48; color: white; box-shadow: 0 0 15px rgba(225, 29, 72, 0.5); }

        .practice-card { background: var(--card-bg); border: 2px solid var(--border-ui); border-radius: 10px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s; color: var(--text-main); }
        .practice-card:hover { transform: translateY(-3px) scale(1.05); border-color: var(--accent); color: var(--accent); }
        @media (min-width: 640px) { .practice-card { width: 36px; height: 36px; font-size: 12px; } }

        .color-tonic { color: var(--c-tonic) !important; border-color: var(--c-tonic) !important; }
        .color-stable { color: var(--c-stable) !important; border-color: var(--c-stable) !important; }
        .color-unstable { color: var(--c-unstable) !important; border-color: var(--c-unstable) !important; }
        .color-tension { color: var(--c-tension) !important; border-color: var(--c-tension) !important; }
        .bg-tonic { background: var(--c-tonic) !important; color: white !important; border: none; }
        .bg-stable { background: var(--c-stable) !important; color: white !important; border: none; }
        .bg-unstable { background: var(--c-unstable) !important; color: white !important; border: none; }
        .bg-tension { background: var(--c-tension) !important; color: white !important; border: none; }

        .degree-tag { width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 8px; }
        .note-name { font-size: 8px; font-weight: 800; font-family: 'Fira Code', monospace; margin-top: 3px; text-transform: none; }
        @media (min-width: 640px) { .degree-tag { width: 20px; height: 20px; font-size: 9px; } .note-name { font-size: 9px; } }
        
        .highlight-res { background: #fbbf24 !important; z-index: 60 !important; transform: scale(1.05); border-color: #f59e0b !important; box-shadow: 0 0 15px #f59e0b !important; }
        .buffer-indicator { display: flex; gap: 6px; margin-top: 10px; justify-content: center; }
        .buffer-dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; border: 2px solid transparent; transition: all 0.2s; }
        .buffer-dot.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); border-color: white; transform: scale(1.2); }

        #harmony-grid button { border: 2px solid var(--border-ui); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; background: var(--card-bg); min-height: 70px; border-radius: 14px; padding: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #harmony-grid button:active { transform: scale(0.98); }
        .cipher-text { font-family: 'Fira Code', monospace; font-size: 12px; font-weight: 900; color: var(--accent); text-align: center; margin-bottom: 2px; }
        .roman-text { font-size: 8px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 500; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); color: var(--text-main); max-width: 600px; width: 100%; max-height: 85vh; overflow-y: auto; border-radius: 24px; padding: 24px; border: 1px solid var(--border-ui); box-shadow: 0 20px 50px rgba(0,0,0,0.3); }

        .input-mini { width: 100%; height: 100%; background: transparent; text-align: center; font-weight: 900; font-size: 11px; color: var(--accent); outline: none; border: none; }
        .timer-container { display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--card-bg); border: 1px solid var(--border-ui); border-radius: 12px; height: 42px; }
        .timer-label { font-size: 7px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: -2px; }
        #practice-chips-container { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; padding: 4px; width: 100%; }
        .theme-toggle { cursor: pointer; padding: 8px; border-radius: 50%; background: var(--card-bg); border: 1px solid var(--border-ui); display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: #64748b; }
        .theme-toggle:hover { color: var(--accent); border-color: var(--accent); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .combo-counter { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); font-weight: 900; color: #f59e0b; text-shadow: 0 2px 4px rgba(0,0,0,0.1); opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 160; }
        .combo-active { opacity: 1; transform: translateX(-50%) scale(1.2); }

        .confetti-piece { position: absolute; width: 8px; height: 16px; background: #ffd700; opacity: 0; }
    </style>
</head>
<body class="select-none relative">

    <div id="ptr-indicator">
        <div class="ptr-spinner">
            <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        </div>
    </div>
    
    <div id="combo-display" class="combo-counter text-xl">COMBO x2</div>

    <header class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 p-2 sm:p-3 flex justify-between items-center shadow-sm z-[150] shrink-0 transition-colors duration-300 relative">
        <div class="flex items-center gap-2 sm:gap-3">
            <div class="bg-violet-600 p-1.5 rounded-xl shadow-md"><svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg></div>
            <h1 class="font-black text-xs sm:text-sm tracking-tight uppercase italic text-slate-800 dark:text-white leading-tight">Formar <br class="block sm:hidden">O칤do <span class="text-violet-500">Pro</span></h1>
        </div>
        <div class="flex items-center gap-2 sm:gap-3">
            <button onclick="openStats()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full border border-slate-200 dark:border-slate-700 hover:border-violet-400 transition-colors" title="Estad칤sticas"><svg class="w-4 h-4 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></button>
            <div id="sprint-timer-box" class="hidden flex items-center gap-1.5 bg-rose-500/10 border border-rose-500/30 px-2 sm:px-3 py-1 rounded-full"><span id="timer-val" class="text-rose-500 font-mono text-xs font-bold">01:00</span></div>
            <button onclick="openModal()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full border border-slate-200 dark:border-slate-700 hover:border-violet-400 transition-colors" title="Ayuda (H)"><svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></button>
            <button onclick="toggleTheme()" class="theme-toggle" title="Tema (T)"><svg id="sun-icon" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 2.293a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 010-1.414zm4.707 4.707a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.414A1 1 0 016.464 5l.707.707a1 1 0 01-1.414 1.414l-.707-.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z"/></svg><svg id="moon-icon" class="w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg></button>
            <div class="bg-white dark:bg-slate-800 px-2 sm:px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 font-mono text-violet-600 dark:text-violet-400 font-bold text-xs shadow-sm"><span id="score-val">0</span></div>
        </div>
    </header>

    <main id="main-scroll-container" class="flex-1 flex flex-col relative overflow-hidden bg-gradient-to-b from-transparent to-slate-100/50 dark:to-black/20">
        
        <div class="overflow-y-auto max-h-[calc(100vh-200px)] no-scrollbar z-10 shrink-0 w-full" id="inner-scroll-content">
            <div class="p-2 sm:p-5 flex flex-col gap-3 sm:gap-4 max-w-4xl mx-auto w-full">
                <!-- LEVELS & CONFIG -->
                <div class="flex flex-col gap-1.5">
                    <div class="flex justify-between items-center px-1">
                        <span class="text-[9px] uppercase font-black text-slate-400 tracking-widest">Niveles de Pr치ctica</span>
                        <div class="flex items-center gap-2 bg-white dark:bg-slate-800 px-2 py-1 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm">
                            <span class="text-[8px] font-bold text-slate-500">NOTAS:</span>
                            <input type="number" id="note-count-input" min="1" max="10" value="1" class="w-8 bg-transparent text-center font-bold text-xs text-violet-600 outline-none">
                        </div>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <div class="control-group grid-3-cols" id="level-row-1">
                            <button onclick="setLevel('basic1')" id="lvl-basic1" class="control-btn active-choice">B츼SICO 1-4</button>
                            <button onclick="setLevel('basic2')" id="lvl-basic2" class="control-btn">B츼SICO 5-8</button>
                            <button onclick="setLevel('inter')" id="lvl-inter" class="control-btn">INTERMEDIO</button>
                        </div>
                        <div class="control-group grid-3-cols" id="level-row-2">
                            <button onclick="setLevel('adv1')" id="lvl-adv1" class="control-btn">AVANZADO I</button>
                            <button onclick="setLevel('adv2')" id="lvl-adv2" class="control-btn">AVANZADO II</button>
                            <button onclick="setLevel('total')" id="lvl-total" class="control-btn">TOTAL</button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-1.5">
                    <div class="flex justify-between items-center px-1">
                        <span class="text-[9px] uppercase font-black text-slate-400 tracking-widest">Configuraci칩n Tonal</span>
                        <button onclick="toggleAutoResolve()" id="auto-resolve-btn" class="text-[7px] font-bold uppercase bg-emerald-500/10 text-emerald-600 px-2 py-0.5 rounded border border-emerald-500/20 transition-all hover:bg-emerald-500/20">Auto-Res: ON</button>
                    </div>
                    <div class="control-group grid-3-cols">
                        <button onclick="setTonalityMode('major')" id="ton-major" class="control-btn active-choice">MAYOR</button>
                        <button onclick="setTonalityMode('minor')" id="ton-minor" class="control-btn">MENOR</button>
                        <button onclick="setTonalityMode('combined')" id="ton-combined" class="control-btn">COMBINADO</button>
                    </div>
                    <div class="control-group grid-2-cols">
                        <button onclick="setGlobalMode('melody')" id="mode-mel-btn" class="control-btn active-choice text-xs py-1.5">MELOD칈A</button>
                        <button onclick="setGlobalMode('harmony')" id="mode-har-btn" class="control-btn text-xs py-1.5">ARMON칈A</button>
                    </div>
                </div>

                <!-- ACTION LINE -->
                <div class="action-line-container">
                    <div id="key-badge" class="compact-btn flex flex-col justify-center items-center order-1">
                        <span id="key-root" class="text-xs font-black text-violet-400 leading-none">C</span>
                        <span id="key-quality-label" class="text-[7px] font-bold opacity-60 uppercase tracking-wide leading-none">MAYOR</span>
                    </div>
                    <button id="btn-init" onclick="startGame()" class="compact-btn btn-new-q force-upper order-2">NUEVA PREGUNTA</button>
                    <button onclick="toggleSprint()" id="sprint-btn" class="compact-btn btn-sprint force-upper order-3">SPRINT</button>
                    <div class="timer-container order-4">
                        <span class="timer-label">TIEMPO</span>
                        <input type="number" id="sprint-time-input" value="60" class="input-mini">
                    </div>
                </div>
                <div class="flex justify-center">
                    <button id="btn-delete" onclick="deleteLastNote()" class="hidden bg-slate-100 dark:bg-slate-800 text-slate-400 font-bold px-4 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 hover:text-rose-500 active:scale-95 text-[9px] uppercase shadow-sm w-fit">Borrar 칔ltima</button>
                </div>
            </div>
        </div>

        <div id="buffer-dots" class="buffer-indicator mb-2"></div>
        
        <!-- VISUAL FEEDBACK AREA (FOR IMAGINA MODE) -->
        <div id="feedback-ui" class="hidden absolute top-1/3 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 text-center pointer-events-none w-full px-4">
            <h2 id="feedback-text" class="feedback-text transition-all drop-shadow-lg"></h2>
        </div>

        <!-- PIANO AREA -->
        <div id="piano-container-fixed" class="mt-auto relative z-30 pb-2 sm:pb-4">
            <div id="practice-module" class="flex flex-col items-center py-2 sm:py-3 bg-gradient-to-t from-transparent to-white/50 dark:to-transparent">
                <div id="practice-chips-container" class="no-scrollbar"></div>
            </div>
            <div class="piano-viewport no-scrollbar">
                <div id="piano-stage" class="piano-stage"></div>
                <div id="harmony-grid" class="hidden w-full max-w-4xl mx-auto px-2 grid grid-cols-2 gap-2 pb-8 overflow-y-auto max-h-[180px]"></div>
            </div>
            <div class="bg-white dark:bg-slate-900 p-2 sm:p-3 flex justify-center items-center gap-6 sm:gap-8 border-t border-slate-200 dark:border-slate-800 text-slate-500 dark:text-slate-400 shrink-0 shadow-inner transition-colors duration-300">
                <button id="btn-repeat-base" class="hidden text-[10px] font-bold uppercase hover:text-violet-500 transition-colors" onclick="playCurrentCadence()">Base (B)</button>
                <button onclick="toggleImagina()" class="text-[10px] font-bold uppercase hover:text-violet-500 flex items-center gap-2 transition-all">
                    <span id="imagina-dot" class="w-2 h-2 rounded-full bg-slate-400 dark:bg-slate-600 transition-colors"></span> Imagina (I)
                </button>
                <button id="btn-repeat-target" class="hidden text-[10px] font-bold uppercase hover:text-violet-500 transition-colors" onclick="repeatTargetSound()">Sonido (R)</button>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-slate-50 dark:bg-slate-950 text-slate-400 text-[9px] sm:text-[10px] py-3 sm:py-4 px-6 text-center border-t border-slate-200 dark:border-slate-900 z-50 shrink-0 font-semibold tracking-widest transition-colors duration-300">
        Desarrollado Por Juan Miguel Rios Redondo
    </footer>

    <!-- HELP MODAL -->
    <div id="help-modal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-black mb-6 text-violet-600 dark:text-violet-400 uppercase italic text-center border-b border-slate-200 dark:border-slate-700 pb-3">Gu칤a Maestra</h2>
            <div class="space-y-6 text-xs text-left">
                <section>
                    <h3 class="font-bold text-violet-500 uppercase text-[10px] mb-3 border-l-2 border-violet-500 pl-2">Metodolog칤a</h3>
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl space-y-3 opacity-90 leading-relaxed text-slate-700 dark:text-slate-300">
                        <p><strong>1. Sinton칤a:</strong> Siente la gravedad tonal con los chips de pr치ctica.</p>
                        <p><strong>2. Un칤sono:</strong> Canta internamente la resoluci칩n.</p>
                        <p><strong>3. Memoria:</strong> Ret칠n la frase completa antes de escribir.</p>
                        <p><strong>4. Armon칤a:</strong> Distingue Color (May/Men) y Funci칩n (T칩nica/Dom).</p>
                    </div>
                </section>
                <section>
                    <h3 class="font-bold text-violet-500 uppercase text-[10px] mb-3 border-l-2 border-violet-500 pl-2">Atajos</h3>
                    <div class="grid grid-cols-2 gap-y-2 gap-x-4 font-mono opacity-70 text-slate-600 dark:text-slate-400">
                        <div>Espacio/C: Nueva</div> <div>R/B: Sonido/Base</div>
                        <div>I: Imagina</div> <div>T: Tema</div>
                        <div>S: Sprint</div> <div>H: Ayuda</div>
                        <div>Bksp: Borrar</div> <div>1-6: Nivel</div>
                    </div>
                </section>
                <section>
                    <h3 class="font-bold text-violet-500 uppercase text-[10px] mb-3 border-l-2 border-violet-500 pl-2">Autoevaluaci칩n</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-slate-600 dark:text-slate-400 leading-relaxed">
                        <div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-xl">
                            <h4 class="font-black text-[9px] uppercase text-slate-400 mb-2">쮺칩mo vas?</h4>
                            <ul class="list-disc pl-3 space-y-1 opacity-80">
                                <li><strong>Lvl 1:</strong> Necesitas referencia cte.</li>
                                <li><strong>Lvl 2:</strong> Calculas mentalmente.</li>
                                <li><strong>Fluidez:</strong> Reconocimiento inst.</li>
                            </ul>
                        </div>
                    </div>
                </section>
                <button onclick="closeModal()" class="w-full bg-violet-600 hover:bg-violet-700 text-white py-3.5 rounded-xl font-black uppercase tracking-widest text-xs transition-colors shadow-lg">Entendido</button>
            </div>
        </div>
    </div>

    <!-- RESULT MODAL (NEW) -->
    <div id="result-modal" class="modal" style="display: none;">
        <div class="modal-content animate-pop-in border-4 w-[90%] max-w-sm flex flex-col items-center justify-center text-center relative overflow-hidden" id="result-card">
            <!-- Confetti Container -->
            <div id="confetti-container" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
            
            <div id="result-icon" class="text-6xl mb-4 z-10"></div>
            <h2 id="result-title" class="text-3xl font-black uppercase italic mb-2 z-10"></h2>
            <div class="w-full h-px bg-slate-200 dark:bg-slate-700 my-4 z-10"></div>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 z-10">Tu respuesta</p>
            <div id="result-user" class="font-mono text-lg font-bold mb-4 opacity-75 z-10"></div>
            
            <div id="correct-block" class="hidden w-full z-10">
                <p class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest mb-1">Correcto</p>
                <div id="result-correct" class="font-mono text-xl font-black text-emerald-600 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900/30 p-2 rounded-lg border border-emerald-500/30"></div>
            </div>

            <button onclick="startGame()" id="btn-continue-result" class="mt-8 w-full py-3 rounded-xl font-black uppercase tracking-widest text-xs transition-colors shadow-lg text-white z-10">
                Continuar
            </button>
        </div>
    </div>

    <!-- STATS MODAL (NEW) -->
    <div id="stats-modal" class="modal" onclick="closeStats()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6 border-b border-slate-200 dark:border-slate-700 pb-3">
                <h2 class="text-2xl font-black text-violet-600 dark:text-violet-400 uppercase italic">Tu Progreso</h2>
                <button onclick="closeStats()" class="text-slate-400 hover:text-slate-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            
            <!-- USERNAME INPUT (OPTION 4) -->
            <div class="mb-6">
                <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Nombre del Estudiante</label>
                <input type="text" id="username-input" placeholder="Tu Nombre" oninput="updateUsername(this.value)" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 text-sm font-bold rounded-lg p-3 outline-none border border-transparent focus:border-violet-500 transition-all">
            </div>

            <div class="flex gap-2 mb-6">
                <button onclick="exportData()" class="flex-1 bg-violet-600 hover:bg-violet-700 text-white text-[10px] font-bold uppercase py-2.5 rounded-lg shadow transition-colors flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    Exportar
                </button>
                <button onclick="importData()" class="flex-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 text-[10px] font-bold uppercase py-2.5 rounded-lg shadow-sm border border-slate-200 dark:border-slate-600 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    Importar
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl text-center border border-slate-200 dark:border-slate-700">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Precisi칩n Global</p>
                    <p id="stat-accuracy" class="text-3xl font-black text-slate-700 dark:text-white mt-1">-%</p>
                </div>
                <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl text-center border border-slate-200 dark:border-slate-700">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Racha Actual</p>
                    <p id="stat-streak" class="text-3xl font-black text-orange-500 mt-1">0 游댠</p>
                </div>
            </div>

            <div class="bg-violet-50 dark:bg-violet-900/20 p-4 rounded-xl border border-violet-100 dark:border-violet-800 mb-6">
                <h4 class="font-bold text-violet-600 dark:text-violet-400 text-xs uppercase mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    츼rea de Mejora Sugerida
                </h4>
                <p id="stat-suggestion" class="text-sm text-slate-600 dark:text-slate-300 leading-snug">
                    A칰n no hay suficientes datos. 춰Sigue practicando!
                </p>
            </div>

            <h4 class="font-bold text-slate-400 text-[10px] uppercase mb-3">Historial Reciente (칔ltimos 10)</h4>
            <div id="history-list" class="space-y-2 mb-6 max-h-40 overflow-y-auto pr-1">
                <!-- Items injected via JS -->
            </div>

            <button onclick="resetStats()" class="w-full text-rose-400 text-[10px] uppercase font-bold hover:text-rose-600 py-2">Borrar Historial</button>
        </div>
    </div>

    <script>
        // SMART NOTE NAMING ENGINE
        const BASE_NOTES = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const BASE_VALS = { 'C':0, 'D':2, 'E':4, 'F':5, 'G':7, 'A':9, 'B':11 };

        const ROOT_INDICES = { 'C': 0, 'Db': 1, 'C#': 1, 'D': 2, 'Eb': 3, 'E': 4, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'Ab': 8, 'G#': 8, 'A': 9, 'Bb': 10, 'B': 11 };
        const DEGREES = ['1', 'b2', '2', 'b3', '3', '4', '#4', '5', 'b6', '6', 'b7', '7', '8'];
        const RESOLUTIONS = { 0:[0,-5,0], 1:[1,0], 2:[2,0], 3:[3,2,0], 4:[4,2,0], 5:[5,4,2,0], 6:[6,7,12], 7:[7,12], 8:[8,7,12], 9:[9,11,12], 10:[10,11,12], 11:[11,12], 12:[12,7,12] };
        const MAJOR_PROGS = ["I - V - I", "I - IV - I", "I - IV - V - I", "I - vi - ii - V", "ii - V - I", "I - IV - vii춿 - iii - vi - ii - V - I"];
        const MINOR_PROGS = ["i - V - i", "i - iv - V - i", "i - bVI - ii춿 - V", "ii춿 - V - i", "i - bVII - bVI - V"];

        function getNoteName(rootName, semitonesFromRoot) {
            // Map semitone interval to diatonic degree shift (0-6)
            // 0=1st, 1=2nd, 2=3rd, 3=4th, 4=5th, 5=6th, 6=7th
            const semitoneToDegreeShift = {
                0: 0, // 1
                1: 1, // b2
                2: 1, // 2
                3: 2, // b3
                4: 2, // 3
                5: 3, // 4
                6: 3, // #4
                7: 4, // 5
                8: 5, // b6
                9: 5, // 6
                10: 6, // b7
                11: 6  // 7
            };

            // Parse Root
            let rootLetter = rootName.charAt(0);
            let rootAccidental = rootName.slice(1);
            let rootBaseVal = BASE_VALS[rootLetter];
            let rootMod = (rootAccidental === '#') ? 1 : (rootAccidental === 'b' ? -1 : 0);
            let rootAbs = (rootBaseVal + rootMod + 12) % 12;

            // Target Absolute Pitch
            let targetAbs = (rootAbs + semitonesFromRoot) % 12;

            // Determine Target Letter based on Scale Degree
            let rootIdx = BASE_NOTES.indexOf(rootLetter);
            let degreeShift = semitoneToDegreeShift[semitonesFromRoot];
            if (degreeShift === undefined) degreeShift = 0; // Fallback
            let targetIdx = (rootIdx + degreeShift) % 7;
            let targetLetter = BASE_NOTES[targetIdx];
            
            // Calculate necessary accidental
            let targetBaseVal = BASE_VALS[targetLetter];
            let diff = targetAbs - targetBaseVal;
            
            // Normalize diff to -6 to +6 range
            while (diff > 6) diff -= 12;
            while (diff < -6) diff += 12;
            
            let acc = "";
            if (diff === 1) acc = "#";
            else if (diff === 2) acc = "x";
            else if (diff === -1) acc = "b";
            else if (diff === -2) acc = "bb";
            
            return targetLetter + acc;
        }

        let audioCtx;
        let state = { level:'basic1', tonalityMode:'major', currentRoundTonality:'major', mode:'melody', keyIndex:48, keyLabel:'C', score:0, streak: 0, imagina:false, sprint:false, timeLeft:60, timerId:null, userBuffer:[], isPlaying:false, target:null, autoResolve:true, activeOscillators: [], timeouts: [], history: [], username: '' };

        // INIT LOAD
        try {
            const saved = localStorage.getItem('formarOidoPro_history');
            if(saved) state.history = JSON.parse(saved);
            const savedUser = localStorage.getItem('formarOidoPro_username');
            if(savedUser) state.username = savedUser;
        } catch(e){ console.log('No history'); }

        function registerTimeout(fn, delay) { const id = setTimeout(fn, delay); state.timeouts.push(id); return id; }
        function clearAllTimeouts() { state.timeouts.forEach(id => clearTimeout(id)); state.timeouts = []; }
        function initAudio() { if(!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); const comp = audioCtx.createDynamicsCompressor(); comp.connect(audioCtx.destination); state.masterOut = comp; } }
        function midiToFreq(m) { return 440 * Math.pow(2, (m - 69) / 12); }
        function playTone(freq, dur, type='triangle', start=0, vol=0.2) { 
            if(!audioCtx) return; const t = start + audioCtx.currentTime; const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); 
            osc.type = type; osc.frequency.setValueAtTime(freq, t); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(vol, t + 0.05); g.gain.exponentialRampToValueAtTime(0.001, t + dur); 
            osc.connect(g); g.connect(state.masterOut); osc.start(t); osc.stop(t + dur); state.activeOscillators.push(osc);
        }
        function stopAllSounds() { state.activeOscillators.forEach(osc => { try { osc.stop(); } catch(e) {} }); state.activeOscillators = []; state.isPlaying = false; }
        
        // --- VOICE LEADING ENGINE ---
        function getChordIntervals(type) {
            if (type === 'Maj') return [0, 4, 7];
            if (type === 'Min') return [0, 3, 7];
            if (type === 'Dim') return [0, 3, 6];
            return [0, 4, 7];
        }

        function getBestVoicing(prevVoicing, currentRoot, currentType, currentBass) {
            const intervals = getChordIntervals(currentType);
            const targetPCs = intervals.map(i => (currentRoot + i) % 12);
            if (!prevVoicing) {
                let base = currentRoot;
                while (base < 55) base += 12; 
                return intervals.map(i => base + i);
            }
            const prevNotes = prevVoicing.notes;
            const prevBass = prevVoicing.bass;
            const prevPCs = prevNotes.map(n => n % 12);
            const commonPCs = prevPCs.filter(p => targetPCs.includes(p));
            const hasCommon = commonPCs.length > 0;
            let forceDirection = 0; 
            if (!hasCommon) {
                if (currentBass > prevBass) forceDirection = -1;
                else if (currentBass < prevBass) forceDirection = 1;
            }
            let candidates = [];
            for (let r = currentRoot - 12; r <= currentRoot + 36; r += 12) {
                candidates.push([r, r + intervals[1], r + intervals[2]]); 
                candidates.push([r + intervals[1], r + intervals[2], r + 12]);
                candidates.push([r + intervals[2], r + 12, r + intervals[1] + 12]); 
            }
            let bestCand = candidates[0];
            let minCost = Infinity;
            candidates.forEach(cand => {
                cand.sort((a,b) => a - b);
                let dist = 0;
                let directionScore = 0;
                for(let i=0; i<3; i++) {
                    let d = cand[i] - prevNotes[i];
                    dist += Math.abs(d);
                    if (forceDirection === 1 && d < 0) directionScore += 50; 
                    if (forceDirection === -1 && d > 0) directionScore += 50;
                }
                const center = cand[1];
                const rangePenalty = Math.abs(center - 66) * 0.5;
                const totalCost = dist + directionScore + rangePenalty;
                if (totalCost < minCost) { minCost = totalCost; bestCand = cand; }
            });
            return bestCand;
        }

        function playVoicedChord(bass, voicing, dur, start) {
            playTone(midiToFreq(bass), dur, 'sine', start, 0.4);
            playTone(midiToFreq(bass), dur * 0.6, 'triangle', start, 0.2);
            voicing.forEach(n => { playTone(midiToFreq(n), dur, 'triangle', start, 0.1); });
        }

        function getFunctionalClass(idx) { if ([0, 12].includes(idx)) return 'tonic'; if ([4, 7, 3].includes(idx)) return 'stable'; if ([1, 3, 6, 8, 10].includes(idx)) return 'tension'; return 'unstable'; }
        function setLevel(lvl) { state.level = lvl; document.querySelectorAll('button[id^="lvl-"]').forEach(b => b.classList.remove('active-choice')); document.getElementById(`lvl-${lvl}`)?.classList.add('active-choice'); renderUI(); }
        function setTonalityMode(mode) { state.tonalityMode = mode; document.querySelectorAll('button[id^="ton-"]').forEach(b => b.classList.remove('active-choice')); document.getElementById(`ton-${mode}`)?.classList.add('active-choice'); renderUI(); }
        function toggleAutoResolve() { state.autoResolve = !state.autoResolve; const btn = document.getElementById('auto-resolve-btn'); btn.innerText = `Auto-Res: ${state.autoResolve ? 'ON' : 'OFF'}`; btn.className = `text-[7px] font-bold uppercase px-2 py-0.5 rounded border transition-all ${state.autoResolve ? 'bg-emerald-500/10 text-emerald-600 border-emerald-500/20 hover:bg-emerald-500/20' : 'bg-rose-500/10 text-rose-600 border-rose-500/20 hover:bg-rose-500/20'}`; }
        function setGlobalMode(m) { stopAllSounds(); state.mode = m; document.getElementById('mode-mel-btn')?.classList.toggle('active-choice', m === 'melody'); document.getElementById('mode-har-btn')?.classList.toggle('active-choice', m === 'harmony'); const isH = m === 'harmony'; document.getElementById('practice-module')?.classList.toggle('hidden', isH); document.getElementById('piano-stage')?.classList.toggle('hidden', isH); document.getElementById('harmony-grid')?.classList.toggle('hidden', !isH); resetUI(); }

        function startGame() {
            stopAllSounds(); clearAllTimeouts(); initAudio(); 
            state.target = null; resetUI(); 
            // KEYS to use. C, G, D, A, E, B, F, Bb, Eb, Ab. 
            // Avoid extreme keys like F# or C# for now to keep it simple, or add them.
            // Let's use the ones we have defined logic for implicitly via getNoteName (all).
            const keys = ['C','G','D','A','E','B','F','Bb','Eb','Ab'];
            state.keyLabel = keys[Math.floor(Math.random()*keys.length)];
            state.keyIndex = 48 + ROOT_INDICES[state.keyLabel];
            state.currentRoundTonality = state.tonalityMode === 'combined' ? (Math.random() > 0.5 ? 'major' : 'minor') : state.tonalityMode;
            document.getElementById('key-root').innerText = state.keyLabel; document.getElementById('key-quality-label').innerText = state.currentRoundTonality === 'major' ? 'MAYOR' : 'MENOR';
            document.getElementById('key-badge').classList.remove('hidden'); renderUI();
            if (state.sprint) generateQuestion(); else playCadence(() => generateQuestion());
        }

        function playCadence(cb) { 
            state.isPlaying = true; 
            const type = state.currentRoundTonality === 'major' ? 'Maj' : 'Min'; 
            let t = 0; 
            let prevVoicing = null;
            const degrees = [0, 5, 7, 0];
            degrees.forEach(deg => {
                const root = state.keyIndex + deg;
                let bass = root;
                while (bass >= 48) bass -= 12; 
                if (bass < 36) bass += 12;
                const chordType = (deg === 5 || deg === 0 || (deg === 7 && type === 'Maj')) ? 'Maj' : (type === 'Min' ? 'Min' : 'Maj'); 
                const finalType = (deg === 7) ? 'Maj' : (deg === 0 || deg === 5 ? type : 'Maj'); 
                const voicing = getBestVoicing(prevVoicing, root, finalType, bass);
                playVoicedChord(bass, voicing, 1.0, t);
                prevVoicing = { notes: voicing, bass: bass };
                t += 1.0; 
            }); 
            registerTimeout(() => { if(state.isPlaying) { state.isPlaying = false; if(cb) cb(); } }, t * 1000); 
        }

        function generateQuestion() {
            state.userBuffer = []; const count = parseInt(document.getElementById('note-count-input').value) || 1;
            
            if(state.mode === 'melody') {
                const possible = getPossibleIntervals(); const sequence = []; 
                for(let i=0; i<count; i++) { 
                    const interval = possible[Math.floor(Math.random()*possible.length)]; 
                    const midi = state.keyIndex + interval; 
                    sequence.push({ interval, midi }); 
                }
                state.target = { type: 'melody', sequence }; 
                renderBufferDots(count); 
                if(count > 1) document.getElementById('btn-delete').classList.remove('hidden');
            } else {
                const list = state.currentRoundTonality === 'major' ? MAJOR_PROGS : MINOR_PROGS; 
                const correct = list[Math.floor(Math.random()*list.length)];
                const opts = [correct, ...list.filter(x=>x!==correct).sort(()=>0.5-Math.random()).slice(0,3)].sort(()=>0.5-Math.random());
                state.target = { type: 'harmony', answer: correct, options: opts }; 
                renderHarmonyOptions(opts); 
            }

            // --- IMAGINA LOGIC ---
            if (state.imagina) {
                // Visual Prompt
                const text = state.mode === 'melody' 
                    ? `Canta: ${state.target.sequence.map(s => DEGREES[s.interval]).join(' - ')}` 
                    : `Canta: ${state.target.answer}`; 
                
                const fb = document.getElementById('feedback-text');
                fb.innerText = text;
                fb.className = "feedback-text text-violet-400 text-2xl sm:text-4xl animate-pulse";
                document.getElementById('feedback-ui').classList.remove('hidden');
            } else {
                // Audio Playback
                if(state.mode === 'melody') {
                    let t = 0;
                    state.target.sequence.forEach(s => {
                        playTone(midiToFreq(s.midi), 0.7, 'triangle', t, 0.4); 
                        t += 0.8;
                    });
                } else {
                    playProgression(state.target.answer);
                }
            }

            document.getElementById('btn-repeat-base').classList.toggle('hidden', state.sprint); 
            document.getElementById('btn-repeat-target').classList.remove('hidden');
        }

        function playProgression(progStr) { 
            const chords = progStr.split(' - '); 
            const map = { 'I':0, 'ii':2, 'iii':4, 'IV':5, 'V':7, 'vi':9, 'vii':11, 'vii춿':11, 'i':0, 'ii춿':2, 'III':3, 'iv':5, 'v':7, 'VI':8, 'VII':10, 'bII':1, 'bIII':3, '#IV':6, 'bVI':8, 'bVII':10, 'V/vi':4, 'V/V':2, 'V/IV':0, 'V/ii':9 }; 
            let t = 0; 
            let prevVoicing = null;
            chords.forEach((c) => { 
                const root = state.keyIndex + (map[c.trim().replace(/7|maj|m|춿/g, '')] || 0); 
                const ty = (c.includes('m') || c.toLowerCase() === c) ? 'Min' : 'Maj'; 
                let bass = root;
                while (bass >= 48) bass -= 12;
                if (bass < 36) bass += 12;
                const voicing = getBestVoicing(prevVoicing, root, ty, bass);
                playVoicedChord(bass, voicing, 1.2, t);
                prevVoicing = { notes: voicing, bass: bass };
                t += 1.2; 
            }); 
        }

        function getPossibleIntervals() {
            const isMin = state.currentRoundTonality === 'minor';
            if (state.level === 'basic1') return isMin ? [0, 2, 3, 5] : [0, 2, 4, 5]; if (state.level === 'basic2') return isMin ? [7, 8, 10, 12] : [7, 9, 11, 12];
            if (state.level === 'inter') return [0, 2, 3, 4, 5, 7, 9, 11, 12]; if (state.level === 'adv1') return [0, 1, 2, 3, 4, 5]; if (state.level === 'adv2') return [6, 7, 8, 9, 10, 11, 12];
            return Array.from({length: 13}, (_, i) => i);
        }

        function saveHistory(correct, detail) {
            state.history.unshift({ date: Date.now(), correct, mode: state.mode, level: state.level, detail });
            if(state.history.length > 50) state.history = state.history.slice(0, 50);
            localStorage.setItem('formarOidoPro_history', JSON.stringify(state.history));
        }

        function checkAnswer(val) {
            if(!state.target || state.isPlaying) return;
            let isCorrect = false; let detail = ""; let userAns = ""; let correctAns = "";

            if(state.mode === 'melody') {
                state.userBuffer.push(val);
                const dots = document.querySelectorAll('.buffer-dot');
                if(dots[state.userBuffer.length - 1]) dots[state.userBuffer.length - 1].classList.add('active');
                if(state.userBuffer.length === state.target.sequence.length) {
                    isCorrect = state.userBuffer.every((v, i) => v === state.target.sequence[i].interval);
                    userAns = state.userBuffer.map(s => DEGREES[s]).join(' - ');
                    correctAns = state.target.sequence.map(s => DEGREES[s.interval]).join(' - ');
                    detail = correctAns;
                    if(state.autoResolve && state.target.sequence.length === 1) executeVisualResolution(state.target.sequence[0].interval, false);
                    handleResult(isCorrect, userAns, correctAns, detail);
                    state.target = null;
                }
            } else {
                isCorrect = val === state.target.answer;
                userAns = val;
                correctAns = state.target.answer;
                detail = correctAns;
                renderHarmonyOptions(state.target.options, val, state.target.answer);
                handleResult(isCorrect, userAns, correctAns, detail);
                state.target = null;
            }
        }

        function handleResult(isCorrect, user, correct, detail) {
            saveHistory(isCorrect, detail);
            
            // GAMIFICATION LOGIC
            const comboEl = document.getElementById('combo-display');
            if(isCorrect) { 
                state.score++; 
                state.streak++;
                document.getElementById('score-val').innerText = state.score; 
                
                if(state.streak > 1) {
                    comboEl.innerText = `COMBO x${state.streak} 游댠`;
                    comboEl.classList.add('combo-active');
                    // Add bounce animation
                    comboEl.style.animation = 'none';
                    comboEl.offsetHeight; /* trigger reflow */
                    comboEl.style.animation = 'bounceShort 0.5s ease-in-out';
                }
                triggerConfetti(); // FIREWORKS
            } else {
                state.streak = 0;
                comboEl.classList.remove('combo-active');
            }

            showResultModal(isCorrect, user, correct);
        }

        function triggerConfetti() {
            const container = document.getElementById('confetti-container');
            container.innerHTML = ''; // clear previous
            
            const colors = ['#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#3b82f6'];
            
            for(let i=0; i<30; i++) {
                const el = document.createElement('div');
                el.className = 'confetti-piece';
                el.style.left = Math.random() * 100 + '%';
                el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                el.style.animationDelay = Math.random() * 0.5 + 's';
                el.style.transform = `rotate(${Math.random() * 360}deg)`;
                el.style.animation = `confettiDrop ${1 + Math.random()}s ease-out forwards`;
                container.appendChild(el);
            }
        }

        function showResultModal(isCorrect, user, correct) {
            const m = document.getElementById('result-modal');
            const card = document.getElementById('result-card');
            const icon = document.getElementById('result-icon');
            const title = document.getElementById('result-title');
            const uText = document.getElementById('result-user');
            const cBlock = document.getElementById('correct-block');
            const cText = document.getElementById('result-correct');
            const btn = document.getElementById('btn-continue-result');

            m.style.display = 'flex';
            
            if(isCorrect) {
                card.className = "modal-content animate-pop-in border-4 border-emerald-500/50 w-[90%] max-w-sm flex flex-col items-center justify-center text-center relative overflow-hidden";
                icon.innerHTML = "游꿀";
                title.innerText = "춰Excelente!";
                title.className = "text-3xl font-black uppercase italic mb-2 text-emerald-500 z-10";
                uText.innerText = user;
                uText.className = "font-mono text-lg font-bold mb-4 text-emerald-600 z-10";
                cBlock.classList.add('hidden');
                btn.className = "mt-6 w-full py-3 rounded-xl font-black uppercase tracking-widest text-xs transition-colors shadow-lg text-white bg-emerald-500 hover:bg-emerald-600 z-10";
                registerTimeout(() => { if(m.style.display === 'flex') { m.style.display = 'none'; startGame(); } }, 1500);
            } else {
                card.className = "modal-content animate-pop-in border-4 border-rose-500/50 w-[90%] max-w-sm flex flex-col items-center justify-center text-center relative overflow-hidden";
                // remove confetti container if incorrect just in case
                document.getElementById('confetti-container').innerHTML = '';
                
                icon.innerHTML = "仇";
                title.innerText = "Casi...";
                title.className = "text-3xl font-black uppercase italic mb-2 text-rose-500 z-10";
                uText.innerText = user;
                uText.className = "font-mono text-lg font-bold mb-4 text-rose-600 line-through decoration-2 opacity-70 z-10";
                cBlock.classList.remove('hidden');
                cText.innerText = correct;
                btn.className = "mt-6 w-full py-3 rounded-xl font-black uppercase tracking-widest text-xs transition-colors shadow-lg text-white bg-slate-800 hover:bg-slate-700 z-10";
            }
        }

        function updateUsername(val) {
            state.username = val;
            localStorage.setItem('formarOidoPro_username', val);
        }

        function openStats() {
            const h = state.history;
            const total = h.length;
            const correct = h.filter(x => x.correct).length;
            const acc = total ? Math.round((correct/total)*100) : 0;
            document.getElementById('stat-accuracy').innerText = acc + "%";
            document.getElementById('stat-streak').innerText = state.streak + " 游댠";
            document.getElementById('username-input').value = state.username || '';

            let suggestion = "Continua practicando para generar datos.";
            if(total > 5) {
                const mel = h.filter(x=>x.mode==='melody');
                const har = h.filter(x=>x.mode==='harmony');
                const melAcc = mel.length ? mel.filter(x=>x.correct).length/mel.length : 1;
                const harAcc = har.length ? har.filter(x=>x.correct).length/har.length : 1;
                if(melAcc < harAcc && melAcc < 0.8) suggestion = "Tu o칤do arm칩nico es fuerte. Enf칩cate en intervalos mel칩dicos simples.";
                else if(harAcc < melAcc && harAcc < 0.8) suggestion = "Tienes buena memoria mel칩dica. Refuerza la identificaci칩n de progresiones.";
                else if(acc > 90) suggestion = "춰Imparable! Es hora de subir al nivel Avanzado o Sprint.";
                else suggestion = "Mant칠n el ritmo. Trata de cantar la nota antes de responder.";
            }
            document.getElementById('stat-suggestion').innerText = suggestion;

            const list = document.getElementById('history-list'); list.innerHTML = '';
            h.slice(0, 10).forEach(x => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-center bg-slate-50 dark:bg-slate-800 p-2 rounded text-[10px]";
                row.innerHTML = `<span class="font-bold ${x.correct ? 'text-emerald-500' : 'text-rose-500'}">${x.correct ? 'ACIERTO' : 'FALLO'}</span> <span class="opacity-60">${x.mode} - ${x.detail}</span>`;
                list.appendChild(row);
            });
            document.getElementById('stats-modal').style.display = 'flex';
        }

        function resetStats() { state.history = []; localStorage.removeItem('formarOidoPro_history'); openStats(); }
        function closeStats() { document.getElementById('stats-modal').style.display = 'none'; }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.history));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const name = state.username || 'oido';
            const safeName = name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            downloadAnchorNode.setAttribute("download", `entrenamiento_${safeName}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.readAsText(file,'UTF-8');
                reader.onload = readerEvent => {
                    try {
                        const content = JSON.parse(readerEvent.target.result);
                        if (Array.isArray(content)) {
                            state.history = content;
                            localStorage.setItem('formarOidoPro_history', JSON.stringify(state.history));
                            alert('Datos importados correctamente.');
                            openStats();
                        } else {
                            alert('Archivo inv치lido.');
                        }
                    } catch (error) {
                        alert('Error al leer el archivo.');
                    }
                }
            }
            input.click();
        }

        function deleteLastNote() { if(state.userBuffer.length > 0) { const dots = document.querySelectorAll('.buffer-dot'); dots[state.userBuffer.length - 1].classList.remove('active'); state.userBuffer.pop(); } }
        function executeVisualResolution(degreeIdx, next, delay = 0) { if(parseInt(document.getElementById('note-count-input').value) > 1 && next) return; const path = RESOLUTIONS[degreeIdx] || [degreeIdx]; let t = delay / 1000; path.forEach((step, idx) => { const midi = state.keyIndex + step; const dur = (idx === path.length - 1) ? 1.0 : 0.4; playTone(midiToFreq(midi), dur, idx === 0 ? 'triangle' : 'sine', t, 0.2); registerTimeout(() => { const k = document.querySelector(`[data-interval="${step}"]`); if(k) { k.classList.add('highlight-res'); registerTimeout(() => k.classList.remove('highlight-res'), 400); } }, t * 1000); t += dur; }); if(next) registerTimeout(() => startGame(), t * 1000 + 400); }
        function renderUI() { renderPiano(); renderPracticeChips(); }
        function renderPiano() { const stage = document.getElementById('piano-stage'); stage.innerHTML = ''; const offsets = [0, 0.6, 1, 1.6, 2, 3, 3.6, 4, 4.6, 5, 5.6, 6]; const rootOffset = ROOT_INDICES[state.keyLabel] || 0; for(let i=0; i<25; i++) { const midi = 48 + i; const abs = midi % 12; const relPos = (Math.floor(i/12)*7) + offsets[abs]; const btn = document.createElement('button'); btn.className = `piano-key ${[1, 3, 6, 8, 10].includes(abs) ? 'key-black' : 'key-white'}`; btn.style.left = `calc(${relPos} * (100% / 15))`; const functional = midi - state.keyIndex; if(functional >= 0 && functional <= 12) { btn.setAttribute('data-interval', functional); const noteName = getNoteName(state.keyLabel, functional); btn.innerHTML = `<div class="degree-tag bg-${getFunctionalClass(functional)}">${DEGREES[functional]}</div><div class="note-name color-${getFunctionalClass(functional)}">${noteName}</div>`; } btn.onclick = () => { initAudio(); playTone(midiToFreq(midi), 0.5); if(functional >= 0 && functional <= 12) checkAnswer(functional); }; stage.appendChild(btn); } }
        function renderPracticeChips() { const container = document.getElementById('practice-chips-container'); container.innerHTML = ''; const list = getPossibleIntervals(); list.forEach(idx => { const card = document.createElement('div'); card.className = `practice-card bg-${getFunctionalClass(idx)} text-white`; card.innerHTML = DEGREES[idx]; card.onclick = () => { initAudio(); executeVisualResolution(idx, false); const k = document.querySelector(`[data-interval="${idx}"]`); if(k) { k.classList.add('highlight-res'); registerTimeout(() => k.classList.remove('highlight-res'), 600); } }; container.appendChild(card); }); }
        function renderHarmonyOptions(opts, clicked = null, correct = null) { const grid = document.getElementById('harmony-grid'); grid.innerHTML = ''; opts.forEach(o => { const btn = document.createElement('button'); const cipher = o.split(' - ').map(r => { const map = {'I':0,'IV':5,'V':7,'vi':9,'ii':2,'iii':4,'vii':11,'vii춿':11,'i':0,'iv':5,'bVI':8,'bVII':10,'V/vi':4,'V/V':2,'V/IV':0,'V/ii':9}; const interval = map[r.trim().replace(/7|maj|m|춿/g,'')] || 0; const note = getNoteName(state.keyLabel, interval); return note + (r.includes('m') || r.toLowerCase() === r ? 'm' : ''); }).join(' - '); btn.innerHTML = `<div class="cipher-text">${cipher}</div><div class="roman-text opacity-60 text-[7px] font-bold">${o}</div>`; if(clicked) { if(o === correct) btn.className = "p-2 border-2 border-emerald-500 bg-emerald-600/20 text-emerald-400 font-black rounded-xl shadow-lg"; else if(o === clicked) btn.className = "p-2 border-2 border-rose-500 bg-rose-600/20 text-rose-400 opacity-50 rounded-xl"; } else btn.onclick = () => checkAnswer(o); grid.appendChild(btn); }); }
        function renderBufferDots(count) { const container = document.getElementById('buffer-dots'); container.innerHTML = ''; for(let i=0; i<count; i++) { const dot = document.createElement('div'); dot.className = 'buffer-dot'; container.appendChild(dot); } }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); document.documentElement.classList.toggle('dark'); const sun = document.getElementById('sun-icon'); const moon = document.getElementById('moon-icon'); if (document.body.classList.contains('dark-mode')) { sun.classList.add('hidden'); moon.classList.remove('hidden'); } else { sun.classList.remove('hidden'); moon.classList.add('hidden'); } }
        function resetUI() { 
            document.getElementById('result-modal').style.display = 'none'; 
            document.getElementById('feedback-ui').classList.add('hidden');
            document.getElementById('btn-delete').classList.add('hidden'); 
            document.getElementById('harmony-grid').innerHTML = ''; 
            state.userBuffer = []; 
            renderUI(); 
        }
        function toggleImagina() { state.imagina = !state.imagina; document.getElementById('imagina-dot').className = `w-1.5 h-1.5 rounded-full ${state.imagina ? 'bg-emerald-400' : 'bg-slate-700'}`; }
        function repeatTargetSound() { if(state.target) { if(state.mode === 'melody') state.target.sequence.forEach((s, i) => playTone(midiToFreq(s.midi), 0.6, 'triangle', i * 0.8, 0.4)); else playProgression(state.target.answer); } }
        function playCurrentCadence() { if(!state.isPlaying) playCadence(); }
        function openModal() { document.getElementById('help-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('help-modal').style.display = 'none'; }
        function toggleSprint() { state.sprint = !state.sprint; document.getElementById('sprint-timer-box').classList.toggle('hidden', !state.sprint); if (state.sprint) { state.timeLeft = parseInt(document.getElementById('sprint-time-input').value) || 60; startTimer(); startGame(); } else { clearInterval(state.timerId); } }
        function startTimer() { clearInterval(state.timerId); state.timerId = setInterval(() => { state.timeLeft--; document.getElementById('timer-val').innerText = `00:${state.timeLeft < 10 ? '0' : ''}${state.timeLeft}`; if (state.timeLeft <= 0) { clearInterval(state.timerId); state.sprint = false; document.getElementById('sprint-timer-box').classList.add('hidden'); } }, 1000); }

        window.addEventListener('keydown', (e) => { const k = e.key.toLowerCase(); if(document.getElementById('result-modal').style.display === 'flex' && (k === 'enter' || k === ' ')) { document.getElementById('result-modal').style.display = 'none'; startGame(); return; } if(k === ' ' || k === 'c') startGame(); if(k === 'r') repeatTargetSound(); if(k === 'b') playCurrentCadence(); if(k === 's') toggleSprint(); if(k === 't') toggleTheme(); if(k === 'h') openModal(); if(k === 'backspace') deleteLastNote(); if(k >= '1' && k <= '6') setLevel(['basic1','basic2','inter','adv1','adv2','total'][parseInt(k)-1]); });
        window.addEventListener('touchstart', () => { if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }, {passive: true});
        
        let touchStart = 0;
        let ptrdist = 0;
        const ptrElement = document.getElementById('ptr-indicator');
        const scrollContainer = document.getElementById('inner-scroll-content'); 

        scrollContainer.addEventListener('touchstart', e => {
            if (scrollContainer.scrollTop === 0) {
                touchStart = e.touches[0].clientY;
            }
        }, {passive: true});

        scrollContainer.addEventListener('touchmove', e => {
            const y = e.touches[0].clientY;
            if (scrollContainer.scrollTop === 0 && y > touchStart) {
                ptrdist = y - touchStart;
                if (ptrdist > 80) ptrdist = 80;
                ptrElement.style.transform = `translateY(${ptrdist - 60}px)`; 
                ptrElement.style.opacity = Math.min(1, ptrdist / 60);
            }
        }, {passive: true});

        scrollContainer.addEventListener('touchend', () => {
            if (ptrdist > 60) {
                location.reload(); 
            } else {
                ptrElement.style.transform = 'translateY(-100%)';
                ptrElement.style.opacity = '0';
            }
            touchStart = 0;
            ptrdist = 0;
        });

        renderUI();
    </script>
</body>
</html>
