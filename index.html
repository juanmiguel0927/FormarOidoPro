<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Formar O√≠do Pro </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 950: '#020617' }
                    },
                    screens: { 'xs': '380px' },
                    animation: {
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'bounce-short': 'bounceShort 0.5s ease-in-out',
                        'confetti': 'confettiDrop 2s ease-in-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.8) translateY(20px)' },
                            '100%': { opacity: '1', transform: 'scale(1) translateY(0)' }
                        },
                        bounceShort: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.2)' }
                        },
                        confettiDrop: {
                            '0%': { transform: 'translateY(-100vh) rotate(0deg)', opacity: '1' },
                            '100%': { transform: 'translateY(100vh) rotate(720deg)', opacity: '0' }
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&family=Fira+Code:wght@500;700&display=swap');
        
        :root {
            --bg-main: #fdfbf7; --bg-piano: #f3f4f6; --text-main: #1e293b; --border-ui: #e2e8f0; --card-bg: #ffffff;
            --accent: #8b5cf6; --accent-hover: #7c3aed;
            --c-tonic: #8b5cf6; --c-stable: #10b981; --c-unstable: #f59e0b; --c-tension: #ef4444; 
            --active-glow: 0 0 15px rgba(139, 92, 246, 0.6);
        }

        body.dark-mode {
            --bg-main: #0f172a; --bg-piano: #1e293b; --text-main: #f8fafc; --border-ui: #334155; --card-bg: #1e293b;
            --accent: #a78bfa; --accent-hover: #c4b5fd; --active-glow: 0 0 18px rgba(167, 139, 250, 0.5);
        }

        body { font-family: 'Nunito', sans-serif; background: var(--bg-main); color: var(--text-main); height: 100vh; margin: 0; display: flex; flex-direction: column; transition: background 0.4s ease, color 0.4s ease; overflow: hidden; -webkit-user-select: none; user-select: none; }

        /* PULL TO REFRESH INDICATOR */
        #ptr-indicator { pointer-events: none; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s; transform: translateY(-100%); opacity: 0; z-index: 200; position: absolute; top: 10px; left: 0; width: 100%; display: flex; justify-content: center; }
        .ptr-spinner { width: 30px; height: 30px; border-radius: 50%; background: var(--card-bg); box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; border: 2px solid var(--accent); color: var(--accent); }

        /* PIANO & UI ELEMENTS */
        .piano-viewport { width: 100%; overflow-x: auto; padding: 10px 10px 20px 10px; background: var(--bg-piano); border-top: 2px solid var(--border-ui); display: flex; justify-content: flex-start; scrollbar-width: none; box-shadow: inset 0 4px 6px rgba(0,0,0,0.05); transition: background 0.4s ease, border-color 0.4s ease; -webkit-overflow-scrolling: touch; }
        @media (min-width: 640px) { .piano-viewport { justify-content: center; } }
        .piano-stage { position: relative; height: 120px; min-width: 600px; width: 100%; max-width: 920px; margin: 0 auto; flex-shrink: 0; }
        
        .key-white { position: absolute; top: 0; width: calc(100% / 15); height: 100%; background: linear-gradient(to bottom, #ffffff 0%, #f1f5f9 100%); border: 1px solid #cbd5e1; border-bottom: 4px solid #94a3b8; border-radius: 0 0 6px 6px; z-index: 1; cursor: pointer; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 8px; -webkit-tap-highlight-color: transparent; transition: transform 0.1s; }
        .key-white:active { transform: scale(0.98); border-bottom-width: 2px; }
        .key-black { position: absolute; top: 0; width: calc(100% / 26); height: 60%; background: linear-gradient(to bottom, #1e293b 0%, #0f172a 100%); border: 1px solid #000; border-bottom: 6px solid #000; border-radius: 0 0 4px 4px; z-index: 2; cursor: pointer; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 4px; color: white; -webkit-tap-highlight-color: transparent; transition: transform 0.1s; }
        .key-black:active { transform: scale(0.98); border-bottom-width: 3px; }

        .grid-3-cols { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; width: 100%; }
        .grid-4-cols { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; width: 100%; }
        .grid-2-cols { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; width: 100%; }
        .control-group { background: var(--card-bg); padding: 4px; border-radius: 14px; border: 1px solid var(--border-ui); box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: background 0.4s ease, border-color 0.4s ease; }
        .control-btn { padding: 8px 2px; border-radius: 10px; font-size: 9px; font-weight: 800; color: #64748b; cursor: pointer; border: 1px solid transparent; background: transparent; transition: all 0.2s; text-align: center; white-space: nowrap; text-transform: uppercase; letter-spacing: 0.05em; overflow: hidden; text-overflow: ellipsis; }
        .active-choice { background: var(--accent) !important; color: white !important; box-shadow: var(--active-glow) !important; border-color: rgba(255,255,255,0.2) !important; transform: scale(1.02); font-weight: 900 !important; }

        /* Action Line Adjusted */
        .action-line-container { display: flex; gap: 8px; width: 100%; align-items: center; justify-content: space-between; }
        .compact-badge { background: var(--card-bg); border: 1px solid var(--border-ui); border-radius: 12px; padding: 0 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 42px; min-width: 60px; }
        
        .btn-sprint { background: rgba(244, 63, 94, 0.1); color: #e11d48; border: 1px solid rgba(244, 63, 94, 0.3); padding: 0 12px; border-radius: 12px; height: 42px; font-weight: 800; font-size: 10px; text-transform: uppercase; transition: all 0.2s; }
        .btn-sprint.active-sprint { background: #e11d48; color: white; box-shadow: 0 0 15px rgba(225, 29, 72, 0.5); }
        .btn-routine { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); border: none; border-bottom: 3px solid #047857; }
        .btn-routine:active { transform: translateY(2px); border-bottom-width: 1px; }

        .practice-card { background: var(--card-bg); border: 2px solid var(--border-ui); border-radius: 10px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s; color: var(--text-main); }
        .practice-card:hover { transform: translateY(-3px) scale(1.05); border-color: var(--accent); color: var(--accent); }
        @media (min-width: 640px) { .practice-card { width: 36px; height: 36px; font-size: 12px; } }

        .color-tonic { color: var(--c-tonic) !important; border-color: var(--c-tonic) !important; }
        .color-stable { color: var(--c-stable) !important; border-color: var(--c-stable) !important; }
        .color-unstable { color: var(--c-unstable) !important; border-color: var(--c-unstable) !important; }
        .color-tension { color: var(--c-tension) !important; border-color: var(--c-tension) !important; }
        .bg-tonic { background: var(--c-tonic) !important; color: white !important; border: none; }
        .bg-stable { background: var(--c-stable) !important; color: white !important; border: none; }
        .bg-unstable { background: var(--c-unstable) !important; color: white !important; border: none; }
        .bg-tension { background: var(--c-tension) !important; color: white !important; border: none; }

        .degree-tag { width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 7px; }
        .note-name { font-size: 7px; font-weight: 800; font-family: 'Fira Code', monospace; margin-top: 2px; text-transform: none; }
        
        .highlight-res { background: #fbbf24 !important; z-index: 60 !important; transform: scale(1.05); border-color: #f59e0b !important; box-shadow: 0 0 15px #f59e0b !important; }
        .buffer-indicator { display: flex; gap: 6px; margin-top: 10px; justify-content: center; }
        .buffer-dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; border: 2px solid transparent; transition: all 0.2s; }
        .buffer-dot.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); border-color: white; transform: scale(1.2); }

        #harmony-grid button, #interval-grid button { border: 2px solid var(--border-ui); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; background: var(--card-bg); min-height: 60px; border-radius: 14px; padding: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #harmony-grid button:active, #interval-grid button:active { transform: scale(0.98); }
        .cipher-text { font-family: 'Fira Code', monospace; font-size: 14px; font-weight: 900; color: var(--accent); text-align: center; margin-bottom: 2px; }
        .roman-text { font-size: 14px; color: #64748b; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 2px; }
        
        #interval-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; width: 100%; padding-bottom: 10px; }
        .interval-btn-text { font-size: 10px; font-weight: 800; text-transform: uppercase; text-align: center; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 500; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); color: var(--text-main); max-width: 600px; width: 100%; max-height: 85vh; overflow-y: auto; border-radius: 24px; padding: 24px; border: 1px solid var(--border-ui); box-shadow: 0 20px 50px rgba(0,0,0,0.3); }

        /* CADENCE MODAL ADJUSTED POSITION */
        #cadence-modal { pointer-events: none; align-items: flex-start; padding-top: 20vh; } 
        .cadence-display { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .cadence-chord { display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border-ui); opacity: 0.5; transition: all 0.2s; min-width: 50px; }
        .cadence-chord.active { opacity: 1; transform: scale(1.1); background: var(--accent); color: white; border-color: transparent; box-shadow: 0 0 15px var(--accent); }
        .cad-amer { font-family: 'Fira Code', monospace; font-weight: 900; font-size: 16px; }
        .cad-rom { font-size: 10px; font-weight: 800; text-transform: uppercase; }

        .input-mini { width: 100%; height: 100%; background: transparent; text-align: center; font-weight: 900; font-size: 11px; color: var(--accent); outline: none; border: none; }
        .timer-container { display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--card-bg); border: 1px solid var(--border-ui); border-radius: 12px; height: 42px; min-width: 60px; }
        .timer-label { font-size: 7px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: -2px; }
        #practice-chips-container { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; padding: 4px; width: 100%; }
        .theme-toggle { cursor: pointer; padding: 8px; border-radius: 50%; background: var(--card-bg); border: 1px solid var(--border-ui); display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: #64748b; }
        .theme-toggle:hover { color: var(--accent); border-color: var(--accent); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .combo-counter { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); font-weight: 900; color: #f59e0b; text-shadow: 0 2px 4px rgba(0,0,0,0.1); opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 160; }
        .combo-active { opacity: 1; transform: translateX(-50%) scale(1.2); }
        .confetti-piece { position: absolute; width: 8px; height: 16px; background: #ffd700; opacity: 0; }
        
        /* INCREASED BOTTOM PADDING TO AVOID OVERLAP */
        #session-bar-container { width: 100%; height: 4px; background: rgba(0,0,0,0.05); position: absolute; top: 0; left: 0; z-index: 160; display: none; }
        #session-progress { height: 100%; background: #10b981; width: 0%; transition: width 0.3s ease; }

        /* NEW BOTTOM DOCK STYLES */
        .bottom-dock { padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .dock-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; transition: all 0.1s; cursor: pointer; height: 52px; position: relative; overflow: hidden; }
        .dock-btn:active { transform: scale(0.95); }
        .btn-main-action { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        
        /* TOAST NOTIFICATION */
        #toast-notification { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(239, 68, 68, 0.9); color: white; padding: 10px 20px; border-radius: 20px; font-weight: 800; font-size: 12px; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; pointer-events: none; transition: opacity 0.3s; text-align: center; width: max-content; }
        #toast-notification.show { opacity: 1; animation: fadeInUp 0.5s ease-out; }
    </style>
</head>
<body class="select-none relative flex flex-col h-screen overflow-hidden">

    <div id="ptr-indicator"><div class="ptr-spinner"><svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div></div>
    
    <div id="combo-display" class="combo-counter text-xl">COMBO x2</div>
    <div id="toast-msg" class="toast"></div>
    <div id="toast-notification">Dificultad ajustada por 3 fallos seguidos</div>
    
    <div id="session-bar-container"><div id="session-progress"></div></div>
    <div id="session-time-remaining" class="hidden absolute top-1 left-1/2 transform -translate-x-1/2 z-[160] bg-slate-800/80 text-white text-[10px] font-bold px-3 py-1 rounded-b-lg backdrop-blur-sm shadow-md flex items-center gap-2">
        <span id="session-timer-text">00:00</span><span class="text-[8px] opacity-70 uppercase" id="session-phase-text">CALENTAMIENTO</span>
        <button onclick="requestEndSession()" class="ml-2 text-rose-400 hover:text-rose-500 font-bold text-xs">‚úï</button>
    </div>

    <!-- CADENCE VISUALIZER MODAL -->
    <div id="cadence-modal" class="modal" style="display: none; background: rgba(0,0,0,0.6);">
        <div class="modal-content text-center p-6 max-w-sm border-2 border-violet-500 bg-white dark:bg-slate-900">
            <h3 id="cadence-title" class="text-xs font-black text-violet-500 uppercase tracking-widest mb-4">Progresi√≥n Base</h3>
            <div id="cadence-container" class="cadence-display">
                <!-- Chords inserted via JS -->
            </div>
        </div>
    </div>

    <!-- START MODAL -->
    <div id="start-modal" class="modal" style="display: flex;">
        <div class="modal-content text-center p-8 max-w-sm" id="start-modal-content">
            <button onclick="closeStartModalOnly()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            <div id="start-main-view">
                <div class="mb-6 flex justify-center"><div class="bg-violet-600 p-4 rounded-2xl shadow-xl"><svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg></div></div>
                <h2 class="text-3xl font-black text-slate-800 dark:text-white mb-2">Formar O√≠do <span class="text-violet-500">Pro</span></h2>
                <p class="text-slate-500 dark:text-slate-400 mb-8 font-semibold text-sm">Elige tu modo de entrenamiento.</p>
                <div class="space-y-3">
                    <button id="btn-continue-session" onclick="continueDailySession()" class="hidden w-full bg-orange-500 hover:bg-orange-600 text-white font-black uppercase py-4 rounded-xl text-sm tracking-widest shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Continuar Sesi√≥n</button>
                    <button onclick="showDailyOptions()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-black uppercase py-4 rounded-xl text-sm tracking-widest shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2 group"><svg class="w-5 h-5 group-hover:animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Rutina Diaria</button>
                    <button onclick="startLevelingTest()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-black uppercase py-4 rounded-xl text-sm tracking-widest shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Test de Nivelaci√≥n</button>
                    <button onclick="selectGameMode('free')" class="w-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-black uppercase py-4 rounded-xl text-sm tracking-widest shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition-all">Entrenamiento Libre</button>
                </div>
            </div>
            <div id="start-daily-view" class="hidden">
                <button onclick="backToMainStart()" class="absolute top-6 left-6 text-slate-400 hover:text-slate-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg></button>
                <h2 class="text-2xl font-black text-slate-800 dark:text-white mb-2 mt-2">Configura tu Sesi√≥n</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-6 font-semibold text-xs">La constancia es la clave del √©xito.</p>
                <p class="text-slate-400 dark:text-slate-500 mb-4 font-bold text-[10px] uppercase tracking-wide">Racha Diaria: <span id="streak-modal-val" class="text-orange-500 text-lg">0</span> D√≠as</p>
                <div class="space-y-4">
                    <button onclick="selectGameMode('daily', 'minimal')" class="w-full bg-emerald-100 dark:bg-emerald-900/30 border-2 border-emerald-500 hover:bg-emerald-200 dark:hover:bg-emerald-900/50 p-4 rounded-xl text-left transition-all group"><div class="flex justify-between items-center mb-1"><span class="font-black text-emerald-700 dark:text-emerald-400 uppercase text-sm">Sesi√≥n M√≠nima</span><span class="bg-emerald-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">5 min</span></div><p class="text-xs text-emerald-600/80 dark:text-emerald-400/70 font-semibold leading-tight">Activaci√≥n r√°pida. Ideal para d√≠as ocupados. Mant√©n la racha.</p></button>
                    <button onclick="selectGameMode('daily', 'optimal')" class="w-full bg-violet-100 dark:bg-violet-900/30 border-2 border-violet-500 hover:bg-violet-200 dark:hover:bg-violet-900/50 p-4 rounded-xl text-left transition-all"><div class="flex justify-between items-center mb-1"><span class="font-black text-violet-700 dark:text-violet-400 uppercase text-sm">Sesi√≥n √ìptima</span><span class="bg-violet-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">20 min</span></div><p class="text-xs text-violet-600/80 dark:text-violet-400/70 font-semibold leading-tight">Entrenamiento profundo. Calentamiento, melod√≠a, armon√≠a y desaf√≠o.</p></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CONFIRM EXIT MODAL -->
    <div id="confirm-exit-modal" class="modal" style="display: none; z-index: 600;">
        <div class="modal-content text-center p-8 max-w-xs border-2 border-rose-500">
            <h2 class="text-xl font-black text-rose-500 mb-4">¬øAbandonar Sesi√≥n?</h2>
            <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm">Si sales ahora, la sesi√≥n actual se guardar√° como incompleta o se perder√° si es pr√°ctica libre.</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmExit()" class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 py-3 rounded-lg font-bold text-xs uppercase">Cancelar</button>
                <button onclick="confirmExitSession()" class="flex-1 bg-rose-500 text-white py-3 rounded-lg font-bold text-xs uppercase shadow-lg">Salir</button>
            </div>
        </div>
    </div>

    <header class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 p-2 sm:p-3 flex justify-between items-center shadow-sm z-[150] shrink-0 transition-colors duration-300">
        <div class="flex items-center gap-2 sm:gap-3">
            <div class="bg-violet-600 p-1.5 rounded-xl shadow-md"><svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg></div>
            <h1 class="font-black text-xs sm:text-sm tracking-tight uppercase italic text-slate-800 dark:text-white leading-tight">Formar <br class="block sm:hidden">O√≠do <span class="text-violet-500">Pro</span></h1>
        </div>
        <div class="flex items-center gap-2 sm:gap-3">
            <button onclick="showStartModal()" class="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-full border border-emerald-200 dark:border-emerald-800 hover:border-emerald-400 transition-colors" title="Rutina Diaria"><svg class="w-4 h-4 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg></button>
            <button onclick="openStats()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full border border-slate-200 dark:border-slate-700 hover:border-violet-400 transition-colors" title="Estad√≠sticas"><svg class="w-4 h-4 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></button>
            <button onclick="openModal()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full border border-slate-200 dark:border-slate-700 hover:border-violet-400 transition-colors" title="Ayuda (H)"><svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></button>
            <button onclick="toggleTheme()" class="theme-toggle" title="Tema (T)"><svg id="sun-icon" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 2.293a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 010-1.414zm4.707 4.707a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.414A1 1 0 016.464 5l.707.707a1 1 0 01-1.414 1.414l-.707-.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z"/></svg><svg id="moon-icon" class="w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg></button>
            <div class="bg-white dark:bg-slate-800 px-2 sm:px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 font-mono text-violet-600 dark:text-violet-400 font-bold text-xs shadow-sm flex flex-col items-center leading-none">
                <span id="score-val" class="text-sm">0</span>
                <span class="text-[7px] text-slate-400 font-bold">XP</span>
            </div>
        </div>
    </header>

    <!-- MAIN SCROLLABLE CONTENT - INCREASED PADDING -->
    <main id="main-scroll-container" class="flex-1 relative overflow-y-auto no-scrollbar bg-gradient-to-b from-transparent to-slate-100/50 dark:to-black/20 pb-[160px]">
        <div class="p-2 sm:p-5 flex flex-col gap-3 sm:gap-4 max-w-4xl mx-auto w-full">
            
            <!-- CONFIG PANEL -->
            <div class="flex flex-col gap-1.5">
                <div class="flex justify-between items-center px-1">
                    <span class="text-[9px] uppercase font-black text-slate-400 tracking-widest">Niveles de Pr√°ctica</span>
                    <div id="note-counter-container" class="flex items-center gap-2 bg-white dark:bg-slate-800 px-2 py-1 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm">
                        <span class="text-[8px] font-bold text-slate-500">NOTAS:</span>
                        <input type="number" id="note-count-input" min="1" max="10" value="1" class="w-8 bg-transparent text-center font-bold text-xs text-violet-600 outline-none" onchange="manualNoteUpdate(this.value)">
                    </div>
                </div>
                <div class="flex flex-col gap-1.5">
                    <div class="control-group grid-3-cols" id="level-row-1">
                        <button onclick="setLevel('basic1')" id="lvl-basic1" class="control-btn active-choice">B√ÅSICO 1-4</button>
                        <button onclick="setLevel('basic2')" id="lvl-basic2" class="control-btn">B√ÅSICO 5-8</button>
                        <button onclick="setLevel('inter')" id="lvl-inter" class="control-btn">INTERMEDIO</button>
                    </div>
                    <div class="control-group grid-3-cols" id="level-row-2">
                        <button onclick="setLevel('adv1')" id="lvl-adv1" class="control-btn">AVANZADO I</button>
                        <button onclick="setLevel('adv2')" id="lvl-adv2" class="control-btn">AVANZADO II</button>
                        <button onclick="setLevel('total')" id="lvl-total" class="control-btn">TOTAL</button>
                    </div>
                </div>
            </div>

            <!-- NEW INTERVAL SETTINGS -->
            <div id="interval-settings" class="flex-col gap-1.5 hidden">
                <div class="flex justify-between items-center px-1">
                    <span class="text-[9px] uppercase font-black text-slate-400 tracking-widest">Direcci√≥n de Intervalos</span>
                </div>
                <div class="control-group grid-4-cols">
                    <button onclick="setIntervalDirection('asc')" id="int-dir-asc" class="control-btn">ASC ‚Üó</button>
                    <button onclick="setIntervalDirection('desc')" id="int-dir-desc" class="control-btn">DESC ‚Üò</button>
                    <button onclick="setIntervalDirection('harmonic')" id="int-dir-harmonic" class="control-btn">ARM ‚ô™</button>
                    <button onclick="setIntervalDirection('mixed')" id="int-dir-mixed" class="control-btn active-choice">MIX ?</button>
                </div>
            </div>

            <div class="flex flex-col gap-1.5">
                <div class="flex justify-between items-center px-1">
                    <span class="text-[9px] uppercase font-black text-slate-400 tracking-widest">Configuraci√≥n Tonal</span>
                    <button onclick="toggleAutoResolve()" id="auto-resolve-btn" class="text-[7px] font-bold uppercase bg-emerald-500/10 text-emerald-600 px-2 py-0.5 rounded border border-emerald-500/20 transition-all hover:bg-emerald-500/20">Auto-Res: ON</button>
                </div>
                <div class="control-group grid-3-cols">
                    <button onclick="setTonalityMode('major')" id="ton-major" class="control-btn active-choice">MAYOR</button>
                    <button onclick="setTonalityMode('minor')" id="ton-minor" class="control-btn">MENOR</button>
                    <button onclick="setTonalityMode('combined')" id="ton-combined" class="control-btn">COMBINADO</button>
                </div>
                <div class="control-group grid-3-cols">
                    <button onclick="setGlobalMode('melody')" id="mode-mel-btn" class="control-btn active-choice text-xs py-1.5">MELOD√çA</button>
                    <button onclick="setGlobalMode('intervals')" id="mode-int-btn" class="control-btn text-xs py-1.5">INTERVALOS</button>
                    <button onclick="setGlobalMode('harmony')" id="mode-har-btn" class="control-btn text-xs py-1.5">ARMON√çA</button>
                </div>
            </div>

            <!-- ACTION LINE REFACTORED -->
            <div class="action-line-container">
                <div id="key-badge" class="compact-badge">
                    <span id="key-root" class="text-xs font-black text-violet-400 leading-none">C</span>
                    <span id="key-quality-label" class="text-[7px] font-bold opacity-60 uppercase tracking-wide leading-none">MAYOR</span>
                </div>
                <button onclick="toggleSprint()" id="sprint-btn" class="btn-sprint flex items-center justify-center flex-1 max-w-[100px]">SPRINT</button>
                <div class="timer-container">
                    <span class="timer-label">TIEMPO</span>
                    <input type="number" id="sprint-time-input" value="60" class="input-mini">
                </div>
            </div>
            
            <div class="flex justify-center">
                <button id="btn-delete" onclick="deleteLastNote()" class="hidden bg-slate-100 dark:bg-slate-800 text-slate-400 font-bold px-4 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 hover:text-rose-500 active:scale-95 text-[9px] uppercase shadow-sm w-fit">Borrar √öltima</button>
            </div>
            
            <div id="buffer-dots" class="buffer-indicator"></div>
            
             <!-- PRACTICE CHIPS AREA IN SCROLLABLE ZONE -->
            <div id="practice-module" class="flex flex-col items-center py-2 sm:py-3 w-full mb-12">
                <div id="practice-chips-container" class="no-scrollbar"></div>
            </div>
            <!-- HARMONY GRID -->
             <div id="harmony-grid" class="hidden w-full px-1 grid grid-cols-2 gap-2 pb-4"></div>
             <!-- NEW INTERVAL GRID -->
             <div id="interval-grid" class="hidden w-full px-1 grid grid-cols-3 gap-2 pb-4"></div>

        </div>
    </main>
    
    <!-- VISUAL FEEDBACK POSITION ADJUSTED HIGH -->
    <div id="feedback-ui" class="hidden absolute top-[25%] left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 text-center pointer-events-none w-full px-4">
        <h2 id="feedback-text" class="feedback-text transition-all drop-shadow-lg"></h2>
    </div>

    <!-- FIXED BOTTOM DOCK -->
    <div class="fixed bottom-0 left-0 w-full z-[200] bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 bottom-dock">
        <!-- Piano Stage -->
        <div class="piano-viewport no-scrollbar">
            <div id="piano-stage" class="piano-stage"></div>
        </div>
        
        <!-- Controls -->
        <div class="flex items-center justify-between px-3 py-2 gap-2 bg-slate-50 dark:bg-slate-950/50">
            <div class="flex gap-2">
                <button id="btn-repeat-base" onclick="playCurrentCadence()" class="dock-btn w-14 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400">
                    <svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                    <span class="text-[8px] font-black tracking-widest">BASE</span>
                </button>
                <button onclick="toggleImagina()" id="btn-imagina" class="dock-btn w-14 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400">
                    <div id="imagina-icon-container" class="relative">
                        <svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                        <div id="imagina-dot-active" class="absolute -top-1 -right-1 w-2 h-2 rounded-full bg-violet-500 hidden"></div>
                    </div>
                    <span class="text-[8px] font-black tracking-widest">IMAGINA</span>
                </button>
                <button id="btn-repeat-target" onclick="repeatTargetSound()" class="dock-btn w-14 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400">
                    <svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>
                    <span class="text-[8px] font-black tracking-widest">SONIDO</span>
                </button>
            </div>
            
            <button id="btn-init" onclick="startGame()" class="dock-btn btn-main-action flex-1 ml-2">
                <span class="text-sm font-black tracking-tighter leading-none">NUEVA<br>PREGUNTA</span>
            </button>
        </div>
    </div>

    <!-- RESULT MODAL -->
    <div id="result-modal" class="modal" style="display: none;">
        <div class="modal-content animate-pop-in border-4 w-[90%] max-w-sm flex flex-col items-center justify-center text-center relative overflow-hidden" id="result-card">
            <div id="confetti-container" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
            <div id="result-icon" class="text-6xl mb-4 z-10"></div>
            <h2 id="result-title" class="text-3xl font-black uppercase italic mb-2 z-10"></h2>
            <div class="w-full h-px bg-slate-200 dark:bg-slate-700 my-4 z-10"></div>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 z-10">Tu respuesta</p>
            <div id="result-user" class="font-mono text-lg font-bold mb-4 opacity-75 z-10"></div>
            <div id="correct-block" class="hidden w-full z-10">
                <p class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest mb-1">Correcto</p>
                <div id="result-correct" class="font-mono text-xl font-black text-emerald-600 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900/30 p-2 rounded-lg border border-emerald-500/30 break-words"></div>
            </div>
            
            <!-- FEEDBACK TIP -->
            <div id="feedback-tip" class="w-full mt-3 mb-2 p-2 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 text-[10px] font-semibold italic border border-blue-200 hidden z-10"></div>

            <!-- NEW FEEDBACK BUTTONS FOR LEARNING -->
            <div id="feedback-controls" class="hidden flex gap-2 w-full mt-2 z-10">
                <button onclick="playUserError()" class="flex-1 bg-rose-100 text-rose-600 border border-rose-200 hover:bg-rose-200 py-2 rounded-lg font-bold text-[10px] uppercase flex flex-col items-center justify-center">
                    <span class="text-lg">üî¥</span> Escuchar<br>Tu Error
                </button>
                <button onclick="playCorrectAnswer()" class="flex-1 bg-emerald-100 text-emerald-600 border border-emerald-200 hover:bg-emerald-200 py-2 rounded-lg font-bold text-[10px] uppercase flex flex-col items-center justify-center">
                    <span class="text-lg">üü¢</span> Escuchar<br>Correcta
                </button>
            </div>

            <button onclick="handleContinue()" id="btn-continue-result" class="mt-6 w-full py-3 rounded-xl font-black uppercase tracking-widest text-xs transition-colors shadow-lg text-white z-10">Continuar</button>
        </div>
    </div>

    <!-- SESSION SUMMARY MODAL -->
    <div id="session-summary-modal" class="modal" style="display: none;">
        <div class="modal-content animate-pop-in text-center p-8 border-2 border-emerald-500 max-w-sm">
            <h2 class="text-3xl font-black text-emerald-500 mb-2">¬°SESI√ìN COMPLETADA!</h2>
            <p class="text-slate-500 mb-6 font-bold">Has dado un paso m√°s hacia la maestr√≠a.</p>
            <div class="text-6xl mb-6">üèÜ</div>
            <div class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl mb-6">
                <p class="text-xs uppercase text-slate-400 font-bold tracking-widest mb-2">Resumen de Sesi√≥n</p>
                <p id="session-final-score" class="text-4xl font-black text-slate-700 dark:text-white mb-4">10/13</p>
                <!-- UPDATED SUMMARY GRID to 3 Columns -->
                <div class="grid grid-cols-3 gap-2 text-left w-full mb-6">
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg border border-blue-100 dark:border-blue-800">
                        <h4 class="font-bold text-blue-600 dark:text-blue-400 text-[9px] uppercase mb-2 border-b border-blue-200 pb-1">Melod√≠a</h4>
                        <div class="flex justify-between items-center text-[10px]"><span class="text-emerald-500 font-bold">‚úì <span id="summary-mel-correct">0</span></span><span class="text-rose-500 font-bold">‚úó <span id="summary-mel-wrong">0</span></span></div>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900/20 p-2 rounded-lg border border-purple-100 dark:border-purple-800">
                        <h4 class="font-bold text-purple-600 dark:text-purple-400 text-[9px] uppercase mb-2 border-b border-purple-200 pb-1">Armon√≠a</h4>
                        <div class="flex justify-between items-center text-[10px]"><span class="text-emerald-500 font-bold">‚úì <span id="summary-har-correct">0</span></span><span class="text-rose-500 font-bold">‚úó <span id="summary-har-wrong">0</span></span></div>
                    </div>
                    <!-- Added Intervals Section -->
                    <div class="bg-orange-50 dark:bg-orange-900/20 p-2 rounded-lg border border-orange-100 dark:border-orange-800">
                        <h4 class="font-bold text-orange-600 dark:text-orange-400 text-[9px] uppercase mb-2 border-b border-orange-200 pb-1">Intervalos</h4>
                        <div class="flex justify-between items-center text-[10px]"><span class="text-emerald-500 font-bold">‚úì <span id="summary-int-correct">0</span></span><span class="text-rose-500 font-bold">‚úó <span id="summary-int-wrong">0</span></span></div>
                    </div>
                </div>
                 <!-- COACH VERDICT -->
                 <div class="bg-emerald-50 dark:bg-emerald-900/20 p-3 rounded-lg border border-emerald-100 dark:border-emerald-800 text-left">
                    <h4 class="font-bold text-emerald-600 dark:text-emerald-400 text-[10px] uppercase mb-1">Veredicto del Entrenador</h4>
                    <p id="session-verdict" class="text-[10px] text-slate-600 dark:text-slate-300 leading-snug">Excelente desempe√±o. Sigue as√≠.</p>
                </div>
            </div>
            <button onclick="closeSessionSummary()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl font-black uppercase tracking-widest text-xs shadow-lg">Finalizar</button>
        </div>
    </div>
    
    <!-- STATS MODAL -->
    <div id="stats-modal" class="modal" onclick="closeStats()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6 border-b border-slate-200 dark:border-slate-700 pb-3">
                <h2 class="text-2xl font-black text-violet-600 dark:text-violet-400 uppercase italic">Tu Progreso</h2>
                <button onclick="closeStats()" class="text-slate-400 hover:text-slate-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <div class="mb-6"><label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Nombre del Estudiante</label><input type="text" id="username-input" placeholder="Tu Nombre" oninput="updateUsername(this.value)" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 text-sm font-bold rounded-lg p-3 outline-none border border-transparent focus:border-violet-500 transition-all"></div>
            <div class="flex gap-2 mb-6"><button onclick="exportData()" class="flex-1 bg-violet-600 hover:bg-violet-700 text-white text-[10px] font-bold uppercase py-2.5 rounded-lg shadow transition-colors flex items-center justify-center gap-2">Exportar</button><button onclick="importData()" class="flex-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 text-[10px] font-bold uppercase py-2.5 rounded-lg shadow-sm border border-slate-200 dark:border-slate-600 transition-colors flex items-center justify-center gap-2">Importar</button></div>
            <div class="grid grid-cols-2 gap-4 mb-6"><div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl text-center border border-slate-200 dark:border-slate-700"><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Nivel Actual</p><p id="stat-level" class="text-2xl font-black text-violet-500 mt-1">NOVATO</p><div class="w-full bg-gray-200 rounded-full h-1.5 mt-2 dark:bg-gray-700"><div id="xp-bar" class="bg-violet-600 h-1.5 rounded-full" style="width: 0%"></div></div><p class="text-[8px] text-slate-400 mt-1"><span id="current-xp">0</span> XP</p></div><div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl text-center border border-slate-200 dark:border-slate-700"><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Racha Actual</p><p id="stat-streak" class="text-3xl font-black text-orange-500 mt-1">0 üî•</p></div></div>
            <div class="mb-6"><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Progreso Reciente</p><div class="w-full h-32 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700 p-2 flex items-end justify-between gap-1" id="chart-container"></div></div>
            
            <!-- NEW DIAGNOSTIC SECTION -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-emerald-50 dark:bg-emerald-900/20 p-3 rounded-xl border border-emerald-100 dark:border-emerald-800">
                     <h4 class="font-bold text-emerald-600 dark:text-emerald-400 text-[10px] uppercase mb-2">üí™ Tus Fortalezas</h4>
                     <ul id="stat-strengths" class="text-[9px] text-slate-600 dark:text-slate-300 space-y-1 list-disc pl-3">
                         <li>Sin datos suficientes</li>
                     </ul>
                </div>
                <div class="bg-rose-50 dark:bg-rose-900/20 p-3 rounded-xl border border-rose-100 dark:border-rose-800">
                     <h4 class="font-bold text-rose-600 dark:text-rose-400 text-[10px] uppercase mb-2">‚ö†Ô∏è A Mejorar</h4>
                     <ul id="stat-weaknesses" class="text-[9px] text-slate-600 dark:text-slate-300 space-y-1 list-disc pl-3">
                         <li>Sin datos suficientes</li>
                     </ul>
                </div>
            </div>

            <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-200 dark:border-slate-800 mb-6"><h4 class="font-bold text-slate-600 dark:text-slate-400 text-xs uppercase mb-2 flex items-center gap-2">Recomendaci√≥n General</h4><p id="stat-suggestion" class="text-sm text-slate-600 dark:text-slate-300 leading-snug">A√∫n no hay suficientes datos.</p></div>
            <h4 class="font-bold text-slate-400 text-[10px] uppercase mb-3">Historial Reciente (√öltimos 10)</h4>
            <div id="history-list" class="space-y-2 mb-6 max-h-40 overflow-y-auto pr-1"></div>
            <button onclick="resetStats()" class="w-full text-rose-400 text-[10px] uppercase font-bold hover:text-rose-600 py-2">Borrar Historial</button>
        </div>
    </div>

    <!-- HELP MODAL -->
    <div id="help-modal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-black mb-6 text-violet-600 dark:text-violet-400 uppercase italic text-center border-b border-slate-200 dark:border-slate-700 pb-3">Gu√≠a Maestra</h2>
            <div class="space-y-6 text-xs text-left max-h-[60vh] overflow-y-auto pr-2">
                <section><h3 class="font-bold text-violet-500 uppercase text-[10px] mb-3 border-l-2 border-violet-500 pl-2">Metodolog√≠a</h3><div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl space-y-3 opacity-90 leading-relaxed text-slate-700 dark:text-slate-300"><p><strong>1. Sinton√≠a:</strong> Siente la gravedad tonal con los chips de pr√°ctica.</p><p><strong>2. Un√≠sono:</strong> Canta internamente la resoluci√≥n.</p><p><strong>3. Memoria:</strong> Ret√©n la frase completa antes de escribir.</p><p><strong>4. Armon√≠a:</strong> Distingue Color (May/Men) y Funci√≥n (T√≥nica/Dom).</p></div></section>
                <section><h3 class="font-bold text-violet-500 uppercase text-[10px] mb-3 border-l-2 border-violet-500 pl-2">Mapa de Ruta (Tiempo Recomendado)</h3><div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl space-y-3 opacity-90 leading-relaxed text-slate-700 dark:text-slate-300"><ul class="list-disc pl-3 space-y-1"><li><strong>Constancia:</strong> 15 min diarios > 2h a la semana.</li><li><strong>Mes 1-3:</strong> Reconocer intervalos simples y color de acordes.</li><li><strong>Mes 3-6:</strong> Progresiones b√°sicas (I-IV-V) y melod√≠as cortas.</li><li><strong>A√±o 1+:</strong> Fluidez auditiva y armon√≠a avanzada.</li></ul></div></section>
                <button onclick="closeModal()" class="w-full bg-violet-600 hover:bg-violet-700 text-white py-3.5 rounded-xl font-black uppercase tracking-widest text-xs transition-colors shadow-lg">Entendido</button>
            </div>
        </div>
    </div>

    <script>
        const BASE_NOTES = ['C', 'D', 'E', 'F', 'G', 'A', 'B']; const BASE_VALS = { 'C':0, 'D':2, 'E':4, 'F':5, 'G':7, 'A':9, 'B':11 };
        const ROOT_INDICES = { 'C': 0, 'Db': 1, 'C#': 1, 'D': 2, 'Eb': 3, 'E': 4, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'Ab': 8, 'G#': 8, 'A': 9, 'Bb': 10, 'B': 11 };
        const DEGREES = ['1', 'b2', '2', 'b3', '3', '4', '#4', '5', 'b6', '6', 'b7', '7', '8'];
        const RESOLUTIONS = { 
            0:[0,-5,0], 1:[1,0], 2:[2,0], 3:[3,2,0], 4:[4,2,0], 
            5:[5,4,2,0], 
            6:[[6,7,4,0], [6,7,12]], 
            7:[[7,4,0], [7,12]], 
            8:[8,7,12], 9:[9,11,12], 10:[10,11,12], 11:[11,12], 12:[12,7,12] 
        };
        const MAJOR_PROGS = [
            "I - V - I", "I - IV - I", "ii - V - I", "I - vi - I", "I - ii - I", 
            "I - IV - V - I", "I - vi - ii - V", "I - V - IV - I", "I - vi - IV - V", "I - iii - IV - V", 
            "I - IV - vii¬∞ - iii - vi - ii - V - I" 
        ];
        const MINOR_PROGS = [
            "i - V - i", "ii¬∞ - V - i", "i - iv - i", "iv - V - i", "i - bVII - i", 
            "i - iv - V - i", "i - bVII - bVI - V", "i - bVI - ii¬∞ - V", "i - iv - III - V", "i - VI - III - VII" 
        ];
        
        const INTERVAL_LEVELS = {
            1: [0, 5, 7, 12],
            2: [1, 2],
            3: [3, 4],
            4: [6],
            5: [8, 9],
            6: [10, 11]
        };
        const INTERVAL_NAMES = {
            0: "Un√≠sono", 1: "2da Menor", 2: "2da Mayor", 3: "3ra Menor", 4: "3ra Mayor",
            5: "4ta Justa", 6: "Tritono", 7: "5ta Justa", 8: "6ta Menor", 9: "6ta Mayor",
            10: "7ma Menor", 11: "7ma Mayor", 12: "Octava"
        };

        const LEVELS_XP = {
            0: "NOVATO",
            100: "APRENDIZ I",
            300: "APRENDIZ II",
            600: "M√öSICO I",
            1000: "M√öSICO II",
            2000: "VIRTUOSO",
            5000: "O√çDO ABSOLUTO"
        };

        const PLACEMENT_PATH = [
            { type: 'intervals', level: 1, label: 'Intervalos B√°sicos' },
            { type: 'melody', level: 'basic1', notes: 3, label: 'Melod√≠a Simple (3 notas)' },
            { type: 'harmony', level: 'basic1', label: 'Armon√≠a B√°sica (Mayor)' },
            { type: 'intervals', level: 3, label: 'Intervalos Intermedios (3ras)' },
            { type: 'melody', level: 'basic2', notes: 4, label: 'Melod√≠a (4 notas)' },
            { type: 'harmony', level: 'combined', label: 'Armon√≠a (Menor/Comb)' },
            { type: 'intervals', level: 5, label: 'Intervalos Avanzados (6tas/7tas)' },
            { type: 'melody', level: 'inter', notes: 5, label: 'Melod√≠a Intermedia (5 notas)' },
            { type: 'harmony', level: 'adv1', label: 'Armon√≠a Avanzada' },
            { type: 'melody', level: 'adv1', notes: 7, label: 'Melod√≠a Compleja (7 notas)' }
        ];

        function getNoteName(rootName, semitonesFromRoot) {
            const semitoneToDegreeShift = { 0:0, 1:1, 2:1, 3:2, 4:2, 5:3, 6:3, 7:4, 8:5, 9:5, 10:6, 11:6 };
            let rootLetter = rootName.charAt(0); let rootAccidental = rootName.slice(1);
            let rootBaseVal = BASE_VALS[rootLetter]; let rootMod = (rootAccidental === '#') ? 1 : (rootAccidental === 'b' ? -1 : 0);
            let rootAbs = (rootBaseVal + rootMod + 12) % 12; let targetAbs = (rootAbs + semitonesFromRoot) % 12;
            let rootIdx = BASE_NOTES.indexOf(rootLetter); let degreeShift = semitoneToDegreeShift[semitonesFromRoot] !== undefined ? semitoneToDegreeShift[semitonesFromRoot] : 0;
            let targetIdx = (rootIdx + degreeShift) % 7; let targetLetter = BASE_NOTES[targetIdx];
            let targetBaseVal = BASE_VALS[targetLetter]; let diff = targetAbs - targetBaseVal;
            while (diff > 6) diff -= 12; while (diff < -6) diff += 12;
            let acc = ""; if (diff === 1) acc = "#"; else if (diff === 2) acc = "x"; else if (diff === -1) acc = "b"; else if (diff === -2) acc = "bb";
            return targetLetter + acc;
        }

        let audioCtx;
        let state = { level:'basic1', intervalLevel: 1, intervalDirection: 'mixed', tonalityMode:'major', currentRoundTonality:'major', mode:'melody', keyIndex:48, keyLabel:'C', score:0, xp: 0, streak: 0, dailyStreak: 0, lastPracticeDate: null, imagina:false, sprint:false, timeLeft:60, timerId:null, userBuffer:[], isPlaying:false, target:null, autoResolve:true, activeOscillators: [], timeouts: [], history: [], username: '', currentNoteCount: 1, lastUserAnswer: null, lastCorrectAnswer: null, cadenceType: 0, questionStartTime: 0, errorStats: {}, consecutiveMelodyFailures: 0 };
        let sessionState = { active: false, type: 'minimal', startTime: 0, totalDuration: 0, timeLeft: 0, correctCount: 0, totalQuestions: 0, timerId: null, phase: 'warmup', stats: { melCorrect: 0, melTotal: 0, harCorrect: 0, harTotal: 0, intCorrect: 0, intTotal: 0 }, elapsedTime: 0 };
        let placementState = { active: false, levelIndex: 0, strikes: 0, totalStrikesAllowed: 2, maxLevelReached: 0 };

        try {
            const saved = localStorage.getItem('formarOidoPro_history'); if(saved) state.history = JSON.parse(saved);
            const savedUser = localStorage.getItem('formarOidoPro_username'); if(savedUser) state.username = savedUser;
            const savedXP = localStorage.getItem('formarOidoPro_xp'); if(savedXP) state.xp = parseInt(savedXP);
            const savedErrors = localStorage.getItem('formarOidoPro_errors'); if(savedErrors) state.errorStats = JSON.parse(savedErrors);
            const savedStreak = localStorage.getItem('formarOidoPro_dailyStreak'); const savedDate = localStorage.getItem('formarOidoPro_lastDate');
            if(savedStreak) state.dailyStreak = parseInt(savedStreak); if(savedDate) state.lastPracticeDate = savedDate;
            checkDailyStreak(); 
            const savedSession = localStorage.getItem('formarOidoPro_session');
            if (savedSession) { 
                const parsedSession = JSON.parse(savedSession); 
                if (parsedSession.active && (parsedSession.type === 'free' || parsedSession.timeLeft > 0)) { 
                    sessionState = parsedSession; 
                    document.getElementById('btn-continue-session').classList.remove('hidden'); 
                } 
            }
        } catch(e){ console.log('Storage Error', e); }

        function saveSessionState() { localStorage.setItem('formarOidoPro_session', JSON.stringify(sessionState)); }
        function clearSessionState() { localStorage.removeItem('formarOidoPro_session'); sessionState.active = false; }
        
        function requestEndSession() { document.getElementById('confirm-exit-modal').style.display = 'flex'; }
        function closeConfirmExit() { document.getElementById('confirm-exit-modal').style.display = 'none'; }
        function confirmExitSession() {
            if (sessionState.type === 'free') {
                 const mins = Math.floor(sessionState.elapsedTime / 60);
                 const durationStr = `${mins} min ${sessionState.elapsedTime % 60} seg`;
                 saveHistory(true, `Pr√°ctica Libre (${durationStr})`, sessionState.elapsedTime * 1000);
            }
            clearSessionState();
            placementState.active = false; 
            clearInterval(sessionState.timerId);
            document.getElementById('session-time-remaining').classList.add('hidden');
            document.getElementById('session-bar-container').style.display = 'none';
            document.getElementById('confirm-exit-modal').style.display = 'none';
            showStartModal();
        }

        function checkDailyStreak() { if (!state.lastPracticeDate) return; const today = new Date().toDateString(); const last = new Date(state.lastPracticeDate).toDateString(); if (today !== last) { const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); if (yesterday.toDateString() !== last) { state.dailyStreak = 0; localStorage.setItem('formarOidoPro_dailyStreak', 0); } } }
        function updateDailyStreak() { const today = new Date().toDateString(); const last = state.lastPracticeDate ? new Date(state.lastPracticeDate).toDateString() : null; if (today !== last) { state.dailyStreak++; state.lastPracticeDate = new Date().toISOString(); localStorage.setItem('formarOidoPro_dailyStreak', state.dailyStreak); localStorage.setItem('formarOidoPro_lastDate', state.lastPracticeDate); } }
        function registerTimeout(fn, delay) { const id = setTimeout(fn, delay); state.timeouts.push(id); return id; }
        function clearAllTimeouts() { state.timeouts.forEach(id => clearTimeout(id)); state.timeouts = []; }
        function initAudio() { if(!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); const comp = audioCtx.createDynamicsCompressor(); comp.connect(audioCtx.destination); state.masterOut = comp; } }
        function midiToFreq(m) { return 440 * Math.pow(2, (m - 69) / 12); }
        function playTone(freq, dur, type='triangle', start=0, vol=0.2) { if(!audioCtx) return; const t = start + audioCtx.currentTime; const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, t); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(vol, t + 0.05); g.gain.exponentialRampToValueAtTime(0.001, t + dur); osc.connect(g); g.connect(state.masterOut); osc.start(t); osc.stop(t + dur); state.activeOscillators.push(osc); }
        function stopAllSounds() { state.activeOscillators.forEach(osc => { try { osc.stop(); } catch(e) {} }); state.activeOscillators = []; state.isPlaying = false; }
        
        function getChordIntervals(type) { if (type === 'Maj') return [0, 4, 7]; if (type === 'Min') return [0, 3, 7]; if (type === 'Dim') return [0, 3, 6]; return [0, 4, 7]; }
        function getBestVoicing(prevVoicing, currentRoot, currentType, currentBass) {
            const intervals = getChordIntervals(currentType); const targetPCs = intervals.map(i => (currentRoot + i) % 12);
            if (!prevVoicing) { let base = currentRoot; while (base < 55) base += 12; return intervals.map(i => base + i); }
            const prevNotes = prevVoicing.notes; const prevBass = prevVoicing.bass; const prevPCs = prevNotes.map(n => n % 12);
            const commonPCs = prevPCs.filter(p => targetPCs.includes(p)); const hasCommon = commonPCs.length > 0;
            let forceDirection = 0; if (!hasCommon) { if (currentBass > prevBass) forceDirection = -1; else if (currentBass < prevBass) forceDirection = 1; }
            let candidates = []; for (let r = currentRoot - 12; r <= currentRoot + 36; r += 12) { candidates.push([r, r + intervals[1], r + intervals[2]]); candidates.push([r + intervals[1], r + intervals[2], r + 12]); candidates.push([r + intervals[2], r + 12, r + intervals[1] + 12]); }
            let bestCand = candidates[0]; let minCost = Infinity;
            candidates.forEach(cand => { cand.sort((a,b) => a - b); let dist = 0; let directionScore = 0; for(let i=0; i<3; i++) { let d = cand[i] - prevNotes[i]; dist += Math.abs(d); if (forceDirection === 1 && d < 0) directionScore += 50; if (forceDirection === -1 && d > 0) directionScore += 50; } const center = cand[1]; const rangePenalty = Math.abs(center - 66) * 0.5; const totalCost = dist + directionScore + rangePenalty; if (totalCost < minCost) { minCost = totalCost; bestCand = cand; } });
            return bestCand;
        }
        function playVoicedChord(bass, voicing, dur, start) { playTone(midiToFreq(bass), dur, 'sine', start, 0.4); playTone(midiToFreq(bass), dur * 0.6, 'triangle', start, 0.2); voicing.forEach(n => { playTone(midiToFreq(n), dur, 'triangle', start, 0.1); }); }

        function getFunctionalClass(idx) { 
            const isMin = state.currentRoundTonality === 'minor';
            if (idx === 0 || idx === 12) return 'tonic'; if (idx === 7) return 'stable';
            if (isMin) { if ([3].includes(idx)) return 'stable'; } else { if ([4].includes(idx)) return 'stable'; }
            return 'unstable'; 
        }

        function setLevel(lvl) { 
            if(state.mode === 'intervals') {
                const map = {'basic1':1, 'basic2':2, 'inter':3, 'adv1':4, 'adv2':5, 'total':6};
                state.intervalLevel = map[lvl] || 1;
            } else {
                state.level = lvl; 
            }
            document.querySelectorAll('button[id^="lvl-"]').forEach(b => b.classList.remove('active-choice')); 
            document.getElementById(`lvl-${lvl}`)?.classList.add('active-choice'); 
            renderUI(); 
        }

        function setIntervalDirection(dir) {
            state.intervalDirection = dir;
            document.querySelectorAll('button[id^="int-dir-"]').forEach(b => b.classList.remove('active-choice'));
            document.getElementById(`int-dir-${dir}`)?.classList.add('active-choice');
        }

        function setTonalityMode(mode) { 
            state.tonalityMode = mode; 
            document.querySelectorAll('button[id^="ton-"]').forEach(b => b.classList.remove('active-choice')); 
            document.getElementById(`ton-${mode}`)?.classList.add('active-choice'); 
            if (mode === 'major') state.currentRoundTonality = 'major'; else if (mode === 'minor') state.currentRoundTonality = 'minor';
            document.getElementById('key-quality-label').innerText = state.currentRoundTonality === 'major' ? 'MAYOR' : 'MENOR'; renderUI(); 
        }
        function toggleAutoResolve() { state.autoResolve = !state.autoResolve; const btn = document.getElementById('auto-resolve-btn'); btn.innerText = `Auto-Res: ${state.autoResolve ? 'ON' : 'OFF'}`; btn.className = `text-[7px] font-bold uppercase px-2 py-0.5 rounded border transition-all ${state.autoResolve ? 'bg-emerald-500/10 text-emerald-600 border-emerald-500/20 hover:bg-emerald-500/20' : 'bg-rose-500/10 text-rose-600 border-rose-500/20 hover:bg-rose-500/20'}`; }
        
        function updateNoteCount(val) {
            state.currentNoteCount = parseInt(val) || 1;
        }

        function setGlobalMode(m) { 
            stopAllSounds(); 
            state.mode = m; 
            document.getElementById('mode-mel-btn')?.classList.toggle('active-choice', m === 'melody'); 
            document.getElementById('mode-har-btn')?.classList.toggle('active-choice', m === 'harmony'); 
            document.getElementById('mode-int-btn')?.classList.toggle('active-choice', m === 'intervals'); 
            const isH = m === 'harmony'; const isI = m === 'intervals';
            document.getElementById('practice-module')?.classList.toggle('hidden', isH || isI); 
            document.getElementById('piano-stage')?.classList.toggle('hidden', isH || isI); 
            document.getElementById('harmony-grid')?.classList.toggle('hidden', !isH); 
            document.getElementById('interval-grid')?.classList.toggle('hidden', !isI);
            document.getElementById('note-counter-container').classList.toggle('invisible', isH || isI);
            document.getElementById('interval-settings').classList.toggle('hidden', !isI);
            document.getElementById('interval-settings').classList.toggle('flex', isI);

            if (isI) {
                document.getElementById('lvl-basic1').innerText = "NIVEL 1";
                document.getElementById('lvl-basic2').innerText = "NIVEL 2";
                document.getElementById('lvl-inter').innerText = "NIVEL 3";
                document.getElementById('lvl-adv1').innerText = "NIVEL 4";
                document.getElementById('lvl-adv2').innerText = "NIVEL 5";
                document.getElementById('lvl-total').innerText = "NIVEL 6";
                const reverseMap = {1:'basic1', 2:'basic2', 3:'inter', 4:'adv1', 5:'adv2', 6:'total'};
                document.querySelectorAll('button[id^="lvl-"]').forEach(b => b.classList.remove('active-choice'));
                document.getElementById(`lvl-${reverseMap[state.intervalLevel]}`)?.classList.add('active-choice');
            } else {
                document.getElementById('lvl-basic1').innerText = "B√ÅSICO 1-4";
                document.getElementById('lvl-basic2').innerText = "B√ÅSICO 5-8";
                document.getElementById('lvl-inter').innerText = "INTERMEDIO";
                document.getElementById('lvl-adv1').innerText = "AVANZADO I";
                document.getElementById('lvl-adv2').innerText = "AVANZADO II";
                document.getElementById('lvl-total').innerText = "TOTAL";
                 document.querySelectorAll('button[id^="lvl-"]').forEach(b => b.classList.remove('active-choice'));
                 document.getElementById(`lvl-${state.level}`)?.classList.add('active-choice');
            }
            resetUI(); 
        }

        function manualNoteUpdate(val) {
            state.currentNoteCount = parseInt(val) || 1;
        }

        function showStartModal() { 
            if (sessionState.active && (sessionState.type === 'free' || sessionState.timeLeft > 0)) {
                 if (document.getElementById('start-modal').style.display === 'flex') {
                     document.getElementById('btn-continue-session').classList.remove('hidden');
                 } else { requestEndSession(); return; }
            } else { document.getElementById('btn-continue-session').classList.add('hidden'); }
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); else if (!audioCtx) initAudio(); 
            document.getElementById('start-modal').style.display = 'flex'; 
            backToMainStart(); 
        }
        function closeStartModalOnly() { document.getElementById('start-modal').style.display = 'none'; }
        function showDailyOptions() { document.getElementById('start-main-view').classList.add('hidden'); document.getElementById('start-daily-view').classList.remove('hidden'); }
        function backToMainStart() { document.getElementById('start-daily-view').classList.add('hidden'); document.getElementById('start-main-view').classList.remove('hidden'); }
        
        function selectGameMode(mode, subType) { 
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); else if (!audioCtx) initAudio(); 
            document.getElementById('start-modal').style.display = 'none'; 
            if (mode === 'daily') startDailySession(subType); 
            else if (mode === 'free') startFreeSession();
            else { clearSessionState(); startGame(); } 
        }

        function startLevelingTest() {
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); else if (!audioCtx) initAudio(); 
            document.getElementById('start-modal').style.display = 'none';
            placementState = { active: true, levelIndex: 0, strikes: 0, totalStrikesAllowed: 2, maxLevelReached: 0 };
            sessionState = { active: true, type: 'assessment', startTime: Date.now(), totalDuration: 0, timeLeft: 0, correctCount: 0, totalQuestions: 0, timerId: null, phase: 'Test Adaptativo', stats: { melCorrect: 0, melTotal: 0, harCorrect: 0, harTotal: 0, intCorrect: 0, intTotal: 0 } };
            document.getElementById('session-time-remaining').classList.remove('hidden');
            document.getElementById('session-phase-text').innerText = "TEST ADAPTATIVO";
            document.getElementById('session-timer-text').innerText = "Nivel 1";
            loadAssessmentQuestion();
        }

        function loadAssessmentQuestion() {
            if (placementState.levelIndex >= PLACEMENT_PATH.length) {
                finishPlacementTest("¬°Felicidades! Has completado todo el recorrido.");
                return;
            }
            const config = PLACEMENT_PATH[placementState.levelIndex];
            document.getElementById('session-timer-text').innerText = `Nivel ${placementState.levelIndex + 1}`;
            showToast(`Nivel ${placementState.levelIndex + 1}: ${config.label}`);
            state.mode = config.type;
            if (config.type === 'intervals') {
                state.intervalLevel = config.level;
                setGlobalMode('intervals');
            } else if (config.type === 'melody') {
                state.level = config.level;
                state.currentNoteCount = config.notes; 
                document.getElementById('note-count-input').value = config.notes;
                setGlobalMode('melody');
            } else if (config.type === 'harmony') {
                state.level = config.level;
                setGlobalMode('harmony');
            }
            const keys = ['C','G','F','D'];
            state.keyLabel = keys[Math.floor(Math.random()*keys.length)];
            state.keyIndex = 48 + ROOT_INDICES[state.keyLabel]; 
            document.getElementById('key-root').innerText = state.keyLabel; 
            playCadence(() => generateQuestion());
        }

        function finishPlacementTest(msgOverride) {
            placementState.active = false;
            const finalLvlIndex = placementState.maxLevelReached;
            const finalConfig = PLACEMENT_PATH[Math.min(finalLvlIndex, PLACEMENT_PATH.length - 1)];
            let resultMsg = msgOverride || "Has llegado a tu l√≠mite actual.";
            saveHistory(true, `Test de Nivel: Alcanzado Nivel ${finalLvlIndex + 1} (${finalConfig.label})`, sessionState.elapsedTime * 1000);
            alert(`Evaluaci√≥n Finalizada.\n\n${resultMsg}\n\nNivel Alcanzado: ${finalLvlIndex + 1}\nHabilidad: ${finalConfig.label}`);
            document.getElementById('session-time-remaining').classList.add('hidden');
            showStartModal();
        }

        function toggleImagina() { 
            state.imagina = !state.imagina; 
            const btn = document.getElementById('btn-imagina'); const dot = document.getElementById('imagina-dot-active');
            if (state.imagina) { btn.classList.add('border-violet-500', 'bg-violet-50', 'dark:bg-violet-900/20'); dot.classList.remove('hidden'); } else { btn.classList.remove('border-violet-500', 'bg-violet-50', 'dark:bg-violet-900/20'); dot.classList.add('hidden'); }
        }

        function continueDailySession() { if (!sessionState.active) return; document.getElementById('start-modal').style.display = 'none'; if(sessionState.type !== 'assessment') startSessionTimer(); document.getElementById('session-bar-container').style.display = 'block'; document.getElementById('session-time-remaining').classList.remove('hidden'); updateSessionProgress(); if(sessionState.type === 'assessment') loadAssessmentQuestion(); else loadSessionQuestion(); }
        
        function startFreeSession() {
            sessionState = { active: true, type: 'free', startTime: Date.now(), totalDuration: 0, timeLeft: 0, elapsedTime: 0, correctCount: 0, totalQuestions: 0, timerId: null, phase: 'Pr√°ctica Libre', stats: { melCorrect: 0, melTotal: 0, harCorrect: 0, harTotal: 0, intCorrect: 0, intTotal: 0 } };
            document.getElementById('session-time-remaining').classList.remove('hidden');
            startSessionTimer();
            startGame();
        }

        function startDailySession(type) {
            if (type !== undefined) {
                const duration = type === 'minimal' ? 300 : 1200; 
                sessionState = { active: true, type: type, startTime: Date.now(), totalDuration: duration, timeLeft: duration, elapsedTime: 0, correctCount: 0, totalQuestions: 0, timerId: null, phase: 'warmup', stats: { melCorrect: 0, melTotal: 0, harCorrect: 0, harTotal: 0, intCorrect: 0, intTotal: 0 } };
            }
            document.getElementById('session-time-remaining').classList.remove('hidden'); startSessionTimer(); document.getElementById('session-bar-container').style.display = 'block'; updateSessionProgress(); loadSessionQuestion();
        }
        
        function startSessionTimer() {
            if (sessionState.timerId) clearInterval(sessionState.timerId);
            updateSessionTimerUI();
            sessionState.timerId = setInterval(() => {
                if (sessionState.type === 'free' || sessionState.type === 'assessment') {
                    sessionState.elapsedTime++;
                } else {
                    sessionState.timeLeft--;
                    if (sessionState.timeLeft <= 0) { clearInterval(sessionState.timerId); endDailySession(); }
                }
                saveSessionState();
                updateSessionTimerUI();
            }, 1000);
        }
        
        function updateSessionTimerUI() {
            if (sessionState.type === 'free' || sessionState.type === 'assessment') {
                const mins = Math.floor(sessionState.elapsedTime / 60);
                const secs = sessionState.elapsedTime % 60;
                document.getElementById('session-timer-text').innerText = `${mins < 10 ? '0'+mins : mins}:${secs < 10 ? '0'+secs : secs}`;
                document.getElementById('session-phase-text').innerText = sessionState.type === 'assessment' ? "TEST ADAPTATIVO" : "PR√ÅCTICA LIBRE";
            } else {
                const mins = Math.floor(sessionState.timeLeft / 60);
                const secs = sessionState.timeLeft % 60;
                document.getElementById('session-timer-text').innerText = `${mins < 10 ? '0'+mins : mins}:${secs < 10 ? '0'+secs : secs}`;
                document.getElementById('session-phase-text').innerText = getSessionPhaseText();
            }
        }
        
        function getSessionPhaseText() { const elapsed = sessionState.totalDuration - sessionState.timeLeft; const progress = elapsed / sessionState.totalDuration; if (progress < 0.2) return "CALENTAMIENTO"; if (progress < 0.8) return "N√öCLEO"; return "DESAF√çO"; }
        
        function getAmericanChords(romanProgression) {
            return romanProgression.split(' - ').map(r => { 
                const map = {'I':0,'IV':5,'V':7,'vi':9,'ii':2,'iii':4,'vii':11,'vii¬∞':11,'i':0,'iv':5,'bVI':8,'bVII':10,'V/vi':4,'V/V':2,'V/IV':0,'V/ii':9,'bIII':3,'II':2,'VI':9,'III':4}; 
                const interval = map[r.trim().replace(/7|maj|m|¬∞/g,'')] || 0; 
                const note = getNoteName(state.keyLabel, interval); 
                let suffix = '';
                if (r.includes('¬∞')) suffix = '¬∞';
                else if (r.includes('m') || (r === r.toLowerCase() && !r.includes('b') && r!=='I' && r!=='V')) suffix = 'm';
                if (r.includes('7')) suffix += '7';
                return note + suffix; 
            }).join(' - ');
        }

        // IMPROVED: Pedagogical Tips based on specific errors
        function getPedagogicalTip(mode, target, user, correct) {
            if (mode === 'intervals') {
                const tName = INTERVAL_NAMES[target];
                if (tName.includes('5ta') && user.includes('4ta')) return "üí° Tip: La 5ta es muy estable (Star Wars). La 4ta pide resolver.";
                if (tName.includes('4ta') && user.includes('5ta')) return "üí° Tip: La 4ta suena a 'llamada' o himno. La 5ta es m√°s vac√≠a.";
                if (tName.includes('2da Menor')) return "üí° Tip: Tensi√≥n m√°xima. Piensa en 'Tibur√≥n'.";
                if (tName.includes('Tritono')) return "üí° Tip: El intervalo del diablo. Suena muy inestable.";
            } else if (mode === 'melody') {
                // Parse strings to compare degrees if needed, or generic advice
                return "üí° Tip: Canta la nota y busca su camino hacia la T√≥nica (Do).";
            } else if (mode === 'harmony') {
                if (correct.includes('Major') && user.includes('Minor')) return "üí° Tip: El acorde Mayor brilla. El Menor es m√°s introspectivo.";
                if (correct.includes('V') && user.includes('I')) return "üí° Tip: El V (Dominante) crea tensi√≥n. El I (T√≥nica) es reposo.";
            }
            return "üí° Tip: Intenta cantar la respuesta antes de seleccionarla.";
        }

        function getDynamicQuestion() {
            const elapsed = sessionState.totalDuration - sessionState.timeLeft; const progress = elapsed / sessionState.totalDuration; const streak = state.dailyStreak || 0; const levels = ['basic1', 'basic2', 'inter', 'adv1', 'adv2'];
            
            // Calculate weaknesses
            let weakMel = 0, weakHar = 0, weakInt = 0;
            const recent = state.history.slice(0, 30);
            if (recent.length > 5) {
                const mel = recent.filter(x=>x.mode==='melody');
                const har = recent.filter(x=>x.mode==='harmony');
                const intv = recent.filter(x=>x.mode==='intervals');
                if (mel.length > 0 && (mel.filter(x=>x.correct).length / mel.length) < 0.6) weakMel = 0.4;
                if (har.length > 0 && (har.filter(x=>x.correct).length / har.length) < 0.6) weakHar = 0.4;
                if (intv.length > 0 && (intv.filter(x=>x.correct).length / intv.length) < 0.6) weakInt = 0.4;
            }

            let performanceBoost = 0;
            if (sessionState.totalQuestions > 5) {
                const accuracy = sessionState.correctCount / sessionState.totalQuestions;
                if (accuracy > 0.8) performanceBoost = 1;
            }

            let keys = ['C', 'G']; if (streak >= 4) keys = [...keys, 'F', 'D', 'Bb']; if (streak >= 11) keys = ['C','G','D','A','E','B','F','Bb','Eb','Ab'];
            
            let baseLvlIdx = 0; 
            if (streak >= 4) baseLvlIdx = 1; 
            if (streak >= 15) baseLvlIdx = 2; 
            if (streak >= 30) baseLvlIdx = 3;
            baseLvlIdx = Math.min(baseLvlIdx + performanceBoost, levels.length - 1);

            let qLevel = levels[baseLvlIdx]; let qType = 'melody'; let qKey = 'C'; let qTonality = 'major';

            let pMel = 0.33, pHar = 0.33, pInt = 0.34;
            if (progress < 0.2) { pMel = 0.5; pHar = 0.0; pInt = 0.5; }
            pMel += weakMel; pHar += weakHar; pInt += weakInt;
            
            const totalP = pMel + pHar + pInt;
            const rnd = Math.random() * totalP;

            if (rnd < pMel) { 
                qType = 'melody'; 
                if(weakMel > 0) showToast("Intensificando Melod√≠a...");
            } else if (rnd < pMel + pHar) { 
                qType = 'harmony'; 
                if (progress > 0.8) { const boost = Math.min(baseLvlIdx + 1, levels.length - 1); qLevel = levels[boost]; }
                if(weakHar > 0) showToast("Intensificando Armon√≠a...");
            } else { 
                qType = 'intervals'; 
                if (progress < 0.2) state.intervalLevel = Math.random() > 0.5 ? 1 : 2;
                else if (progress < 0.8) state.intervalLevel = Math.floor(Math.random() * 2) + 3;
                else state.intervalLevel = Math.floor(Math.random() * 2) + 5;
                if(weakInt > 0) showToast("Intensificando Intervalos...");
            }

            qKey = keys[Math.floor(Math.random() * Math.min(progress < 0.2 ? 2 : keys.length, keys.length))]; 
            qTonality = (qType === 'harmony' || progress > 0.3) ? 'combined' : 'major';

            return { type: qType, level: qLevel, key: qKey, tonality: qTonality };
        }

        function loadSessionQuestion() { 
            if (sessionState.type === 'free') { startGame(); return; } 
            if (sessionState.timeLeft <= 0) return; 
            const q = getDynamicQuestion(); state.level = q.level; state.keyLabel = q.key; state.keyIndex = 48 + ROOT_INDICES[q.key]; state.currentRoundTonality = q.tonality === 'combined' ? (Math.random() > 0.5 ? 'major' : 'minor') : q.tonality; setGlobalMode(q.type); document.getElementById('key-root').innerText = state.keyLabel; document.getElementById('key-quality-label').innerText = state.currentRoundTonality === 'major' ? 'MAYOR' : 'MENOR'; playCadence(() => generateQuestion()); 
        }
        function updateSessionProgress() { if (sessionState.type === 'free' || sessionState.type === 'assessment') return; const elapsed = sessionState.totalDuration - sessionState.timeLeft; const pct = (elapsed / sessionState.totalDuration) * 100; document.getElementById('session-progress').style.width = `${pct}%`; }
        function endDailySession() {
            clearSessionState(); clearInterval(sessionState.timerId); document.getElementById('session-time-remaining').classList.add('hidden'); document.getElementById('session-bar-container').style.display = 'none'; 
            document.getElementById('session-summary-modal').style.display = 'flex'; 
            document.getElementById('session-final-score').innerText = `${sessionState.correctCount}/${sessionState.totalQuestions}`; 
            document.getElementById('summary-mel-correct').innerText = sessionState.stats.melCorrect; 
            document.getElementById('summary-mel-wrong').innerText = sessionState.stats.melTotal - sessionState.stats.melCorrect; 
            document.getElementById('summary-har-correct').innerText = sessionState.stats.harCorrect; 
            document.getElementById('summary-har-wrong').innerText = sessionState.stats.harTotal - sessionState.stats.harCorrect; 
            document.getElementById('summary-int-correct').innerText = sessionState.stats.intCorrect; 
            document.getElementById('summary-int-wrong').innerText = sessionState.stats.intTotal - sessionState.stats.intCorrect; 
            
            // Coach Verdict
            const acc = sessionState.totalQuestions > 0 ? sessionState.correctCount/sessionState.totalQuestions : 0;
            let verdict = "Buen esfuerzo.";
            if(acc > 0.9) verdict = "¬°Impecable! Est√°s listo para subir el nivel.";
            else if(acc > 0.7) verdict = "Muy bien. Sigue reforzando la velocidad.";
            else if(acc > 0.5) verdict = "Vas bien. T√≥mate m√°s tiempo para escuchar la cadencia.";
            else verdict = "No te rindas. Intenta practicar intervalos b√°sicos primero.";
            
            if(sessionState.stats.melCorrect < sessionState.stats.melTotal * 0.5) verdict += " Enf√≥cate en Melod√≠a ma√±ana.";
            else if(sessionState.stats.harCorrect < sessionState.stats.harTotal * 0.5) verdict += " Repasa las progresiones arm√≥nicas.";
            
            document.getElementById('session-verdict').innerText = verdict;

            updateDailyStreak(); saveHistory(true, `Rutina Completada (${sessionState.type})`, sessionState.totalDuration * 1000); 
        }
        function closeSessionSummary() { document.getElementById('session-summary-modal').style.display = 'none'; startGame(); }
        
        function startGame() { 
            stopAllSounds(); clearAllTimeouts(); initAudio(); state.target = null; resetUI(); 
            state.cadenceType = Math.random() > 0.5 ? 0 : 1;

            if (!sessionState.active || sessionState.type === 'free') { 
                const keys = ['C','G','D','A','E','B','F','Bb','Eb','Ab']; 
                state.keyLabel = keys[Math.floor(Math.random()*keys.length)]; 
                state.keyIndex = 48 + ROOT_INDICES[state.keyLabel]; 
                state.currentRoundTonality = state.tonalityMode === 'combined' ? (Math.random() > 0.5 ? 'major' : 'minor') : state.tonalityMode; 
                document.getElementById('key-root').innerText = state.keyLabel; 
                document.getElementById('key-quality-label').innerText = state.currentRoundTonality === 'major' ? 'MAYOR' : 'MENOR'; 
                document.getElementById('key-badge').classList.remove('hidden'); 
                renderUI(); 
                if (state.sprint) generateQuestion(); else playCadence(() => generateQuestion()); 
            } else { 
                loadSessionQuestion(); 
            } 
        }

        function playCadence(cb) { 
            state.isPlaying = true; 
            const cadenceVariant = state.cadenceType; 
            const isMinor = state.currentRoundTonality === 'minor';

            let degrees = [];
            let roms = [];
            if(cadenceVariant === 0) { 
                degrees = [0, 5, 7, 0]; 
                if(isMinor) roms = ["i", "iv", "V", "i"]; else roms = ["I", "IV", "V", "I"]; 
            } 
            else { 
                degrees = [2, 7, 0]; 
                if(isMinor) roms = ["ii¬∞", "V", "i"]; else roms = ["ii", "V", "I"]; 
            }

            // ADDED: TITLE UPDATE FOR KEY
            document.getElementById('cadence-title').innerText = `Progresi√≥n Base (${state.keyLabel} ${isMinor ? 'Menor' : 'Mayor'})`;

            const modal = document.getElementById('cadence-modal');
            const container = document.getElementById('cadence-container');
            modal.style.display = 'flex';
            container.innerHTML = '';

            degrees.forEach((deg, i) => {
                const noteName = getNoteName(state.keyLabel, deg);
                let suffix = '';
                if(isMinor) {
                    if (deg === 0 || deg === 5) suffix = 'm';
                    else if (deg === 2) suffix = '¬∞';
                } else {
                    if (deg === 2) suffix = 'm';
                }
                const chordSymbol = noteName + suffix;
                const div = document.createElement('div');
                div.className = 'cadence-chord';
                div.id = `cad-chord-${i}`;
                div.innerHTML = `<div class="cad-amer">${chordSymbol}</div><div class="cad-rom">${roms[i]}</div>`;
                container.appendChild(div);
            });

            let t = 0; 
            let prevVoicing = null; 
            degrees.forEach((deg, idx) => { 
                const root = state.keyIndex + deg; 
                let bass = root; 
                while (bass >= 48) bass -= 12; 
                if (bass < 36) bass += 12; 
                let finalType = 'Maj';
                if (isMinor) { if (deg === 0 || deg === 5) finalType = 'Min'; if (deg === 2) finalType = 'Dim'; } 
                else { if (deg === 2) finalType = 'Min'; }
                if (deg === 7) finalType = 'Maj'; 

                const voicing = getBestVoicing(prevVoicing, root, finalType, bass); 
                playVoicedChord(bass, voicing, 1.0, t); 
                prevVoicing = { notes: voicing, bass: bass }; 
                
                registerTimeout(() => {
                    document.querySelectorAll('.cadence-chord').forEach(c => c.classList.remove('active'));
                    const currentEl = document.getElementById(`cad-chord-${idx}`);
                    if(currentEl) currentEl.classList.add('active');
                }, t * 1000);
                t += 1.0; 
            }); 
            
            registerTimeout(() => { modal.style.display = 'none'; if(state.isPlaying) { state.isPlaying = false; if(cb) cb(); } }, t * 1000 + 200); 
        }
        
        function playSequence(sequence, resolve = false) {
            let t = 0; 
            sequence.forEach(s => { playTone(midiToFreq(s.midi), 0.7, 'triangle', t, 0.4); t += 0.8; });
            if (resolve) {
                const lastItem = sequence[sequence.length-1];
                const lastInterval = lastItem.interval; 
                let path = RESOLUTIONS[lastInterval];
                if (!path) path = [lastInterval]; 
                if (path[0] && Array.isArray(path[0])) path = path[0]; 

                let resT = t; 
                const startIdx = (path[0] === lastInterval) ? 1 : 0;

                for(let i=startIdx; i<path.length; i++) {
                    const step = path[i];
                    const midi = state.keyIndex + step;
                    const dur = (i === path.length - 1) ? 1.5 : 0.6;
                    playTone(midiToFreq(midi), dur, 'sine', resT, 0.4);
                    resT += dur * 0.9;
                }
            }
        }

        function generateQuestion() { 
            state.userBuffer = []; 
            state.questionStartTime = Date.now();
            let count = 1;
            // Manual Override allowed in Free Mode via Input
            if (sessionState.active && sessionState.type !== 'free') {
                count = state.currentNoteCount;
                document.getElementById('note-count-input').value = count;
                document.getElementById('note-count-input').disabled = true; 
            } else {
                count = parseInt(document.getElementById('note-count-input').value) || 1;
                state.currentNoteCount = count; 
                document.getElementById('note-count-input').disabled = false;
            }
            
            if(state.mode === 'melody') { 
                const possible = getPossibleIntervals(); 
                const sequence = []; 
                for(let i=0; i<count; i++) { 
                    const interval = possible[Math.floor(Math.random()*possible.length)]; 
                    const midi = state.keyIndex + interval; 
                    sequence.push({ interval, midi }); 
                } 
                state.target = { type: 'melody', sequence }; 
                renderBufferDots(count); 
                if(count > 1) document.getElementById('btn-delete').classList.remove('hidden'); 
            
            } else if (state.mode === 'intervals') {
                const possible = getPossibleIntervals(); 
                const interval = possible[Math.floor(Math.random()*possible.length)];
                const randomStart = 48 + Math.floor(Math.random() * 12); 
                const rootMidi = randomStart; 
                const targetMidi = rootMidi + interval;
                
                let style = 0; 
                if (state.intervalDirection === 'asc') style = 0;
                else if (state.intervalDirection === 'desc') style = 1;
                else if (state.intervalDirection === 'harmonic') style = 2;
                else style = Math.floor(Math.random() * 3); 

                state.target = { type: 'intervals', answer: interval, root: rootMidi, note: targetMidi, style: style };
                renderIntervalOptions(possible);

            } else { 
                let list = state.currentRoundTonality === 'major' ? MAJOR_PROGS : MINOR_PROGS; 
                list = [...new Set(list)];
                const correct = list[Math.floor(Math.random()*list.length)]; 
                const correctLength = correct.split(' - ').length;
                
                // Get valid options of same length - FORCE 4 options logic
                let validOptions = list.filter(x => x !== correct && x.split(' - ').length === correctLength);
                
                if(validOptions.length < 3) {
                    validOptions = list.filter(x => x !== correct);
                }

                const randomValid = validOptions.sort(()=>0.5-Math.random()).slice(0,3);
                const opts = [correct, ...randomValid].sort(()=>0.5-Math.random()); 
                state.target = { type: 'harmony', answer: correct, options: opts }; 
                renderHarmonyOptions(opts); 
            } 
            
            if (state.imagina) { 
                let text = "";
                if(state.mode === 'melody') text = `Canta: ${state.target.sequence.map(s => DEGREES[s.interval]).join(' - ')}`;
                else if (state.mode === 'intervals') text = `Canta: ${INTERVAL_NAMES[state.target.answer]}`;
                else text = `Canta: ${state.target.answer}`;
                const fb = document.getElementById('feedback-text'); 
                fb.innerText = text; 
                fb.className = "feedback-text text-violet-400 text-2xl sm:text-4xl animate-pulse"; 
                document.getElementById('feedback-ui').classList.remove('hidden'); 
            } else { 
                if(state.mode === 'melody') { 
                    playSequence(state.target.sequence);
                } else if (state.mode === 'intervals') {
                    playInterval(state.target.root, state.target.note, state.target.style);
                } else { 
                    playProgression(state.target.answer); 
                } 
            } 
            document.getElementById('btn-repeat-base').classList.toggle('hidden', state.sprint); 
            document.getElementById('btn-repeat-target').classList.remove('hidden'); 
        }

        function playInterval(root, note, style = 0) {
            if (style === 2) {
                playTone(midiToFreq(root), 1.2, 'triangle', 0, 0.4);
                playTone(midiToFreq(note), 1.2, 'triangle', 0, 0.4);
            } else if (style === 1) { 
                playTone(midiToFreq(note), 0.8, 'triangle', 0, 0.4);
                playTone(midiToFreq(root), 0.8, 'triangle', 0.8, 0.4);
            } else { 
                playTone(midiToFreq(root), 0.8, 'triangle', 0, 0.4);
                playTone(midiToFreq(note), 0.8, 'triangle', 0.8, 0.4);
            }
        }

        function playProgression(progStr) { const chords = progStr.split(' - '); const map = { 'I':0, 'ii':2, 'iii':4, 'IV':5, 'V':7, 'vi':9, 'vii':11, 'vii¬∞':11, 'i':0, 'ii¬∞':2, 'III':3, 'iv':5, 'v':7, 'VI':8, 'VII':10, 'bII':1, 'bIII':3, '#IV':6, 'bVI':8, 'bVII':10, 'V/vi':4, 'V/V':2, 'V/IV':0, 'V/ii':9 }; let t = 0; let prevVoicing = null; chords.forEach((c) => { const root = state.keyIndex + (map[c.trim().replace(/7|maj|m|¬∞/g, '')] || 0); const ty = (c.includes('m') || c.toLowerCase() === c) ? 'Min' : 'Maj'; let bass = root; while (bass >= 48) bass -= 12; if (bass < 36) bass += 12; const voicing = getBestVoicing(prevVoicing, root, ty, bass); playVoicedChord(bass, voicing, 1.2, t); prevVoicing = { notes: voicing, bass: bass }; t += 1.2; }); }
        
        function getPossibleIntervals() { 
            const isMin = state.currentRoundTonality === 'minor'; 
            if (state.mode === 'intervals') {
                let intervals = [];
                for(let i = 1; i <= state.intervalLevel; i++) { if(INTERVAL_LEVELS[i]) intervals = [...intervals, ...INTERVAL_LEVELS[i]]; }
                return intervals.sort((a,b) => a-b);
            }
            if (state.level === 'basic1') { return isMin ? [0, 2, 3, 5] : [0, 2, 4, 5]; } 
            if (state.level === 'basic2') { return isMin ? [7, 8, 10, 12] : [7, 9, 11, 12]; } 
            if (state.level === 'inter') { return isMin ? [0, 2, 3, 5, 7, 8, 10, 12] : [0, 2, 4, 5, 7, 9, 11, 12]; } 
            if (state.level === 'adv1') return [0, 1, 2, 3, 4, 5]; 
            if (state.level === 'adv2') return [6, 7, 8, 9, 10, 11, 12]; 
            return Array.from({length: 13}, (_, i) => i); 
        }

        function saveHistory(correct, detail, duration = 0, timeTaken = 0) { 
            const isSummary = typeof correct === 'boolean' && detail.startsWith("Rutina") || detail.startsWith("Pr√°ctica") || detail.startsWith("Test");
            const entry = { date: Date.now(), correct, mode: state.mode, level: state.mode === 'intervals' ? `Nivel ${state.intervalLevel}` : state.level, detail, isSessionSummary: isSummary, duration: duration, timeTaken: timeTaken };
            state.history.unshift(entry); 
            if(state.history.length > 100) state.history = state.history.slice(0, 100); 
            localStorage.setItem('formarOidoPro_history', JSON.stringify(state.history)); 
        }
        
        function checkAnswer(val) { 
            if(!state.target || state.isPlaying) return; 
            const timeTaken = (Date.now() - state.questionStartTime) / 1000;
            let isCorrect = false; let detail = ""; let userAns = ""; let correctAns = ""; 
            
            if(state.mode === 'melody') { 
                state.userBuffer.push(val); 
                const dots = document.querySelectorAll('.buffer-dot'); 
                if(dots[state.userBuffer.length - 1]) dots[state.userBuffer.length - 1].classList.add('active'); 
                if(state.userBuffer.length === state.target.sequence.length) { 
                    isCorrect = state.userBuffer.every((v, i) => v === state.target.sequence[i].interval); 
                    userAns = state.userBuffer.map(s => DEGREES[s]).join(' - '); 
                    correctAns = state.target.sequence.map(s => DEGREES[s.interval]).join(' - '); 
                    detail = correctAns; 
                    if(!isCorrect) {
                        state.lastUserAnswer = state.userBuffer.map(interval => ({interval, midi: state.keyIndex + interval}));
                        state.lastCorrectAnswer = state.target.sequence;
                    }
                    if(state.autoResolve && state.target.sequence.length === 1) executeVisualResolution(state.target.sequence[0].interval, false); 
                    handleResult(isCorrect, userAns, correctAns, detail, timeTaken); 
                    state.target = null; 
                } 
            } else if (state.mode === 'intervals') {
                isCorrect = val === state.target.answer;
                const rootName = getNoteName(state.keyLabel, (state.target.root - state.keyIndex + 12) % 12); 
                const absRoot = Tone.Frequency(state.target.root, "midi").toNote();
                const absTarget = Tone.Frequency(state.target.note, "midi").toNote();
                
                userAns = INTERVAL_NAMES[val];
                correctAns = `${INTERVAL_NAMES[state.target.answer]} (${absRoot}-${absTarget})`; 
                detail = correctAns;
                
                if(!isCorrect) {
                    state.lastUserAnswer = { root: state.target.root, note: state.target.root + val, style: state.target.style };
                    state.lastCorrectAnswer = { root: state.target.root, note: state.target.note, style: state.target.style };
                }
                renderIntervalOptions(getPossibleIntervals(), val, state.target.answer);
                handleResult(isCorrect, userAns, correctAns, detail, timeTaken);
                state.target = null;

            } else { 
                isCorrect = val === state.target.answer; 
                userAns = val; 
                correctAns = `${state.target.answer} (${getAmericanChords(state.target.answer)})`;
                detail = correctAns; 
                if(!isCorrect) {
                    state.lastUserAnswer = val;
                    state.lastCorrectAnswer = state.target.answer; 
                }
                renderHarmonyOptions(state.target.options, val, state.target.answer); 
                handleResult(isCorrect, userAns, correctAns, detail, timeTaken); 
                state.target = null; 
            } 
        }

        function showToast(msg) {
            const toast = document.getElementById('toast-notification');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // NEW: playUserError now resolves specifically
        function playUserError() {
            if (!state.lastUserAnswer) return;
            stopAllSounds();
            if (state.mode === 'melody') playSequence(state.lastUserAnswer, true); 
            else if (state.mode === 'intervals') playInterval(state.lastUserAnswer.root, state.lastUserAnswer.note, state.lastUserAnswer.style);
            else playProgression(state.lastUserAnswer);
        }

        // NEW: playCorrectAnswer now resolves specifically
        function playCorrectAnswer() {
            if (!state.lastCorrectAnswer) return;
            stopAllSounds();
            if (state.mode === 'melody') playSequence(state.lastCorrectAnswer, true); 
            else if (state.mode === 'intervals') playInterval(state.lastCorrectAnswer.root, state.lastCorrectAnswer.note, state.lastCorrectAnswer.style);
            else playProgression(state.lastCorrectAnswer);
        }

        function handleResult(isCorrect, user, correct, detail, timeTaken) { 
            // Save log
            if(sessionState.type !== 'assessment') {
                const entry = { date: Date.now(), correct, mode: state.mode, level: state.mode === 'intervals' ? `Nivel ${state.intervalLevel}` : state.level, detail, isSessionSummary: false, timeTaken: timeTaken };
                state.history.unshift(entry);
                if(state.history.length > 100) state.history = state.history.slice(0, 100);
                localStorage.setItem('formarOidoPro_history', JSON.stringify(state.history));
            }

            // PLACEMENT TEST LOGIC
            if (placementState.active) {
                if (isCorrect) {
                    placementState.levelIndex++;
                    placementState.maxLevelReached = Math.max(placementState.maxLevelReached, placementState.levelIndex);
                    // Continue immediately to next question
                    setTimeout(() => loadAssessmentQuestion(), 500); 
                } else {
                    placementState.strikes++;
                    // If fail, check strikes. We allow 2 mistakes total.
                    if (placementState.strikes >= placementState.totalStrikesAllowed) {
                        finishPlacementTest();
                    } else {
                        showResultModal(isCorrect, user, correct);
                    }
                }
                return; // Stop normal flow
            }

            // XP Logic
            if (isCorrect) {
                let points = 5; 
                if (timeTaken < 3) points = 15;
                else if (timeTaken < 8) points = 10;
                state.xp += points;
                state.score += 1;
                state.streak++;
                state.consecutiveMelodyFailures = 0; // Reset failure counter
                document.getElementById('score-val').innerText = state.xp;
                localStorage.setItem('formarOidoPro_xp', state.xp);
            } else {
                state.streak = 0;
                // FAILURE TRACKING FOR MELODY
                if (state.mode === 'melody' && sessionState.type === 'free') {
                    state.consecutiveMelodyFailures++;
                    if (state.consecutiveMelodyFailures >= 3) {
                        if (state.currentNoteCount > 1) {
                            state.currentNoteCount--;
                            document.getElementById('note-count-input').value = state.currentNoteCount;
                            showToast("Detectamos dificultad, ajustando nivel... (-1 Nota)");
                            state.consecutiveMelodyFailures = 0;
                        }
                    }
                }

                // Log Error to Matrix
                if (!state.errorStats[state.mode]) state.errorStats[state.mode] = {};
                let targetKey = state.target.answer;
                if (state.mode === 'intervals') targetKey = INTERVAL_NAMES[targetKey];
                
                let mistakeKey = user;
                
                if (!state.errorStats[state.mode][targetKey]) state.errorStats[state.mode][targetKey] = {};
                if (!state.errorStats[state.mode][targetKey][mistakeKey]) state.errorStats[state.mode][targetKey][mistakeKey] = 0;
                state.errorStats[state.mode][targetKey][mistakeKey]++;
                localStorage.setItem('formarOidoPro_errors', JSON.stringify(state.errorStats));
            }

            if (state.mode === 'melody' && (state.level === 'inter' || state.level === 'adv1' || state.level === 'adv2')) {
                if (isCorrect) state.currentNoteCount++; 
            }

            if (sessionState.active) { 
                sessionState.totalQuestions++; 
                if (isCorrect) sessionState.correctCount++; 
                if (state.mode === 'melody') { sessionState.stats.melTotal++; if (isCorrect) sessionState.stats.melCorrect++; } 
                else if (state.mode === 'harmony') { sessionState.stats.harTotal++; if (isCorrect) sessionState.stats.harCorrect++; } 
                else if (state.mode === 'intervals') { sessionState.stats.intTotal++; if (isCorrect) sessionState.stats.intCorrect++; }
                
                if(sessionState.type !== 'assessment') saveSessionState(); 
                
                if(sessionState.type !== 'free' && sessionState.type !== 'assessment') updateSessionProgress(); 
            } 
            const comboEl = document.getElementById('combo-display'); 
            if(isCorrect) { 
                if(state.streak > 1) { 
                    comboEl.innerText = `COMBO x${state.streak} üî•`; 
                    comboEl.classList.add('combo-active'); 
                    comboEl.style.animation = 'none'; 
                    comboEl.offsetHeight; 
                    comboEl.style.animation = 'bounceShort 0.5s ease-in-out'; 
                } 
                triggerConfetti(); 
            } else { 
                comboEl.classList.remove('combo-active'); 
            } 
            
            showResultModal(isCorrect, user, correct); 
        }

        function triggerConfetti() { const container = document.getElementById('confetti-container'); container.innerHTML = ''; const colors = ['#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#3b82f6']; for(let i=0; i<30; i++) { const el = document.createElement('div'); el.className = 'confetti-piece'; el.style.left = Math.random() * 100 + '%'; el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; el.style.animationDelay = Math.random() * 0.5 + 's'; el.style.transform = `rotate(${Math.random() * 360}deg)`; el.style.animation = `confettiDrop ${1 + Math.random()}s ease-out forwards`; container.appendChild(el); } }
        
        function showResultModal(isCorrect, user, correct) { 
            const m = document.getElementById('result-modal'); const card = document.getElementById('result-card'); const icon = document.getElementById('result-icon'); const title = document.getElementById('result-title'); const uText = document.getElementById('result-user'); const cBlock = document.getElementById('correct-block'); const cText = document.getElementById('result-correct'); const btn = document.getElementById('btn-continue-result'); const feedbackControls = document.getElementById('feedback-controls');
            const tipEl = document.getElementById('feedback-tip');

            m.style.display = 'flex'; 
            
            // Generate Tip
            if (!isCorrect) {
                const tip = getPedagogicalTip(state.mode, state.target.answer, user, correct);
                tipEl.innerText = tip;
                tipEl.classList.remove('hidden');
            } else {
                tipEl.classList.add('hidden');
            }

            if(sessionState.type === 'assessment') {
                btn.innerText = "Continuar Test";
            } else {
                btn.innerText = "Continuar";
            }

            if(isCorrect) { 
                card.className = "modal-content animate-pop-in border-4 border-emerald-500/50 w-[90%] max-w-sm flex flex-col items-center justify-center text-center relative overflow-hidden"; 
                icon.innerHTML = "üéâ"; title.innerText = "¬°Excelente!"; title.className = "text-3xl font-black uppercase italic mb-2 text-emerald-500 z-10"; uText.innerText = user; uText.className = "font-mono text-lg font-bold mb-4 text-emerald-600 z-10"; cBlock.classList.add('hidden'); feedbackControls.classList.add('hidden'); 
                btn.className = "mt-6 w-full py-3 rounded-xl font-black uppercase tracking-widest text-xs transition-colors shadow-lg text-white bg-emerald-500 hover:bg-emerald-600 z-10"; 
                if(sessionState.type !== 'assessment') registerTimeout(() => { if(m.style.display === 'flex') { m.style.display = 'none'; startGame(); } }, 1500); 
            } else { 
                card.className = "modal-content animate-pop-in border-4 border-rose-500/50 w-[90%] max-w-sm flex flex-col items-center justify-center text-center relative overflow-hidden"; 
                document.getElementById('confetti-container').innerHTML = ''; 
                icon.innerHTML = "‚ùå"; title.innerText = "Casi..."; title.className = "text-3xl font-black uppercase italic mb-2 text-rose-500 z-10"; uText.innerText = user; uText.className = "font-mono text-lg font-bold mb-4 text-rose-600 line-through decoration-2 opacity-70 z-10"; cBlock.classList.remove('hidden'); feedbackControls.classList.remove('hidden'); 
                cText.innerText = correct; 
                btn.className = "mt-6 w-full py-3 rounded-xl font-black uppercase tracking-widest text-xs transition-colors shadow-lg text-white bg-slate-800 hover:bg-slate-700 z-10"; 
            } 
        }
        
        function handleContinue() { 
            document.getElementById('result-modal').style.display = 'none'; 
            if(placementState.active) {
                // If strikes > 0 but < max, we allow retry/continue. Logic is simplified to advance level or keep same?
                // The prompt says "questions rise according to skill". If failed, maybe repeat level question?
                // Simple logic: Load Next question attempt. If correct, level up. If wrong again, out.
                // Re-calling loadAssessmentQuestion re-evaluates level index, which didn't increase on failure.
                // So it repeats level question.
                loadAssessmentQuestion();
            }
            else startGame(); 
        }
        function updateUsername(val) { state.username = val; localStorage.setItem('formarOidoPro_username', val); }
        
        function openStats() { 
            const h = state.history; 
            let currentLevel = "NOVATO";
            let nextXP = 100;
            let prevXP = 0;
            for (const [xp, label] of Object.entries(LEVELS_XP)) {
                if (state.xp >= parseInt(xp)) {
                    currentLevel = label;
                    prevXP = parseInt(xp);
                } else {
                    nextXP = parseInt(xp);
                    break;
                }
            }
            const progress = Math.min(100, Math.max(0, ((state.xp - prevXP) / (nextXP - prevXP)) * 100));
            document.getElementById('stat-level').innerText = currentLevel;
            document.getElementById('xp-bar').style.width = `${progress}%`;
            document.getElementById('current-xp').innerText = `${state.xp} / ${nextXP}`;

            document.getElementById('stat-streak').innerText = state.dailyStreak + " üî•"; 
            document.getElementById('username-input').value = state.username || ''; 
            
            const chartContainer = document.getElementById('chart-container'); 
            chartContainer.innerHTML = ''; 
            const recent = h.filter(x=>!x.isSessionSummary).slice(0, 14).reverse(); 
            if (recent.length === 0) { chartContainer.innerHTML = '<p class="w-full text-center text-[10px] text-slate-400">Sin datos a√∫n</p>'; } 
            else { recent.forEach(x => { const bar = document.createElement('div'); bar.className = `flex-1 rounded-t-sm ${x.correct ? 'bg-emerald-400' : 'bg-rose-400'}`; bar.style.height = x.correct ? '80%' : '30%'; chartContainer.appendChild(bar); }); } 
            
            // ANALYZE STRENGTHS & WEAKNESSES
            let strengths = [];
            let weaknesses = [];
            
            // Aggregate all data from errorStats and history
            // Simplify: use errorStats for weaknesses.
            // For strengths, we need success counts. Let's iterate history.
            let itemStats = {}; 
            
            h.forEach(entry => {
                if(entry.isSessionSummary) return;
                // Try to parse detail to get key name (e.g., "5ta Justa" or "I - IV - V")
                // Detail usually holds the correct answer string.
                // Let's use that.
                let key = entry.detail;
                // Remove hints/notes for cleaner key
                if (key.includes('(')) key = key.split('(')[0].trim();
                
                if(!itemStats[key]) itemStats[key] = { correct: 0, total: 0 };
                itemStats[key].total++;
                if(entry.correct) itemStats[key].correct++;
            });
            
            // Convert to array
            let statsArr = Object.keys(itemStats).map(k => {
                return { key: k, acc: itemStats[k].correct / itemStats[k].total, total: itemStats[k].total };
            });
            
            // Filter significant data (>2 attempts)
            let significant = statsArr.filter(i => i.total >= 3);
            
            // Sort
            significant.sort((a,b) => b.acc - a.acc);
            
            // Top 3 Strengths
            strengths = significant.filter(i => i.acc >= 0.7).slice(0, 3).map(i => `${i.key} (${Math.round(i.acc*100)}%)`);
            // Top 3 Weaknesses (Lowest Acc)
            weaknesses = significant.filter(i => i.acc < 0.6).sort((a,b) => a.acc - b.acc).slice(0, 3).map(i => `${i.key} (${Math.round(i.acc*100)}%)`);
            
            // Render Lists
            const sList = document.getElementById('stat-strengths');
            sList.innerHTML = strengths.length ? strengths.map(s => `<li>${s}</li>`).join('') : '<li class="text-slate-400 italic">Sigue practicando...</li>';
            
            const wList = document.getElementById('stat-weaknesses');
            wList.innerHTML = weaknesses.length ? weaknesses.map(w => `<li>${w}</li>`).join('') : '<li class="text-slate-400 italic">¬°Muy bien!</li>';

            // General Suggestion based on weak mode
            let suggestion = "Continua practicando.";
            if (weaknesses.length > 0) {
                suggestion = `Enf√≥cate en mejorar: ${weaknesses[0].split('(')[0]}.`;
            }

            document.getElementById('stat-suggestion').innerHTML = suggestion; 
            
            // HISTORY LIST LOGIC
            const list = document.getElementById('history-list'); 
            list.innerHTML = ''; 
            h.slice(0, 15).forEach(x => { 
                const row = document.createElement('div'); 
                row.className = "flex justify-between items-center bg-slate-50 dark:bg-slate-800 p-2 rounded text-[10px] border-l-2 " + (x.correct ? "border-emerald-400" : "border-rose-400"); 
                const dateObj = new Date(x.date); 
                const timeStr = dateObj.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); 
                const dateStr = dateObj.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }); 
                
                let durationStr = "";
                if (x.duration > 0) {
                    const mins = Math.floor(x.duration / 60000);
                    const secs = Math.floor((x.duration % 60000) / 1000);
                    durationStr = `‚è± ${mins}m ${secs}s`;
                }
                
                let speedTag = "";
                if (x.timeTaken && !x.isSessionSummary) {
                    if (x.timeTaken < 3) speedTag = "‚ö°";
                    else if (x.timeTaken > 8) speedTag = "üê¢";
                }

                const detailText = x.detail.length > 25 ? x.detail.substring(0,25) + "..." : x.detail;

                row.innerHTML = `
                    <div class="flex flex-col w-2/3">
                        <span class="font-bold text-slate-700 dark:text-white truncate">${x.mode.toUpperCase()} ${x.isSessionSummary ? '(RESUMEN)' : ''}</span>
                        <span class="text-[8px] text-slate-400">${dateStr} ${timeStr} ${durationStr ? '‚Ä¢ ' + durationStr : ''}</span>
                    </div>
                    <div class="flex flex-col items-end w-1/3">
                        <div class="flex items-center gap-1">
                            <span class="text-[7px] text-slate-400">${speedTag}</span>
                            <span class="font-mono font-bold ${x.correct ? 'text-emerald-500' : 'text-rose-500'}">${x.correct ? 'ACIERTO' : 'FALLO'}</span>
                        </div>
                        <span class="text-[8px] text-slate-500 truncate max-w-full" title="${x.detail}">${detailText}</span>
                    </div>`; 
                list.appendChild(row); 
            }); 
            document.getElementById('stats-modal').style.display = 'flex'; 
        }

        function resetStats() { 
            state.history = []; 
            state.xp = 0;
            state.errorStats = {};
            localStorage.removeItem('formarOidoPro_history'); 
            localStorage.removeItem('formarOidoPro_xp');
            localStorage.removeItem('formarOidoPro_errors');
            openStats(); 
        }
        function closeStats() { document.getElementById('stats-modal').style.display = 'none'; }
        function exportData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.history)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); const name = state.username || 'oido'; const safeName = name.replace(/[^a-z0-9]/gi, '_').toLowerCase(); downloadAnchorNode.setAttribute("download", `entrenamiento_${safeName}.json`); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); }
        function importData() { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.readAsText(file,'UTF-8'); reader.onload = readerEvent => { try { const content = JSON.parse(readerEvent.target.result); if (Array.isArray(content)) { state.history = content; localStorage.setItem('formarOidoPro_history', JSON.stringify(state.history)); alert('Datos importados correctamente.'); openStats(); } else { alert('Archivo inv√°lido.'); } } catch (error) { alert('Error al leer el archivo.'); } } }; input.click(); }
        function deleteLastNote() { if(state.userBuffer.length > 0) { const dots = document.querySelectorAll('.buffer-dot'); dots[state.userBuffer.length - 1].classList.remove('active'); state.userBuffer.pop(); } }
        function executeVisualResolution(degreeIdx, next, delay = 0) { 
            let path = RESOLUTIONS[degreeIdx];
            if(Array.isArray(path[0])) path = path[Math.floor(Math.random() * path.length)];
            else if (!path) path = [degreeIdx];

            if(parseInt(document.getElementById('note-count-input').value) > 1 && next) return; 
            
            let t = delay / 1000; path.forEach((step, idx) => { const midi = state.keyIndex + step; const dur = (idx === path.length - 1) ? 1.0 : 0.4; playTone(midiToFreq(midi), dur, idx === 0 ? 'triangle' : 'sine', t, 0.2); registerTimeout(() => { const k = document.querySelector(`[data-interval="${step}"]`); if(k) { k.classList.add('highlight-res'); registerTimeout(() => k.classList.remove('highlight-res'), 400); } }, t * 1000); t += dur; }); if(next) registerTimeout(() => startGame(), t * 1000 + 400); 
        }
        function renderUI() { renderPiano(); renderPracticeChips(); }
        function renderPiano() { const stage = document.getElementById('piano-stage'); stage.innerHTML = ''; const offsets = [0, 0.6, 1, 1.6, 2, 3, 3.6, 4, 4.6, 5, 5.6, 6]; const rootOffset = ROOT_INDICES[state.keyLabel] || 0; for(let i=0; i<25; i++) { const midi = 48 + i; const abs = midi % 12; const relPos = (Math.floor(i/12)*7) + offsets[abs]; const btn = document.createElement('button'); btn.className = `piano-key ${[1, 3, 6, 8, 10].includes(abs) ? 'key-black' : 'key-white'}`; btn.style.left = `calc(${relPos} * (100% / 15))`; const functional = midi - state.keyIndex; if(functional >= 0 && functional <= 12) { btn.setAttribute('data-interval', functional); const noteName = getNoteName(state.keyLabel, functional); btn.innerHTML = `<div class="degree-tag bg-${getFunctionalClass(functional)}">${DEGREES[functional]}</div><div class="note-name color-${getFunctionalClass(functional)}">${noteName}</div>`; } btn.onclick = () => { initAudio(); playTone(midiToFreq(midi), 0.5); if(functional >= 0 && functional <= 12) checkAnswer(functional); }; stage.appendChild(btn); } }
        function renderPracticeChips() { const container = document.getElementById('practice-chips-container'); container.innerHTML = ''; const list = getPossibleIntervals(); list.forEach(idx => { const card = document.createElement('div'); card.className = `practice-card bg-${getFunctionalClass(idx)} text-white`; card.innerHTML = DEGREES[idx]; card.onclick = () => { initAudio(); executeVisualResolution(idx, false); const k = document.querySelector(`[data-interval="${idx}"]`); if(k) { k.classList.add('highlight-res'); registerTimeout(() => k.classList.remove('highlight-res'), 600); } }; container.appendChild(card); }); }
        
        function renderIntervalOptions(opts, clicked = null, correct = null) {
            const grid = document.getElementById('interval-grid'); 
            grid.innerHTML = ''; 
            opts.forEach(intervalIdx => { 
                const btn = document.createElement('button'); 
                const name = INTERVAL_NAMES[intervalIdx];
                btn.innerHTML = `<div class="interval-btn-text text-slate-600 dark:text-slate-300">${name}</div>`; 
                if(clicked !== null) { 
                    if(intervalIdx === correct) btn.className = "p-2 border-2 border-emerald-500 bg-emerald-600/20 text-emerald-400 font-black rounded-xl shadow-lg"; 
                    else if(intervalIdx === clicked) btn.className = "p-2 border-2 border-rose-500 bg-rose-600/20 text-rose-400 opacity-50 rounded-xl"; 
                } else btn.onclick = () => checkAnswer(intervalIdx); 
                grid.appendChild(btn); 
            }); 
        }

        function renderHarmonyOptions(opts, clicked = null, correct = null) { 
            const grid = document.getElementById('harmony-grid'); 
            grid.innerHTML = ''; 
            opts.forEach(o => { 
                const btn = document.createElement('button'); 
                // Uses helper for American Cipher
                const cipher = getAmericanChords(o);

                btn.innerHTML = `<div class="cipher-text">${cipher}</div><div class="roman-text opacity-60 text-[7px] font-bold">${o}</div>`; 
                if(clicked) { 
                    if(o === correct) btn.className = "p-2 border-2 border-emerald-500 bg-emerald-600/20 text-emerald-400 font-black rounded-xl shadow-lg"; 
                    else if(o === clicked) btn.className = "p-2 border-2 border-rose-500 bg-rose-600/20 text-rose-400 opacity-50 rounded-xl"; 
                } else btn.onclick = () => checkAnswer(o); 
                grid.appendChild(btn); 
            }); 
        }

        function renderBufferDots(count) { const container = document.getElementById('buffer-dots'); container.innerHTML = ''; for(let i=0; i<count; i++) { const dot = document.createElement('div'); dot.className = 'buffer-dot'; container.appendChild(dot); } }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); document.documentElement.classList.toggle('dark'); const sun = document.getElementById('sun-icon'); const moon = document.getElementById('moon-icon'); if (document.body.classList.contains('dark-mode')) { sun.classList.add('hidden'); moon.classList.remove('hidden'); } else { sun.classList.remove('hidden'); moon.classList.add('hidden'); } }
        function resetUI() { 
            document.getElementById('result-modal').style.display = 'none'; 
            document.getElementById('feedback-ui').classList.add('hidden');
            document.getElementById('btn-delete').classList.add('hidden'); 
            document.getElementById('harmony-grid').innerHTML = ''; 
            document.getElementById('interval-grid').innerHTML = ''; 
            state.userBuffer = []; 
            renderUI(); 
        }
        function repeatTargetSound() { 
            if(state.target) { 
                if(state.mode === 'melody') state.target.sequence.forEach((s, i) => playTone(midiToFreq(s.midi), 0.6, 'triangle', i * 0.8, 0.4)); 
                else if (state.mode === 'intervals') playInterval(state.target.root, state.target.note, state.target.style);
                else playProgression(state.target.answer); 
            } 
        }
        function playCurrentCadence() { if(!state.isPlaying) playCadence(); }
        function openModal() { document.getElementById('help-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('help-modal').style.display = 'none'; }
        function toggleSprint() { state.sprint = !state.sprint; document.getElementById('sprint-timer-box')?.classList.toggle('hidden', !state.sprint); if (state.sprint) { state.timeLeft = parseInt(document.getElementById('sprint-time-input').value) || 60; startTimer(); startGame(); } else { clearInterval(state.timerId); } }
        function startTimer() { clearInterval(state.timerId); state.timerId = setInterval(() => { state.timeLeft--; if (state.timeLeft <= 0) { clearInterval(state.timerId); state.sprint = false; } }, 1000); }

        window.addEventListener('keydown', (e) => { const k = e.key.toLowerCase(); if(document.getElementById('result-modal').style.display === 'flex' && (k === 'enter' || k === ' ')) { document.getElementById('result-modal').style.display = 'none'; startGame(); return; } if(k === ' ' || k === 'c') startGame(); if(k === 'r') repeatTargetSound(); if(k === 'b') playCurrentCadence(); if(k === 's') toggleSprint(); if(k === 't') toggleTheme(); if(k === 'h') openModal(); if(k === 'backspace') deleteLastNote(); if(k >= '1' && k <= '6') setLevel(['basic1','basic2','inter','adv1','adv2','total'][parseInt(k)-1]); });
        
        let touchStart = 0;
        let ptrdist = 0;
        const ptrElement = document.getElementById('ptr-indicator');
        const scrollContainer = document.getElementById('main-scroll-container'); // Correct ID target

        if (scrollContainer) {
            scrollContainer.addEventListener('touchstart', e => {
                if (scrollContainer.scrollTop === 0) {
                    touchStart = e.touches[0].clientY;
                }
            }, {passive: true});

            scrollContainer.addEventListener('touchmove', e => {
                const y = e.touches[0].clientY;
                if (scrollContainer.scrollTop === 0 && y > touchStart) {
                    ptrdist = y - touchStart;
                    if (ptrdist > 80) ptrdist = 80;
                    ptrElement.style.transform = `translateY(${ptrdist - 60}px)`; 
                    ptrElement.style.opacity = Math.min(1, ptrdist / 60);
                }
            }, {passive: true});

            scrollContainer.addEventListener('touchend', () => {
                if (ptrdist > 60) {
                    location.reload(); 
                } else {
                    ptrElement.style.transform = 'translateY(-100%)';
                    ptrElement.style.opacity = '0';
                }
                touchStart = 0;
                ptrdist = 0;
            });
        }

        // Initialize Tone.js Helper (Mock for standalone visual, replace with actual Tone.js or robust note naming if Tone not loaded)
        const Tone = { Frequency: (m) => ({ toNote: () => { 
            const n = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
            return n[m%12] + (Math.floor(m/12)-1);
        }})};

        // Initialize UI but wait for modal selection to start audio/game
        renderUI();
    </script>
</body>
</html>
