<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Formar O√≠do Pro - Trainer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Html2Canvas para exportar reportes -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 950: '#020617' },
                        gold: { 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' }
                    },
                    screens: { 'xs': '380px' },
                    animation: {
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'bounce-short': 'bounceShort 0.5s ease-in-out',
                        'confetti': 'confettiDrop 2s ease-in-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pulse-tonic': 'pulseTonic 2s infinite ease-in-out',
                        'levelup': 'levelUp 1s ease-out forwards',
                    },
                    keyframes: {
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.8) translateY(20px)' }, '100%': { opacity: '1', transform: 'scale(1) translateY(0)' } },
                        bounceShort: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.2)' } },
                        confettiDrop: { '0%': { transform: 'translateY(-100vh) rotate(0deg)', opacity: '1' }, '100%': { transform: 'translateY(100vh) rotate(720deg)', opacity: '0' } },
                        pulseTonic: { '0%, 100%': { opacity: '1', transform: 'scale(1.05)' }, '50%': { opacity: '0.4', transform: 'scale(0.95)' } },
                        levelUp: { '0%': { transform: 'scale(0.5)', opacity: '0' }, '50%': { transform: 'scale(1.2)', opacity: '1' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&family=Fira+Code:wght@500;700&display=swap');
        
        :root {
            --bg-main: #fdfbf7; --bg-piano: #f3f4f6; --text-main: #1e293b; --border-ui: #e2e8f0; --card-bg: #ffffff;
            --accent: #8b5cf6; --accent-hover: #7c3aed;
            --c-tonic: #8b5cf6; --c-stable: #10b981; --c-semi: #3b82f6; --c-unstable: #f59e0b;
        }

        body.dark-mode {
            --bg-main: #0f172a; --bg-piano: #1e293b; --text-main: #f8fafc; --border-ui: #334155; --card-bg: #1e293b;
            --accent: #a78bfa; --accent-hover: #c4b5fd;
        }

        body { font-family: 'Nunito', sans-serif; background: var(--bg-main); color: var(--text-main); height: 100vh; margin: 0; display: flex; flex-direction: column; transition: background 0.4s ease, color 0.4s ease; overflow: hidden; -webkit-user-select: none; user-select: none; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .piano-viewport { width: 100%; overflow-x: auto; padding: 10px 10px 20px 10px; background: var(--bg-piano); border-top: 2px solid var(--border-ui); display: flex; justify-content: flex-start; box-shadow: inset 0 4px 6px rgba(0,0,0,0.05); }
        @media (min-width: 640px) { .piano-viewport { justify-content: center; } }
        .piano-stage { position: relative; height: 130px; min-width: 700px; width: 100%; max-width: 920px; margin: 0 auto; flex-shrink: 0; }
        
        .key-white { position: absolute; top: 0; width: calc(100% / 15); height: 100%; background: linear-gradient(to bottom, #ffffff 0%, #f1f5f9 100%); border: 1px solid #cbd5e1; border-bottom: 4px solid #94a3b8; border-radius: 0 0 6px 6px; z-index: 1; cursor: pointer; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 8px; transition: transform 0.1s; }
        .key-black { position: absolute; top: 0; width: calc(100% / 26); height: 60%; background: linear-gradient(to bottom, #1e293b 0%, #0f172a 100%); border: 1px solid #000; border-bottom: 6px solid #000; border-radius: 0 0 4px 4px; z-index: 2; cursor: pointer; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 4px; color: white; transition: transform 0.1s; }

        .key-white:active, .key-black:active { transform: translateY(2px); border-bottom-width: 1px; }

        .control-group { background: var(--card-bg); padding: 4px; border-radius: 14px; border: 1px solid var(--border-ui); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .control-btn { padding: 8px 2px; border-radius: 10px; font-size: 9px; font-weight: 800; color: #64748b; cursor: pointer; border: 1px solid transparent; background: transparent; transition: all 0.2s; text-align: center; text-transform: uppercase; }
        .active-choice { background: var(--accent) !important; color: white !important; box-shadow: 0 0 15px rgba(139, 92, 246, 0.4) !important; transform: scale(1.02); font-weight: 900 !important; }

        .compact-badge { background: var(--card-bg); border: 1px solid var(--border-ui); border-radius: 12px; padding: 0 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 42px; min-width: 60px; }
        
        .res-card { padding: 14px; border-radius: 18px; background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; transition: all 0.2s; cursor: pointer; }
        .dark-mode .res-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-color: rgba(255,255,255,0.08); }
        .res-card-accent { background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white !important; box-shadow: 0 12px 30px rgba(139, 92, 246, 0.3); border: none; }

        .bg-tonic { background: var(--c-tonic) !important; color: white !important; }
        .bg-stable { background: var(--c-stable) !important; color: white !important; }
        .bg-semi { background: var(--c-semi) !important; color: white !important; }
        .bg-unstable { background: var(--c-unstable) !important; color: white !important; }

        .degree-tag { width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 8px; margin-bottom: 2px; }
        .note-name { font-size: 8px; font-weight: 800; font-family: 'Fira Code', monospace; text-transform: none; }
        
        .chord-box { display: flex; flex-direction: column; align-items: center; padding: 12px 18px; border-radius: 18px; transition: all 0.2s; border: 3px solid transparent; min-width: 85px; background: white; color: #1e293b; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .chord-box.active { background: var(--accent); color: white !important; border-color: rgba(255,255,255,0.8); transform: scale(1.15); box-shadow: 0 8px 20px rgba(139, 92, 246, 0.6); }

        .buffer-indicator { display: flex; gap: 6px; margin-top: 10px; justify-content: center; align-items: center; }
        .buffer-dot { width: 12px; height: 12px; border-radius: 50%; background: #cbd5e1; transition: all 0.2s; border: 2px solid transparent; }
        .buffer-dot.active { background: var(--accent); transform: scale(1.2); border-color: white; box-shadow: 0 0 8px var(--accent); }
        
        .btn-delete { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #fee2e2; color: #ef4444; cursor: pointer; transition: all 0.2s; margin-left: 8px; }
        .btn-delete:active { transform: scale(0.85); background: #ef4444; color: white; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 500; display: none; align-items: center; justify-content: center; padding: 15px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); color: var(--text-main); max-width: 420px; width: 100%; border-radius: 20px; padding: 20px; border: 1px solid var(--border-ui); box-shadow: 0 15px 40px rgba(0,0,0,0.2); }

        .bottom-dock { padding-bottom: env(safe-area-inset-bottom); border-top: 1px solid var(--border-ui); background: var(--card-bg); }
        .dock-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; transition: all 0.1s; cursor: pointer; height: 52px; position: relative; }
        .btn-main-action { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white !important; border: none; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        
        #harmony-grid button, #interval-grid button { border: 2px solid var(--border-ui); display: flex; align-items: center; justify-content: center; transition: all 0.2s; background: var(--card-bg); min-height: 54px; border-radius: 14px; padding: 8px; color: var(--text-main); font-size: 11px; font-weight: 800; width: 100%; }
        #harmony-grid button:active, #interval-grid button:active { transform: scale(0.95); border-color: var(--accent); }

        .res-glow { transition: all 0.3s ease; }
        .res-tonic-glow { box-shadow: 0 0 20px var(--c-tonic); border-color: white !important; z-index: 100; }
        .res-stable-glow { box-shadow: 0 0 15px var(--c-stable); border-color: white !important; z-index: 100; }
        .res-semi-glow { box-shadow: 0 0 15px var(--c-semi); border-color: white !important; z-index: 100; }
        .res-unstable-glow { box-shadow: 0 0 15px var(--c-unstable); border-color: white !important; z-index: 100; }

        .cadence-roman { font-size: 2.4rem; font-weight: 900; letter-spacing: -0.05em; line-height: 1; color: #1e293b !important; }

        /* Estilos de Gamificaci√≥n */
        .xp-bar-bg { background: rgba(0,0,0,0.05); height: 6px; border-radius: 4px; overflow: hidden; width: 100px; }
        .dark-mode .xp-bar-bg { background: rgba(255,255,255,0.1); }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, #8b5cf6, #d946ef); width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .level-badge { background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); color: white; padding: 2px 8px; border-radius: 8px; font-size: 9px; font-weight: 900; box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3); }
        
        .menu-btn { padding: 8px; border-radius: 12px; color: #64748b; font-weight: 800; font-size: 10px; display: flex; align-items: center; gap: 4px; background: transparent; border: 1px solid transparent; text-transform: uppercase; }
        .menu-btn:hover { background: rgba(0,0,0,0.05); }

        .toggle-btn { position: relative; width: 36px; height: 20px; background: #cbd5e1; border-radius: 20px; transition: 0.3s; cursor: pointer; }
        .toggle-btn.active { background: var(--accent); }
        .toggle-thumb { position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .toggle-btn.active .toggle-thumb { transform: translateX(16px); }
        
        .log-entry { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.05); padding: 6px 0; font-size: 11px; }
        .log-date { opacity: 0.6; margin-right: 8px; }

        .report-chart-container { display: flex; justify-content: space-around; align-items: flex-end; height: 100px; padding-bottom: 5px; border-bottom: 1px solid #cbd5e1; margin-bottom: 10px; }
        .report-bar { width: 40px; background: var(--accent); border-radius: 4px 4px 0 0; transition: height 0.5s; position: relative; }
        .report-bar span { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: 800; color: var(--text-main); }
        .report-labels { display: flex; justify-content: space-around; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; }
        
        #session-time-remaining { transition: color 0.3s; }
        #session-time-remaining.warning { color: #ef4444; animation: pulse 1s infinite; }
        #phase-indicator { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 900; pointer-events: none; z-index: 100; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s; }

        .stat-card { background: #f8fafc; border: 1px solid #e2e8f0; padding: 12px; border-radius: 12px; text-align: center; }
        .dark-mode .stat-card { background: #1e293b; border-color: #334155; }
        .stat-val { font-size: 18px; font-weight: 900; color: var(--accent); }
        .stat-lbl { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #64748b; }
    </style>
</head>
<body class="select-none relative flex flex-col h-screen overflow-hidden">

    <div id="phase-indicator">FASE: MELOD√çA</div>

    <!-- Indicador de Sesi√≥n -->
    <div id="session-bar-container" class="hidden absolute top-0 left-0 w-full h-1.5 bg-black/5 z-[160]">
        <div id="session-progress" class="h-full bg-emerald-500 transition-all w-0"></div>
    </div>
    
    <header class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 p-2 sm:p-3 flex justify-between items-center z-[150]">
        <div class="flex items-center gap-3">
            <button onclick="goToMenu()" class="menu-btn dark:text-slate-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
            <div class="flex flex-col">
                <h1 class="font-black text-xs sm:text-sm tracking-tight uppercase italic text-slate-800 dark:text-white leading-none">Formar <span class="text-violet-500">O√≠do Pro</span></h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="player-level-badge" class="level-badge">NVL 1</span>
                    <div class="xp-bar-bg"><div id="xp-bar-fill" class="xp-bar-fill"></div></div>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div id="session-time-remaining" class="hidden text-[10px] font-black font-mono bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-lg text-slate-500 flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <span id="session-timer-text">00:00</span>
            </div>

            <!-- Toggle Cadencia -->
            <div class="flex flex-col items-center mr-1" onclick="toggleCadenceEnabled()">
                <span class="text-[8px] font-bold text-slate-400 uppercase mb-0.5">Cadencia</span>
                <div id="cadence-toggle" class="toggle-btn active"><div class="toggle-thumb"></div></div>
            </div>
            
            <button onclick="showReportModal()" class="p-2 bg-indigo-100 dark:bg-indigo-900/40 rounded-full text-indigo-600 hover:text-indigo-500" title="Reporte de Progreso">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            </button>

            <button onclick="showHelpModal()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 hover:text-violet-500">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </button>

            <button onclick="showStatsModal()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 hover:text-violet-500">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            </button>

            <button onclick="toggleTheme()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 2.293a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 010-1.414zm4.707 4.707a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.414A1 1 0 016.464 5l.707.707a1 1 0 01-1.414 1.414l-.707-.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z"/></svg></button>
        </div>
    </header>

    <main id="main-scroll-container" class="flex-1 relative overflow-y-auto no-scrollbar bg-gradient-to-b from-transparent to-slate-100/50 dark:to-black/20 pb-[120px]">
        <div class="p-3 sm:p-5 flex flex-col gap-4 max-w-4xl mx-auto w-full">
            
            <div id="lvl-selectors" class="space-y-4">
                <div id="lvl-mel" class="flex flex-col gap-1.5">
                    <div class="flex justify-between items-center px-1">
                        <span class="text-[9px] uppercase font-black text-slate-400 tracking-widest leading-none">Rango Mel√≥dico</span>
                        <div class="flex items-center gap-2 bg-white dark:bg-slate-800 px-2 py-1 rounded-lg border border-slate-200 dark:border-slate-700">
                            <span class="text-[8px] font-bold text-slate-500 uppercase">Notas:</span>
                            <input type="number" id="note-count-input" min="1" max="10" value="1" class="w-8 bg-transparent text-center font-bold text-xs text-violet-600 outline-none">
                        </div>
                    </div>
                    <div class="control-group grid grid-cols-3 gap-1">
                        <button onclick="setLevel('basic1')" id="lvl-basic1" class="control-btn active-choice">B√ÅSICO 1-4</button>
                        <button onclick="setLevel('basic2')" id="lvl-basic2" class="control-btn">B√ÅSICO 5-8</button>
                        <button onclick="setLevel('inter')" id="lvl-inter" class="control-btn">INTERMEDIO</button>
                        <button onclick="setLevel('adv1')" id="lvl-adv1" class="control-btn">AVANZADO I</button>
                        <button onclick="setLevel('adv2')" id="lvl-adv2" class="control-btn">AVANZADO II</button>
                        <button onclick="setLevel('total')" id="lvl-total" class="control-btn">TOTAL</button>
                    </div>
                </div>

                <div id="lvl-int" class="hidden flex flex-col gap-1.5">
                    <span class="text-[9px] uppercase font-black text-slate-400 tracking-widest pl-1">Dificultad Intervalos</span>
                    <div class="control-group grid grid-cols-6 gap-1">
                        <button onclick="setIntervalLevel(1)" id="int-lvl-1" class="control-btn active-choice">1</button>
                        <button onclick="setIntervalLevel(2)" id="int-lvl-2" class="control-btn">2</button>
                        <button onclick="setIntervalLevel(3)" id="int-lvl-3" class="control-btn">3</button>
                        <button onclick="setIntervalLevel(4)" id="int-lvl-4" class="control-btn">4</button>
                        <button onclick="setIntervalLevel(5)" id="int-lvl-5" class="control-btn">5</button>
                        <button onclick="setIntervalLevel(6)" id="int-lvl-6" class="control-btn">6</button>
                    </div>
                </div>

                <div id="lvl-har" class="hidden flex flex-col gap-1.5">
                    <span class="text-[9px] uppercase font-black text-slate-400 tracking-widest pl-1">Complejidad Arm√≥nica</span>
                    <div class="control-group grid grid-cols-3 gap-1">
                        <button onclick="setHarmonyLevel('basic')" id="har-lvl-basic" class="control-btn active-choice">B√ÅSICO</button>
                        <button onclick="setHarmonyLevel('inter')" id="har-lvl-inter" class="control-btn">INTERMEDIO</button>
                        <button onclick="setHarmonyLevel('expert')" id="har-lvl-expert" class="control-btn">EXPERTO</button>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-2">
                <div class="control-group grid grid-cols-3 gap-1">
                    <button onclick="setTonalityMode('major')" id="ton-major" class="control-btn active-choice">MAYOR</button>
                    <button onclick="setTonalityMode('minor')" id="ton-minor" class="control-btn">MENOR</button>
                    <button onclick="setTonalityMode('combined')" id="ton-combined" class="control-btn">MIXTO</button>
                </div>
                <div class="control-group grid grid-cols-3 gap-1" id="main-mode-group">
                    <button onclick="setGlobalMode('melody')" id="mode-mel-btn" class="control-btn active-choice py-2 font-black">MELOD√çA</button>
                    <button onclick="setGlobalMode('interval')" id="mode-int-btn" class="control-btn py-2 font-black">INTERVALO</button>
                    <button onclick="setGlobalMode('harmony')" id="mode-har-btn" class="control-btn py-2 font-black">ARMON√çA</button>
                </div>
            </div>

            <div class="flex gap-2 items-center justify-between">
                <div class="flex items-center gap-2">
                    <div id="key-badge" class="compact-badge border-2 shadow-sm">
                        <span id="key-root" class="text-sm font-black text-violet-500 leading-none">C</span>
                        <span id="key-quality-label" class="text-[7px] font-bold opacity-60 uppercase leading-none">MAYOR</span>
                    </div>
                    <button onclick="playCadence()" class="w-10 h-10 rounded-xl bg-violet-100 dark:bg-violet-900/40 text-violet-600 dark:text-violet-400 flex items-center justify-center border border-violet-200 dark:border-violet-800 shadow-sm active:scale-95 transition-transform" title="O√≠r Tonalidad (C)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>
                    </button>
                </div>
                <div class="flex-1 flex gap-3 items-center justify-center bg-slate-100/50 dark:bg-black/20 p-2 rounded-2xl border border-slate-200/30">
                    <div id="buffer-dots" class="buffer-indicator"></div>
                    <button id="btn-delete-note" onclick="deleteLastNote()" class="btn-delete hidden shadow-sm"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg></button>
                </div>
            </div>
            
            <div id="practice-chips" class="flex flex-wrap justify-center gap-3 py-2"></div>
            <div id="interval-grid" class="hidden grid grid-cols-2 gap-2"></div>
            <div id="harmony-grid" class="hidden grid grid-cols-2 gap-2"></div>
        </div>
    </main>

    <!-- Resume Modal -->
    <div id="resume-modal" class="modal">
        <div class="modal-content text-center max-w-sm">
            <h2 class="text-xl font-black mb-4 uppercase text-slate-800 dark:text-white">Sesi√≥n Pausada</h2>
            <p class="mb-6 text-sm text-slate-600 dark:text-slate-400 font-bold">Tienes una sesi√≥n diaria sin terminar. ¬øQuieres continuar?</p>
            <div class="flex gap-3">
                <button onclick="resumeSession()" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-black uppercase text-xs shadow-lg hover:bg-emerald-600">Continuar</button>
                <button onclick="confirmCancelSession()" class="flex-1 py-3 bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-300 rounded-xl font-black uppercase text-xs hover:bg-slate-300 dark:hover:bg-slate-600">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Confirm Cancel Modal -->
    <div id="confirm-cancel-modal" class="modal">
        <div class="modal-content text-center max-w-sm">
            <h2 class="text-xl font-black mb-4 uppercase text-rose-500">¬øEst√°s seguro?</h2>
            <p class="mb-6 text-sm text-slate-600 dark:text-slate-400">Perder√°s el progreso de esta sesi√≥n.</p>
            <div class="flex gap-3">
                <button onclick="cancelSession()" class="flex-1 py-3 bg-rose-500 text-white rounded-xl font-black uppercase text-xs shadow-lg hover:bg-rose-600">S√≠, Salir</button>
                <button onclick="closeConfirmCancel()" class="flex-1 py-3 bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-300 rounded-xl font-black uppercase text-xs hover:bg-slate-300 dark:hover:bg-slate-600">No, Volver</button>
            </div>
        </div>
    </div>

    <div id="start-modal" class="modal" style="display: flex;">
        <div class="modal-content text-center">
            <h2 class="text-2xl font-black mb-4 uppercase">Entrenamiento Auditivo</h2>
            <div id="streak-indicator" class="mb-6 inline-block bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 px-4 py-2 rounded-2xl font-bold">Racha: 0 D√≠as üî•</div>
            <div id="start-main-view" class="space-y-4">
                <button onclick="selectGameMode('free')" class="w-full py-4 bg-violet-600 text-white rounded-2xl font-black uppercase hover:bg-violet-700 shadow-lg">Pr√°ctica Libre</button>
                <button onclick="showDailyOptions()" class="w-full py-4 bg-emerald-600 text-white rounded-2xl font-black uppercase hover:bg-emerald-700 shadow-lg">Sesi√≥n Diaria</button>
            </div>
            <div id="start-daily-view" class="hidden space-y-4">
                <button onclick="selectGameMode('daily', 300)" class="w-full py-4 bg-slate-100 dark:bg-slate-800 rounded-2xl font-bold flex flex-col items-center">
                    <span>5 Minutos</span>
                    <span class="text-[10px] opacity-50 uppercase">R√°pido y efectivo</span>
                </button>
                <button onclick="selectGameMode('daily', 1200)" class="w-full py-4 bg-slate-100 dark:bg-slate-800 rounded-2xl font-bold flex flex-col items-center">
                    <span>20 Minutos</span>
                    <span class="text-[10px] opacity-50 uppercase">Sesi√≥n Profunda</span>
                </button>
                <button onclick="backToMainStart()" class="text-xs font-bold text-slate-400 uppercase mt-4">Volver</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="modal">
        <div id="report-content-capture" class="modal-content w-full max-w-2xl bg-white dark:bg-slate-900">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black uppercase text-slate-800 dark:text-white tracking-tight">Evaluaci√≥n de Progreso</h2>
                <button onclick="closeReportModal()" class="text-slate-400 hover:text-slate-600 font-bold text-xs uppercase">Cerrar</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Gr√°fico de Barras -->
                <div class="bg-slate-50 dark:bg-slate-800/50 rounded-2xl p-5 border border-slate-100 dark:border-slate-800">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Rendimiento por Habilidad</p>
                    <div class="report-chart-container mt-2" style="height: 120px;">
                        <div class="report-bar" id="rep-bar-mel"><span id="rep-val-mel">0%</span></div>
                        <div class="report-bar bg-blue-500" id="rep-bar-int"><span id="rep-val-int">0%</span></div>
                        <div class="report-bar bg-pink-500" id="rep-bar-har"><span id="rep-val-har">0%</span></div>
                    </div>
                    <div class="report-labels mt-2">
                        <div>Melod√≠a</div><div>Intervalos</div><div>Armon√≠a</div>
                    </div>
                </div>

                <!-- An√°lisis Detallado -->
                <div class="space-y-3">
                    <div class="bg-emerald-50 dark:bg-emerald-900/10 p-4 rounded-xl border-l-4 border-emerald-500">
                        <h4 class="font-black text-emerald-700 dark:text-emerald-400 text-xs uppercase mb-1">Fortalezas Principales</h4>
                        <p id="rep-strengths" class="text-sm font-medium text-slate-700 dark:text-slate-300">Sigue practicando para detectar patrones.</p>
                    </div>
                    <div class="bg-rose-50 dark:bg-rose-900/10 p-4 rounded-xl border-l-4 border-rose-500">
                        <h4 class="font-black text-rose-700 dark:text-rose-400 text-xs uppercase mb-1">√Åreas de Mejora</h4>
                        <p id="rep-weaknesses" class="text-sm font-medium text-slate-700 dark:text-slate-300">Identificando puntos d√©biles...</p>
                    </div>
                    <!-- Diagn√≥stico Pedag√≥gico -->
                    <div id="rep-diagnosis" class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl text-xs text-slate-600 dark:text-slate-300 italic border border-blue-100 dark:border-blue-800">
                        El entrenador est√° analizando tu estilo de aprendizaje...
                    </div>
                </div>
            </div>

            <!-- Niveles -->
            <div class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl mb-6 flex justify-between items-center">
                <div class="text-center">
                    <span class="block text-[10px] font-bold text-slate-400 uppercase">Melod√≠a</span>
                    <span id="lvl-txt-mel" class="font-black text-violet-500 text-lg">B√°sico</span>
                </div>
                <div class="w-px h-8 bg-slate-300 dark:bg-slate-600"></div>
                <div class="text-center">
                    <span class="block text-[10px] font-bold text-slate-400 uppercase">Intervalos</span>
                    <span id="lvl-txt-int" class="font-black text-blue-500 text-lg">Nivel 1</span>
                </div>
                <div class="w-px h-8 bg-slate-300 dark:bg-slate-600"></div>
                <div class="text-center">
                    <span class="block text-[10px] font-bold text-slate-400 uppercase">Armon√≠a</span>
                    <span id="lvl-txt-har" class="font-black text-pink-500 text-lg">B√°sico</span>
                </div>
            </div>

            <button onclick="downloadReport()" class="w-full py-4 bg-slate-900 text-white dark:bg-white dark:text-slate-900 rounded-xl font-black uppercase text-xs shadow-xl hover:scale-[1.01] transition-transform flex items-center justify-center gap-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                Guardar Reporte Completo
            </button>
        </div>
    </div>

    <!-- Help Modal (Expandido) -->
    <div id="help-modal" class="modal">
        <div class="modal-content max-w-2xl max-h-[85vh] overflow-y-auto custom-scroll">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black uppercase text-slate-800 dark:text-white">Manual de Entrenamiento</h2>
                <button onclick="closeHelpModal()" class="text-slate-400 hover:text-slate-600 font-bold text-xs uppercase">Cerrar</button>
            </div>
            
            <div class="space-y-8 text-sm text-slate-600 dark:text-slate-300">
                <section>
                    <h3 class="flex items-center gap-2 text-lg font-black text-violet-600 dark:text-violet-400 mb-3">
                        <span class="bg-violet-100 dark:bg-violet-900 p-1 rounded">üß†</span> Metodolog√≠a
                    </h3>
                    <p class="mb-3">Esta aplicaci√≥n utiliza el principio de <b>"Repetici√≥n Espaciada y Dificultad Adaptativa"</b>. No se trata solo de adivinar notas, sino de internalizar su funci√≥n tonal.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border-l-4 border-slate-300">
                            <h4 class="font-bold text-slate-900 dark:text-white mb-1">Modo Libre</h4>
                            <p class="text-xs leading-relaxed">Control total sobre los par√°metros. Ideal para atacar debilidades espec√≠ficas identificadas en tu reporte (ej. "siempre fallo la 6ta menor").</p>
                        </div>
                        <div class="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-xl border-l-4 border-emerald-500">
                            <h4 class="font-bold text-emerald-800 dark:text-emerald-300 mb-1">Sesi√≥n Diaria (Recomendado)</h4>
                            <p class="text-xs leading-relaxed">Un "workout" completo de 5 o 20 minutos que rota autom√°ticamente entre melod√≠a, intervalos y armon√≠a para evitar la fatiga auditiva.</p>
                        </div>
                    </div>
                </section>

                <section>
                    <h3 class="flex items-center gap-2 text-lg font-black text-blue-600 dark:text-blue-400 mb-3">
                        <span class="bg-blue-100 dark:bg-blue-900 p-1 rounded">üìà</span> Progresi√≥n Mel√≥dica
                    </h3>
                    <p class="mb-3">El dictado mel√≥dico sigue reglas estrictas para garantizar un aprendizaje s√≥lido:</p>
                    <ul class="list-disc pl-5 space-y-2 marker:text-blue-500">
                        <li><b>Nivel B√°sico (1-2):</b> La cantidad de notas es <b>FIJA (1 nota)</b>. El objetivo es dominar los grados individuales antes de conectarlos.</li>
                        <li><b>Nivel Intermedio:</b> Se activa la <b>"Escalera Progresiva"</b>. Empiezas con 2 notas. Si aciertas, subes a 3. Si fallas, bajas. Esto te mantiene siempre en el l√≠mite de tu capacidad.</li>
                        <li><b>Nivel Avanzado:</b> Secuencias largas (3-5 notas) y mayor cromatismo.</li>
                    </ul>
                </section>

                <section>
                    <h3 class="flex items-center gap-2 text-lg font-black text-pink-600 dark:text-pink-400 mb-3">
                        <span class="bg-pink-100 dark:bg-pink-900 p-1 rounded">‚å®Ô∏è</span> Atajos de Teclado
                    </h3>
                    <div class="grid grid-cols-3 gap-3 font-mono text-xs">
                        <div class="bg-slate-100 dark:bg-slate-800 p-3 rounded-xl text-center border border-slate-200 dark:border-slate-700">
                            <div class="font-black text-lg mb-1">ESPACIO</div>
                            <span class="opacity-60 uppercase font-bold">Repetir Sonido</span>
                        </div>
                        <div class="bg-slate-100 dark:bg-slate-800 p-3 rounded-xl text-center border border-slate-200 dark:border-slate-700">
                            <div class="font-black text-lg mb-1">TECLA C</div>
                            <span class="opacity-60 uppercase font-bold">O√≠r Tonalidad</span>
                        </div>
                        <div class="bg-slate-100 dark:bg-slate-800 p-3 rounded-xl text-center border border-slate-200 dark:border-slate-700">
                            <div class="font-black text-lg mb-1">ENTER</div>
                            <span class="opacity-60 uppercase font-bold">Continuar</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Stats Modal (Perfil Expandido) -->
    <div id="stats-modal" class="modal">
        <div class="modal-content w-full max-w-lg bg-white dark:bg-slate-900">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black uppercase text-slate-800 dark:text-white tracking-tight">Perfil de Usuario</h2>
                <button onclick="closeStatsModal()" class="text-slate-400 font-bold text-xs uppercase hover:text-slate-600">Cerrar</button>
            </div>
            
            <div class="mb-6">
                <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Identidad</label>
                <div class="flex gap-2">
                     <div class="w-12 h-12 rounded-full bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center text-white font-black text-xl shadow-lg">
                        <span id="profile-initial">?</span>
                     </div>
                     <input type="text" id="user-name-input" onchange="updateUserName(this.value)" class="flex-1 p-3 text-lg font-bold rounded-xl border-2 border-slate-100 dark:bg-slate-800 dark:border-slate-700 focus:border-violet-500 focus:ring-0 transition-all outline-none" placeholder="Escribe tu nombre aqu√≠...">
                </div>
            </div>

            <!-- M√©tricas Globales -->
            <div class="grid grid-cols-3 gap-3 mb-6">
                <div class="stat-card">
                    <div class="stat-val" id="total-time-val">0h</div>
                    <div class="stat-lbl">Tiempo Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val text-emerald-500" id="total-xp-val">0</div>
                    <div class="stat-lbl">XP Acumulado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val text-orange-500" id="best-streak-val">0</div>
                    <div class="stat-lbl">Mejor Racha</div>
                </div>
            </div>

            <div class="mb-6">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Gesti√≥n de Datos</p>
                <div class="flex gap-3">
                    <button onclick="exportData()" class="flex-1 py-3 bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-300 rounded-xl text-xs font-black uppercase border border-blue-100 dark:border-blue-800/50 hover:bg-blue-100 transition-colors flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Exportar Backup
                    </button>
                    <button onclick="document.getElementById('import-file').click()" class="flex-1 py-3 bg-emerald-50 text-emerald-600 dark:bg-emerald-900/20 dark:text-emerald-300 rounded-xl text-xs font-black uppercase border border-emerald-100 dark:border-emerald-800/50 hover:bg-emerald-100 transition-colors flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                        Importar Datos
                    </button>
                    <input type="file" id="import-file" style="display:none" onchange="importData(this)">
                </div>
            </div>

            <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl max-h-48 overflow-y-auto custom-scroll border border-slate-100 dark:border-slate-700">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-3 sticky top-0 bg-slate-50 dark:bg-slate-800/90 backdrop-blur-sm pb-2 border-b border-slate-200 dark:border-slate-700 z-10 flex justify-between">
                    <span>Historial de Sesiones</span>
                    <span>Duraci√≥n</span>
                </p>
                <ul id="usage-log-list" class="space-y-2"></ul>
            </div>
        </div>
    </div>

    <!-- Modal Level Up & Cadence & Result (mismo c√≥digo) -->
    <div id="levelup-modal" class="modal" style="display:none"><div class="modal-content text-center py-10"><h2 class="text-3xl font-black text-orange-500">¬°Nivel!</h2><button onclick="closeLevelUp()">OK</button></div></div>
    <div id="cadence-modal" class="modal"><div class="modal-content text-center py-14"><p class="text-xs font-black uppercase animate-pulse">Tonalidad</p><div id="cadence-display" class="flex justify-center gap-4"></div></div></div>
    <div id="result-modal" class="modal"><div class="modal-content text-center p-8"><div id="result-icon" class="text-5xl mb-4"></div><h2 id="result-title" class="text-2xl font-black mb-2"></h2><div id="harmony-result-detail" class="hidden"><div class="res-card"><p>Romano</p><div id="res-roman"></div></div></div><div id="res-info-cont" class="res-card res-card-accent mb-4"><p id="result-user-info"></p></div><div id="correct-block" class="hidden res-card border-emerald-500 border-2"><p>Correcto:</p><div id="result-correct"></div></div><div class="flex gap-2 mt-4"><button onclick="playTargetSound()" class="flex-1 py-3 bg-violet-100 text-violet-600 rounded-xl font-bold text-xs">Correcta</button><button onclick="playUserResponse()" id="btn-play-user" class="hidden flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold text-xs">Mi Respuesta</button></div><button onclick="handleContinue()" class="mt-4 w-full py-4 bg-slate-800 text-white rounded-xl font-bold text-xs">Continuar</button></div></div>

    <div class="fixed bottom-0 left-0 w-full z-[200] bottom-dock">
        <div class="piano-viewport no-scrollbar"><div id="piano-stage" class="piano-stage"></div></div>
        <div class="flex items-center justify-between px-3 py-3 gap-2 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm">
            <button onclick="toggleMixer()" class="dock-btn w-12 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 shadow-sm"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg></button>
            <button id="btn-repeat-sound" onclick="repeatTargetSound()" class="dock-btn w-12 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 shadow-sm" title="Repetir"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg></button>
            <button id="btn-init" onclick="startGame()" class="dock-btn btn-main-action flex-1 ml-2"><span class="text-sm font-black uppercase tracking-tighter">Nueva Pregunta</span></button>
        </div>
    </div>

    <div id="mixer-panel" class="hidden absolute bottom-[180px] left-4 bg-white dark:bg-slate-850 p-5 rounded-3xl border-2 border-slate-200 dark:border-slate-700 shadow-2xl z-[300] flex flex-col gap-4 w-48">
        <div class="flex flex-col gap-1.5"><label class="text-[9px] font-black uppercase text-slate-500">Vol. Bajo</label><input type="range" min="0" max="1" step="0.1" value="0.5" id="vol-bass" class="accent-violet-500"></div>
        <div class="flex flex-col gap-1.5"><label class="text-[9px] font-black uppercase text-slate-500">Vol. Pregunta</label><input type="range" min="0" max="1" step="0.1" value="0.4" id="vol-question" class="accent-violet-500"></div>
    </div>

    <script>
        // --- CONFIGURACI√ìN & CONSTANTES ---
        const DEGREES = ['1', 'b2', '2', 'b3', '3', '4', '#4', '5', 'b6', '6', 'b7', '7', '8'];
        const ROOT_INDICES = { 'C': 0, 'Db': 1, 'C#': 1, 'D': 2, 'Eb': 3, 'E': 4, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'Ab': 8, 'G#': 8, 'A': 9, 'Bb': 10, 'B': 11 };
        
        // RESOLUCIONES MEL√ìDICAS CORREGIDAS
        // 4 (3): 3 -> 2 -> 1
        // 5 (4): 4 -> 3 -> 2 -> 1
        const RESOLUTIONS = {
            0: [0, -5, 0],
            1: [1, 0],
            2: [2, 0],
            3: [3, 2, 0],
            4: [4, 2, 0], // III -> II -> I (Corregido)
            5: [5, 4, 2, 0], // IV -> III -> II -> I
            6: [[6, 7, 12], [6, 7, 4, 0]], 
            7: [[7, 12], [7, 4, 0]], 
            8: [8, 7, 12], 
            9: [9, 7, 12], 
            10: [10, 11, 12], 
            11: [11, 12], 
            12: [12, 7, 12]
        };

        const INTERVAL_NAMES = { 0: "Un√≠sono", 1: "2da m", 2: "2da M", 3: "3ra m", 4: "3ra M", 5: "4ta J", 6: "Tritono", 7: "5ta J", 8: "6ta m", 9: "6ta M", 10: "7ma m", 11: "7ma M", 12: "8va J" };
        const INTERVAL_LEVELS = { 1: [0, 5, 7, 12], 2: [0, 1, 2, 5, 7, 12], 3: [0, 1, 2, 3, 4, 5, 7, 12], 4: [0, 1, 2, 3, 4, 5, 6, 7, 12], 5: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 12], 6: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12] };
        const HARMONY_LEVELS = { 'basic': { 'major': ["I - IV - V - I", "I - V - I"], 'minor': ["i - iv - V - i", "i - V - i"] }, 'inter': { 'major': ["I - IV - V - I", "ii - V - I", "I - vi - ii - V"], 'minor': ["i - iv - V - i", "ii¬∞ - V - i", "i - bVI - V - i"] }, 'expert': { 'major': ["I - IV7 - V7 - I", "ii7 - V7 - I", "I - vi - ii7 - V7", "I - bVI - V7 - I", "I - V/V - V - I"], 'minor': ["i - iv7 - V7 - i", "ii¬∞7 - V7 - i", "i - bVI - V7", "i - IV7 - V7 - i"] } };
        const HARMONY_CHORD_MAP = { 'I':0, 'ii':2, 'iii':4, 'IV':5, 'V':7, 'vi':9, 'vii¬∞':11, 'i':0, 'ii¬∞':2, 'iv':5, 'bVI':8, 'bVII':10, 'V/V':2 };
        const LEVEL_TITLES = ["Novato", "Aprendiz", "Aficionado", "Estudiante", "M√∫sico", "Virtuoso", "Maestro", "O√≠do Absoluto"];
        const SCALES = { 'C_major': ['C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B'], 'G_major': ['G','G#','A','Bb','B','C','C#','D','Eb','E','F','F#'], 'D_major': ['D','D#','E','F','F#','G','G#','A','Bb','B','C','C#'], 'A_major': ['A','A#','B','C','C#','D','D#','E','F','F#','G','G#'], 'E_major': ['E','E#','F#','G','G#','A','A#','B','C','C#','D','D#'], 'B_major': ['B','C','C#','D','D#','E','E#','F#','G','G#','A','A#'], 'F_major': ['F','Gb','G','Ab','A','Bb','B','C','Db','D','Eb','E'], 'Bb_major': ['Bb','Cb','C','Db','D','Eb','E','F','Gb','G','Ab','A'], 'Eb_major': ['Eb','Fb','F','Gb','G','Ab','A','Bb','Cb','C','Db','D'], 'Ab_major': ['Ab','Bbb','Bb','Cb','C','Db','D','Eb','Fb','F','Gb','G'], 'A_minor': ['A','Bb','B','C','C#','D','Eb','E','F','F#','G','G#'], 'E_minor': ['E','F','F#','G','G#','A','Bb','B','C','C#','D','D#'], 'B_minor': ['B','C','C#','D','D#','E','E#','F#','G','G#','A','A#'], 'F#_minor': ['F#','G','G#','A','A#','B','C','C#','D','D#','E','E#'], 'C#_minor': ['C#','D','D#','E','E#','F#','G','G#','A','A#','B','B#'], 'G#_minor': ['G#','A','A#','B','B#','C#','D','D#','E','E#','F#','F##'], 'D_minor': ['D','Eb','E','F','F#','G','Ab','A','Bb','B','C','C#'], 'G_minor': ['G','Ab','A','Bb','B','C','Db','D','Eb','E','F','F#'], 'C_minor': ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'], 'F_minor': ['F','Gb','G','Ab','A','Bb','Cb','C','Db','D','Eb','E'] };
        const KEY_RELATIVES = { 'C': {'major': 'C_major', 'minor': 'A_minor'}, 'G': {'major': 'G_major', 'minor': 'E_minor'}, 'D': {'major': 'D_major', 'minor': 'B_minor'}, 'A': {'major': 'A_major', 'minor': 'F#_minor'}, 'E': {'major': 'E_major', 'minor': 'C#_minor'}, 'B': {'major': 'B_major', 'minor': 'G#_minor'}, 'F': {'major': 'F_major', 'minor': 'D_minor'}, 'Bb': {'major': 'Bb_major', 'minor': 'G_minor'}, 'Eb': {'major': 'Eb_major', 'minor': 'C_minor'}, 'Ab': {'major': 'Ab_major', 'minor': 'F_minor'} };

        // --- ESTADO GLOBAL ---
        let audioCtx;
        const state = { 
            level:'basic1', intervalLevel: 1, harmonyLevel: 'basic', tonalityMode:'major', 
            currentRoundTonality:'major', mode:'melody', keyIndex:48, keyLabel:'C', score:0, 
            streak: 0, playerLevel: 1, xp: 0, userBuffer:[], lastWrongAnswer: null, isPlaying:false, target:null, 
            activeOscillators: [], timeouts: [], cadenceType: 0, firstFreeLoad: true, currentCadenceProg: null,
            playCadenceEnabled: true, stats: { melody: {t:0, c:0}, interval: {t:0, c:0}, harmony: {t:0, c:0}, mistakes: {} },
            skillLevels: { melody: 0, interval: 0, harmony: 0 },
            userName: 'Invitado', usageLog: [] 
        };

        let sessionStart = Date.now();
        const sessionState = { active: false, type: 'free', totalDuration: 0, timeLeft: 0, timerId: null };

        // --- AUDIO ENGINE ---
        function initAudio() {
            if(!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                state.masterOut = audioCtx.createDynamicsCompressor();
                state.masterOut.connect(audioCtx.destination);
            }
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playPianoTone(freq, dur, start=0, vol=0.3) {
            if(!audioCtx) return;
            const t = start + audioCtx.currentTime;
            const createOsc = (type, freqVal, gainVal) => {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freqVal, t);
                g.gain.setValueAtTime(0, t);
                g.gain.linearRampToValueAtTime(gainVal, t + 0.01);
                g.gain.exponentialRampToValueAtTime(gainVal * 0.6, t + 0.1);
                g.gain.exponentialRampToValueAtTime(0.001, t + dur);
                osc.connect(g); g.connect(state.masterOut); osc.start(t); osc.stop(t + dur + 0.1);
                state.activeOscillators.push(osc);
            };
            createOsc('triangle', freq, vol); createOsc('sine', freq, vol * 0.5); createOsc('sine', freq * 2, vol * 0.1);
        }

        function playTone(freq, dur, type='triangle', start=0, vol=0.2) { playPianoTone(freq, dur, start, vol); }
        function stopAllSounds() { state.activeOscillators.forEach(osc => { try { osc.stop(); } catch(e) {} }); state.activeOscillators = []; state.timeouts.forEach(clearTimeout); state.timeouts = []; state.isPlaying = false; }
        function midiToFreq(m) { return 440 * Math.pow(2, (m - 69) / 12); }
        function getNoteName(rootName, semitones) { const mapKey = KEY_RELATIVES[rootName]?.[state.currentRoundTonality] || 'C_major'; const scale = SCALES[mapKey] || SCALES['C_major']; return scale[semitones % 12] || "N/A"; }
        function getFunctionalClass(idx, tonality) { if (idx === 0 || idx === 12) return 'tonic'; if (tonality === 'major') { if (idx === 4 || idx === 7) return 'stable'; if ([2, 5, 9, 11].includes(idx)) return 'semi'; } else { if (idx === 3 || idx === 7) return 'stable'; if ([2, 5, 8, 10].includes(idx)) return 'semi'; } return 'unstable'; }
        function getAmericanChord(roman, key, tonality) { const rootIdx = HARMONY_CHORD_MAP[roman.replace('7', '').replace('¬∞', '')] || 0; const note = getNoteName(key, rootIdx); const quality = (roman === roman.toLowerCase()) ? "m" : ""; const extra = roman.includes('¬∞') ? "dim" : (roman.includes('7') ? "7" : ""); return note + quality + extra; }

        // --- GAME LOGIC ---
        function startGame() { 
            initAudio(); stopAllSounds();
            const keys = ['C','G','D','A','E','B','F','Bb','Eb','Ab'];
            state.keyLabel = keys[Math.floor(Math.random()*keys.length)];
            state.keyIndex = 48 + (ROOT_INDICES[state.keyLabel] || 0);
            state.currentRoundTonality = state.tonalityMode === 'combined' ? (Math.random() > 0.5 ? 'major' : 'minor') : state.tonalityMode;
            
            const kr = document.getElementById('key-root'); if(kr) kr.innerText = state.keyLabel;
            const kq = document.getElementById('key-quality-label'); if(kq) kq.innerText = state.currentRoundTonality.toUpperCase();
            
            state.currentCadenceProg = [[0, 5, 7, 12], [2, 7, 12], [0, 9, 2, 7, 12]][state.cadenceType % 3];
            state.cadenceType++;

            // MODO DIARIO: FASES
            if(sessionState.active && sessionState.type === 'daily') {
                const total = sessionState.totalDuration;
                const remaining = sessionState.timeLeft;
                const elapsed = total - remaining;
                
                let phaseName = "";
                if(elapsed < total * 0.33) { setGlobalMode('melody'); phaseName = "FASE: MELOD√çA"; }
                else if(elapsed < total * 0.66) { setGlobalMode('interval'); phaseName = "FASE: INTERVALOS"; }
                else { setGlobalMode('harmony'); phaseName = "FASE: ARMON√çA"; }
                
                const pi = document.getElementById('phase-indicator');
                if(pi) { pi.innerText = phaseName; pi.style.opacity = '1'; }
            } else {
                const pi = document.getElementById('phase-indicator');
                if(pi) pi.style.opacity = '0';
            }

            resetUI();
            if (state.playCadenceEnabled) playCadence(() => generateQuestion()); else generateQuestion();
        }

        function playCadence(cb) {
            state.isPlaying = true;
            const cadenceModal = document.getElementById('cadence-modal');
            const display = document.getElementById('cadence-display');
            if(display) display.innerHTML = '';
            if(cadenceModal) cadenceModal.style.display = 'flex';
            
            const currentProg = state.currentCadenceProg || [0, 5, 7, 12];
            let t = 0;
            const romanMap = { 0:'I', 2:'ii', 4:'iii', 5:'IV', 7:'V', 9:'vi', 11:'vii¬∞', 12:'I' };
            currentProg.forEach((deg, i) => {
                const chordName = romanMap[deg] || 'I';
                const div = document.createElement('div');
                div.className = 'chord-box';
                div.innerHTML = `<span class="cadence-roman">${state.currentRoundTonality === 'minor' ? chordName.toLowerCase() : chordName}</span>`;
                if(display) display.appendChild(div);
                state.timeouts.push(setTimeout(() => div.classList.add('active'), t * 1000));
                
                let bassNote = state.keyIndex + deg - 12;
                if (i > 0 && currentProg[i-1] === 7 && deg === 12) bassNote = state.keyIndex; else if (deg === 12) bassNote = state.keyIndex;
                playPianoTone(midiToFreq(bassNote), 1.0, t, 0.45);
                // Simple triad
                [deg, deg+(state.currentRoundTonality==='minor'?3:4), deg+7].forEach(n => playPianoTone(midiToFreq(state.keyIndex+n-12), 0.9, t, 0.2));
                t += 0.9;
            });
            state.timeouts.push(setTimeout(() => { 
                if(cadenceModal) cadenceModal.style.display = 'none'; 
                state.isPlaying = false; if(cb) cb(); 
            }, (t + 0.3) * 1000));
        }

        function generateQuestion() {
            state.userBuffer = []; const vQ = 0.4;
            
            if(state.mode === 'melody') {
                let count = 1;
                const countInput = document.getElementById('note-count-input');
                
                // SOLO EN INTERMEDIO ES PROGRESIVO
                if (state.level === 'inter' || (sessionState.type === 'daily' && state.skillLevels.melody >= 2 && state.skillLevels.melody < 4)) {
                    count = parseInt(countInput?.value || 1); 
                } else {
                    // Valores fijos
                    count = 1; 
                    if (state.level === 'adv1') count = 3;
                    if (state.level === 'adv2') count = 4;
                    if (state.level === 'total') count = 5;
                    // basic1 y basic2 se quedan en 1
                    if(countInput) countInput.value = count;
                }

                const possible = getMelodicPossibleIntervals();
                const sequence = [];
                for(let i=0; i<count; i++) sequence.push({ interval: possible[Math.floor(Math.random()*possible.length)], midi: 0 });
                sequence.forEach(s => s.midi = state.keyIndex + s.interval);
                state.target = { type: 'melody', sequence };
                renderBufferDots(count);
                playTargetSound();
            } else if(state.mode === 'interval') {
                const levels = INTERVAL_LEVELS[state.intervalLevel];
                const int = levels[Math.floor(Math.random()*levels.length)];
                const m1 = state.keyIndex + (state.currentRoundTonality === 'major' ? [0,2,4,5,7,9,11] : [0,2,3,5,7,8,10])[Math.floor(Math.random()*7)];
                const style = ['ascending', 'descending', 'harmonic'][Math.floor(Math.random()*3)];
                state.target = { type: 'interval', answer: INTERVAL_NAMES[int], m1, m2: m1+int, style };
                renderIntervalOptions([INTERVAL_NAMES[int], ...Object.values(INTERVAL_NAMES).filter(v=>v!==INTERVAL_NAMES[int]).sort(()=>0.5-Math.random()).slice(0,3)].sort());
                playTargetSound();
            } else {
                const list = HARMONY_LEVELS[state.harmonyLevel][state.currentRoundTonality];
                const prog = list[Math.floor(Math.random()*list.length)];
                state.target = { type: 'harmony', answer: prog };
                const opts = [prog, ...list.filter(p=>p!==prog).sort(()=>0.5-Math.random()).slice(0,3)].sort();
                renderHarmonyOptions(opts);
                playTargetSound();
            }
        }

        function playTargetSound() {
            if(!state.target) return; const vQ = 0.4;
            if(state.mode === 'interval') {
                const { m1, m2, style } = state.target;
                if(style === 'harmonic') { playTone(midiToFreq(m1), 1.5, 'triangle', 0, vQ); playTone(midiToFreq(m2), 1.5, 'triangle', 0, vQ); }
                else if(style === 'descending') { playTone(midiToFreq(m2>m1?m2:m1), 0.8, 'triangle', 0, vQ); playTone(midiToFreq(m2>m1?m1:m2), 1.2, 'triangle', 0.8, vQ); }
                else { playTone(midiToFreq(m1<m2?m1:m2), 0.8, 'triangle', 0, vQ); playTone(midiToFreq(m1<m2?m2:m1), 1.2, 'triangle', 0.8, vQ); }
            } else if(state.mode === 'harmony') {
                let t = 0;
                state.target.answer.split(' - ').forEach(c => {
                    const deg = HARMONY_CHORD_MAP[c.replace('7','').replace('¬∞','')] || 0;
                    playTone(midiToFreq(state.keyIndex+deg-12), 1.0, 'sine', t, 0.4);
                    // Simple voicing
                    [deg, deg+(state.currentRoundTonality==='minor'?3:4), deg+7].forEach(n=>playTone(midiToFreq(state.keyIndex+n), 1.0, 'triangle', t, 0.1));
                    t += 1.0;
                });
            } else {
                let t = 0; state.target.sequence.forEach(s => { playTone(midiToFreq(s.midi), 0.8, 'triangle', t, vQ); t += 0.7; });
            }
        }

        function checkAnswer(val) {
            if(!state.target || state.isPlaying) return;
            let ok = false;
            if(state.mode === 'melody') {
                state.userBuffer.push(val);
                const dots = document.querySelectorAll('.buffer-dot');
                if(dots[state.userBuffer.length-1]) dots[state.userBuffer.length-1].classList.add('active');
                
                const btnDel = document.getElementById('btn-delete-note');
                if(btnDel) btnDel.classList.remove('hidden');

                if(state.userBuffer.length === state.target.sequence.length) {
                    ok = state.userBuffer.every((v,i) => v === state.target.sequence[i].interval);
                    state.lastWrongAnswer = [...state.userBuffer];
                    
                    const countInput = document.getElementById('note-count-input');
                    // PROGRESI√ìN SOLO SI EST√Å EN INTERMEDIO
                    if (state.level === 'inter') {
                        let currentCount = parseInt(countInput.value);
                        if(ok) {
                            if(currentCount < 8) countInput.value = currentCount + 1; 
                            adjustSkill('melody', 0.1); 
                        } else {
                            if(currentCount > 1) countInput.value = currentCount - 1; 
                            adjustSkill('melody', -0.05);
                        }
                    } else if (ok) {
                        adjustSkill('melody', 0.1);
                    }
                    
                    showResult(ok, state.userBuffer.map(s => DEGREES[s]).join('-'), state.target.sequence.map(s => DEGREES[s.interval]).join('-'));
                }
            } else {
                state.lastWrongAnswer = val;
                ok = val === state.target.answer;
                if(ok) adjustSkill(state.mode, 0.1); else adjustSkill(state.mode, -0.05);
                showResult(ok, val, state.target.answer);
            }
            if(ok) { trackStat(state.mode, null, true); addXP(10); } else { trackStat(state.mode, state.target.answer || 'Error', false); }
        }

        function adjustSkill(mode, amount) {
            state.skillLevels[mode] = Math.max(0, Math.min(5, (state.skillLevels[mode] || 0) + amount));
            if(sessionState.active) optimizeSessionConfig(); 
            saveProgress();
        }

        // ... [Funciones de ayuda: getMelodicPossibleIntervals, playUserResponse, showResult, gamificaci√≥n, etc. se mantienen igual] ...
        function getMelodicPossibleIntervals() {
            const isMin = state.currentRoundTonality === 'minor';
            switch(state.level) {
                case 'basic1': return isMin ? [0, 2, 3, 5] : [0, 2, 4, 5];
                case 'basic2': return isMin ? [7, 8, 10, 12] : [7, 9, 11, 12];
                case 'inter': return isMin ? [0, 2, 3, 5, 7, 8, 10, 12] : [0, 2, 4, 5, 7, 9, 11, 12];
                case 'adv1': return [0, 1, 2, 3, 4, 5];
                case 'adv2': return [6, 7, 8, 9, 10, 11, 12];
                case 'total': return Array.from({length:13},(_,i)=>i);
                default: return [0, 4, 7, 12];
            }
        }
        
        function playUserResponse() {
             if(!state.target || !state.lastWrongAnswer) return;
             const vQ = 0.4;
             if(state.mode === 'melody') {
                let t = 0;
                state.lastWrongAnswer.forEach(int => { playTone(midiToFreq(state.keyIndex+int), 0.5, 'triangle', t, vQ); t+=0.6; });
                setTimeout(()=>playTone(midiToFreq(state.keyIndex), 1.5, 'triangle', 0, 0.5), t*1000+100);
             } 
             // ... Intervalo y Armon√≠a similar a versi√≥n anterior ...
        }

        function showResult(ok, u, c) {
            const modal = document.getElementById('result-modal');
            if(modal) {
                modal.style.display='flex';
                document.getElementById('result-icon').innerText = ok ? "üéâ" : "‚ùå";
                document.getElementById('result-title').innerText = ok ? "¬°Excelente!" : "Casi...";
                document.getElementById('result-user-info').innerText = state.mode==='harmony' ? `Tu respuesta: ${u}` : (state.mode==='interval' ? `${c}\n(Notas: ${getNoteName(state.keyLabel, state.target.m1-state.keyIndex)} - ${getNoteName(state.keyLabel, state.target.m2-state.keyIndex)})` : `Tu respuesta: ${u}`);
                document.getElementById('result-correct').innerText = c;
                document.getElementById('correct-block').classList.toggle('hidden', ok);
                document.getElementById('btn-play-user').classList.toggle('hidden', ok);
                if(state.mode==='harmony') {
                   document.getElementById('harmony-result-detail').classList.remove('hidden');
                   document.getElementById('res-roman').innerText = c;
                   document.getElementById('res-american').innerText = c.split(' - ').map(r => getAmericanChord(r, state.keyLabel, state.currentRoundTonality)).join(' - ');
                } else document.getElementById('harmony-result-detail').classList.add('hidden');
            }
            if(ok && state.mode === 'melody') executeRes(state.target.sequence[state.target.sequence.length-1].interval, ()=>setTimeout(handleContinue, 1200));
            else if(ok) setTimeout(handleContinue, 1500);
        }

        // --- GESTI√ìN DE SESI√ìN ---
        function selectGameMode(mode, time) {
            initAudio();
            sessionState.active = true;
            sessionState.type = mode;
            document.getElementById('start-modal').style.display = 'none';
            
            if(mode === 'daily') {
                optimizeSessionConfig();
                startDailySession(time);
                startGame(); 
            } else {
                // Limpieza modo libre
                document.getElementById('session-bar-container').classList.add('hidden');
                document.getElementById('session-time-remaining').classList.add('hidden');
                const pi = document.getElementById('phase-indicator'); if(pi) pi.style.opacity = '0';
                
                const keys = ['C','G','D','A','E'];
                state.keyLabel = keys[Math.floor(Math.random()*keys.length)];
                state.keyIndex = 48 + (ROOT_INDICES[state.keyLabel] || 0);
                document.getElementById('key-root').innerText = state.keyLabel;
                resetUI();
            }
        }

        function startDailySession(time) {
            sessionState.timeLeft = time;
            sessionState.totalDuration = time;
            document.getElementById('session-bar-container').classList.remove('hidden');
            document.getElementById('session-time-remaining').classList.remove('hidden');
            
            if(sessionState.timerId) clearInterval(sessionState.timerId);
            sessionState.timerId = setInterval(() => {
                sessionState.timeLeft--;
                // Guardar estado cada segundo por si se cierra
                localStorage.setItem('trainer_active_session_v2', JSON.stringify({
                    type: 'daily',
                    timeLeft: sessionState.timeLeft,
                    totalDuration: sessionState.totalDuration,
                    timestamp: Date.now()
                }));

                const pct = ((sessionState.totalDuration - sessionState.timeLeft) / sessionState.totalDuration) * 100;
                document.getElementById('session-progress').style.width = pct + "%";
                const m = Math.floor(sessionState.timeLeft / 60);
                const s = sessionState.timeLeft % 60;
                const tm = document.getElementById('session-timer-text');
                if(tm) {
                    tm.innerText = `${m}:${s<10?'0':''}${s}`;
                    if(sessionState.timeLeft < 60) tm.parentElement.classList.add('warning');
                }

                if(sessionState.timeLeft <= 0) {
                    clearInterval(sessionState.timerId);
                    localStorage.removeItem('trainer_active_session_v2');
                    alert("¬°Sesi√≥n completada! Buen trabajo.");
                    location.reload();
                }
            }, 1000);
        }

        // L√≥gica de recuperaci√≥n
        window.onload = () => {
            loadProgress();
            const s = localStorage.getItem('trainer_streak') || 0;
            document.getElementById('streak-indicator').innerText = `Racha: ${s} D√≠as üî•`;
            renderUI();
            
            // Verificar sesi√≥n activa
            const active = JSON.parse(localStorage.getItem('trainer_active_session_v2'));
            // Solo recuperar si es reciente (menos de 24h)
            if(active && active.timeLeft > 0 && (Date.now() - active.timestamp) < 86400000) {
                const rm = document.getElementById('resume-modal');
                if(rm) rm.style.display = 'flex';
                // Guardamos temp para el boton "continuar"
                state.tempResumeData = active;
            }
        };

        function resumeSession() {
            const active = state.tempResumeData;
            document.getElementById('resume-modal').style.display = 'none';
            selectGameMode(active.type, active.timeLeft); // Reinicia con el tiempo restante
            // Restaurar total original para la barra
            sessionState.totalDuration = active.totalDuration; 
        }

        function confirmCancelSession() {
            document.getElementById('resume-modal').style.display = 'none';
            document.getElementById('confirm-cancel-modal').style.display = 'flex';
        }

        function cancelSession() {
            localStorage.removeItem('trainer_active_session_v2');
            location.reload();
        }

        function closeConfirmCancel() {
            document.getElementById('confirm-cancel-modal').style.display = 'none';
            document.getElementById('resume-modal').style.display = 'flex';
        }

        // ... [Resto de funciones UI: toggleTheme, showStats, etc. se mantienen igual] ...
        function optimizeSessionConfig() {
            const sk = state.skillLevels;
            // Melod√≠a
            if(sk.melody < 1) setLevel('basic1');
            else if(sk.melody < 2) setLevel('basic2');
            else if(sk.melody < 3) setLevel('inter');
            else if(sk.melody < 4) setLevel('adv1');
            else setLevel('adv2');
            
            // INICIO EN 1 NOTA (SIEMPRE)
            const countInput = document.getElementById('note-count-input');
            if(countInput) countInput.value = "1";

            // Intervalo
            setIntervalLevel(Math.min(6, Math.floor(sk.interval) + 1));
            // Armon√≠a
            if(sk.harmony < 1) setHarmonyLevel('basic');
            else if(sk.harmony < 2) setHarmonyLevel('inter');
            else setHarmonyLevel('expert');
        }
        
        function setGlobalMode(m) { 
            state.mode = m; 
            stopAllSounds();
            const mel = document.getElementById('lvl-mel'); if(mel) mel.classList.toggle('hidden', m!=='melody');
            const int = document.getElementById('lvl-int'); if(int) int.classList.toggle('hidden', m!=='interval');
            const har = document.getElementById('lvl-har'); if(har) har.classList.toggle('hidden', m!=='harmony');
            const ig = document.getElementById('interval-grid'); if(ig) ig.classList.toggle('hidden', m!=='interval');
            const hg = document.getElementById('harmony-grid'); if(hg) hg.classList.toggle('hidden', m!=='harmony');
            updateActiveBtn('#main-mode-group', `mode-${m.slice(0,3)}-btn`); 
            
            // Ocultar bot√≥n borrar al cambiar modo
            const btnDel = document.getElementById('btn-delete-note');
            if(btnDel) btnDel.classList.add('hidden');
            
            resetUI(); 
        }
        
        // ... (Funciones de soporte previamente definidas: updateActiveBtn, resetUI, renderBufferDots, etc.)
        function updateActiveBtn(c, i) { document.querySelectorAll(`${c} .control-btn`).forEach(b => b.classList.remove('active-choice')); document.getElementById(i)?.classList.add('active-choice'); }
        function resetUI() { document.getElementById('result-modal').style.display='none'; document.getElementById('harmony-grid').classList.add('hidden'); document.getElementById('interval-grid').classList.add('hidden'); document.getElementById('buffer-dots').innerHTML=''; renderUI(); }
        function renderBufferDots(c) { const b = document.getElementById('buffer-dots'); if(b) { b.innerHTML=''; for(let i=0; i<c; i++) b.innerHTML+='<div class="buffer-dot"></div>'; } }
        function renderIntervalOptions(o) { const g = document.getElementById('interval-grid'); if(g) { g.innerHTML=''; g.classList.remove('hidden'); o.forEach(x => { const b=document.createElement('button'); b.innerText=x; b.onclick=()=>checkAnswer(x); g.appendChild(b); }); } }
        function renderHarmonyOptions(o) { const g = document.getElementById('harmony-grid'); if(g) { g.innerHTML=''; g.classList.remove('hidden'); o.forEach(x => { const b=document.createElement('button'); b.innerText=x; b.onclick=()=>checkAnswer(x); g.appendChild(b); }); } }
        
        function deleteLastNote() { 
            if(state.userBuffer.length > 0) { 
                state.userBuffer.pop(); 
                const dots=document.querySelectorAll('.buffer-dot'); 
                if(dots[state.userBuffer.length]) dots[state.userBuffer.length].classList.remove('active'); 
                
                // Ocultar bot√≥n si no quedan notas
                if (state.userBuffer.length === 0) {
                    const btnDel = document.getElementById('btn-delete-note');
                    if(btnDel) btnDel.classList.add('hidden');
                }
            } 
        }
        
        function handleContinue() { stopAllSounds(); document.getElementById('result-modal').style.display = 'none'; startGame(); }
        function goToMenu() { location.reload(); } 
        function toggleTheme() { document.body.classList.toggle('dark-mode'); }
        function toggleMixer() { document.getElementById('mixer-panel').classList.toggle('hidden'); }
        function showDailyOptions() { document.getElementById('start-main-view').classList.add('hidden'); document.getElementById('start-daily-view').classList.remove('hidden'); }
        function backToMainStart() { document.getElementById('start-daily-view').classList.add('hidden'); document.getElementById('start-main-view').classList.remove('hidden'); }
        function setTonalityMode(m) { state.tonalityMode = m; if(m!=='combined') state.currentRoundTonality = m; updateActiveBtn('.control-group', `ton-${m}`); renderUI(); }
        function setLevel(l) { state.level = l; updateActiveBtn('#lvl-mel', `lvl-${l}`); renderUI(); }
        function setIntervalLevel(l) { state.intervalLevel = l; updateActiveBtn('#lvl-int', `int-lvl-${l}`); }
        function setHarmonyLevel(l) { state.harmonyLevel = l; updateActiveBtn('#lvl-har', `har-lvl-${l}`); }
        function closeReportModal() { document.getElementById('report-modal').style.display='none'; }
        function closeHelpModal() { document.getElementById('help-modal').style.display='none'; }
        function closeStatsModal() { document.getElementById('stats-modal').style.display='none'; }
        function showHelpModal() { document.getElementById('help-modal').style.display='flex'; }
        function showStatsModal() { /* ... L√≥gica previa ... */ document.getElementById('stats-modal').style.display='flex'; }
        function showReportModal() { /* ... L√≥gica previa ... */ document.getElementById('report-modal').style.display='flex'; }
        function executeRes(idx, cb) { 
            let path = RESOLUTIONS[idx]; if (!path) path = [idx]; if (Array.isArray(path[0])) path = path[Math.floor(Math.random() * path.length)];
            let t = 0; path.forEach((step, i) => { const midi = state.keyIndex + step; playTone(midiToFreq(midi), (i===path.length-1?1.5:0.5), 'triangle', t, 0.4); setTimeout(() => highlightKey(midi), t * 1000); t += 0.5; }); if(cb) setTimeout(cb, t * 1000);
        }
        function highlightKey(midi) { const rel = ((midi - state.keyIndex) % 12 + 12) % 12; const cat = getFunctionalClass(rel, state.currentRoundTonality); const glowClass = `res-${cat}-glow`; document.querySelectorAll(`[data-interval="${rel}"]`).forEach(k => { k.classList.add('res-glow', glowClass); setTimeout(() => k.classList.remove('res-glow', glowClass), 500); }); }
        
        function trackStat(mode, answer, isCorrect) {
            if(!state.stats[mode]) state.stats[mode] = {t:0, c:0};
            state.stats[mode].t++;
            if(isCorrect) state.stats[mode].c++;
            if(!isCorrect && answer) { let key = answer; if(mode === 'melody') key = 'Secuencia Mel√≥dica'; state.stats.mistakes[key] = (state.stats.mistakes[key] || 0) + 1; }
            saveProgress();
        }
        function saveProgress() { if(sessionState.active) { /* ... log ... */ } localStorage.setItem('trainer_progress_v5', JSON.stringify(state)); }
        function loadProgress() { const s = JSON.parse(localStorage.getItem('trainer_progress_v5')); if(s) { state.playerLevel=s.level||1; state.xp=s.xp||0; state.score=s.score||0; state.streak=s.streak||0; if(s.stats) state.stats=s.stats; if(s.skillLevels) state.skillLevels=s.skillLevels; } }
        function triggerConfetti() { const c = document.getElementById('confetti-container'); if(!c) return; c.innerHTML = ''; for(let i=0; i<30; i++) { const p = document.createElement('div'); p.className = 'absolute w-2 h-4 animate-confetti'; p.style.left = Math.random() * 100 + '%'; p.style.backgroundColor = ['#8b5cf6', '#10b981', '#3b82f6', '#f59e0b'][Math.floor(Math.random()*4)]; c.appendChild(p); } }
        
        function renderUI() {
            const stage = document.getElementById('piano-stage');
            const chipContainer = document.getElementById('practice-chips');
            if(!stage || !chipContainer) return;
            
            stage.innerHTML = ''; chipContainer.innerHTML = '';
            
            const isMin = state.currentRoundTonality === 'minor';
            const offsets = [0, 0.6, 1, 1.6, 2, 3, 3.6, 4, 4.6, 5, 5.6, 6];
            for(let i=0; i<25; i++) {
                const midi = 48 + i;
                const abs = midi % 12;
                const relPos = (Math.floor(i/12)*7) + offsets[abs];
                const btn = document.createElement('button');
                btn.className = [1,3,6,8,10].includes(abs) ? 'key-black' : 'key-white';
                btn.style.left = `calc(${relPos} * (100% / 15))`;
                const func = ((midi - state.keyIndex) % 12 + 12) % 12;
                btn.setAttribute('data-interval', func);
                if(midi >= state.keyIndex && midi <= state.keyIndex + 12) {
                    const cat = getFunctionalClass(func, state.currentRoundTonality);
                    let label = DEGREES[func];
                    if(isMin && [3,8,10].includes(func)) label = 'b' + (func===3?'3':(func===8?'6':'7'));
                    btn.innerHTML = `<div class="degree-tag bg-${cat} text-white">${label}</div><div class="note-name">${getNoteName(state.keyLabel, func)}</div>`;
                }
                
                btn.onclick = () => { 
                    initAudio(); 
                    playTone(midiToFreq(midi), 0.8); 
                    if(state.mode !== 'interval') checkAnswer(func); 
                };
                stage.appendChild(btn);
            }

            if (state.mode === 'melody') {
                chipContainer.style.display = 'flex'; 
                getMelodicPossibleIntervals().forEach(idx => {
                    const chip = document.createElement('div');
                    const cat = getFunctionalClass(idx, state.currentRoundTonality);
                    let label = DEGREES[idx];
                    if(isMin && [3,8,10].includes(idx)) label = 'b' + (idx===3?'3':(idx===8?'6':'7'));
                    chip.className = `res-card cursor-pointer border-2 font-black text-sm bg-${cat} text-white shadow-sm hover:scale-105 transition-all`;
                    chip.innerText = label;
                    chip.onclick = () => { initAudio(); executeRes(idx); };
                    chipContainer.appendChild(chip);
                });
            } else {
                chipContainer.style.display = 'flex'; 
            }
        }

        window.selectGameMode = selectGameMode;
    </script>
</body>
</html>
