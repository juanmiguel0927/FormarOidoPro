<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Formar O√≠do Pro - Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 950: '#020617' }
                    },
                    screens: { 'xs': '380px' },
                    animation: {
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'bounce-short': 'bounceShort 0.5s ease-in-out',
                        'confetti': 'confettiDrop 2s ease-in-out forwards',
                        'pulse-tonic': 'pulseTonic 2s infinite ease-in-out',
                    },
                    keyframes: {
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.8) translateY(20px)' }, '100%': { opacity: '1', transform: 'scale(1) translateY(0)' } },
                        bounceShort: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.2)' } },
                        confettiDrop: { '0%': { transform: 'translateY(-100vh) rotate(0deg)', opacity: '1' }, '100%': { transform: 'translateY(100vh) rotate(720deg)', opacity: '0' } },
                        pulseTonic: { '0%, 100%': { opacity: '1', transform: 'scale(1)' }, '50%': { opacity: '0.6', transform: 'scale(0.92)' } }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&family=Fira+Code:wght@500;700&display=swap');
        
        :root {
            --bg-main: #fdfbf7; --bg-piano: #f3f4f6; --text-main: #1e293b; --border-ui: #e2e8f0; --card-bg: #ffffff;
            --accent: #8b5cf6; --accent-hover: #7c3aed;
            --c-tonic: #8b5cf6; --c-stable: #10b981; --c-semi: #3b82f6; --c-unstable: #f59e0b;
            --active-glow: 0 0 15px rgba(139, 92, 246, 0.6);
        }

        body.dark-mode {
            --bg-main: #0f172a; --bg-piano: #1e293b; --text-main: #f8fafc; --border-ui: #334155; --card-bg: #1e293b;
            --accent: #a78bfa; --accent-hover: #c4b5fd; --active-glow: 0 0 18px rgba(167, 139, 250, 0.5);
        }

        body { font-family: 'Nunito', sans-serif; background: var(--bg-main); color: var(--text-main); height: 100vh; margin: 0; display: flex; flex-direction: column; transition: background 0.4s ease, color 0.4s ease; overflow: hidden; -webkit-user-select: none; user-select: none; }

        .piano-viewport { width: 100%; overflow-x: auto; padding: 10px 10px 20px 10px; background: var(--bg-piano); border-top: 2px solid var(--border-ui); display: flex; justify-content: flex-start; scrollbar-width: none; box-shadow: inset 0 4px 6px rgba(0,0,0,0.05); -webkit-overflow-scrolling: touch; transition: background 0.4s ease; }
        @media (min-width: 640px) { .piano-viewport { justify-content: center; } }
        .piano-stage { position: relative; height: 120px; min-width: 600px; width: 100%; max-width: 920px; margin: 0 auto; flex-shrink: 0; }
        
        .key-white { position: absolute; top: 0; width: calc(100% / 15); height: 100%; background: linear-gradient(to bottom, #ffffff 0%, #f1f5f9 100%); border: 1px solid #cbd5e1; border-bottom: 4px solid #94a3b8; border-radius: 0 0 6px 6px; z-index: 1; cursor: pointer; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 8px; transition: transform 0.1s; }
        .key-black { position: absolute; top: 0; width: calc(100% / 26); height: 60%; background: linear-gradient(to bottom, #1e293b 0%, #0f172a 100%); border: 1px solid #000; border-bottom: 6px solid #000; border-radius: 0 0 4px 4px; z-index: 2; cursor: pointer; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 4px; color: white; transition: transform 0.1s; }

        .control-group { background: var(--card-bg); padding: 4px; border-radius: 14px; border: 1px solid var(--border-ui); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .control-btn { padding: 8px 2px; border-radius: 10px; font-size: 9px; font-weight: 800; color: #64748b; cursor: pointer; border: 1px solid transparent; background: transparent; transition: all 0.2s; text-align: center; text-transform: uppercase; }
        .dark-mode .control-btn { color: #cbd5e1; }
        .active-choice { background: var(--accent) !important; color: white !important; box-shadow: var(--active-glow) !important; transform: scale(1.02); font-weight: 900 !important; }

        .compact-badge { background: var(--card-bg); border: 1px solid var(--border-ui); border-radius: 12px; padding: 0 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 42px; min-width: 60px; }
        
        .practice-card { background: var(--card-bg); border: 2px solid var(--border-ui); border-radius: 12px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s; color: var(--text-main); }
        .practice-card:active { transform: scale(0.9); border-color: var(--accent); }

        .bg-tonic { background: var(--c-tonic) !important; color: white !important; }
        .bg-stable { background: var(--c-stable) !important; color: white !important; }
        .bg-semi { background: var(--c-semi) !important; color: white !important; }
        .bg-unstable { background: var(--c-unstable) !important; color: white !important; }

        .degree-tag { width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 8px; margin-bottom: 2px; color: white; }
        
        .highlight-res { border-color: white !important; transform: scale(1.15) !important; z-index: 50 !important; transition: transform 0.2s, box-shadow 0.2s; }
        .res-tonic-glow { box-shadow: 0 0 25px var(--c-tonic) !important; }
        .res-stable-glow { box-shadow: 0 0 25px var(--c-stable) !important; }
        .res-semi-glow { box-shadow: 0 0 25px var(--c-semi) !important; }
        .res-unstable-glow { box-shadow: 0 0 25px var(--c-unstable) !important; }
        
        .buffer-indicator { display: flex; gap: 6px; margin-top: 10px; justify-content: center; }
        .buffer-dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; transition: all 0.2s; }
        .buffer-dot.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); transform: scale(1.2); }

        #harmony-grid button { border: 2px solid var(--border-ui); display: flex; flex-direction: row; align-items: center; justify-content: center; transition: all 0.2s; background: var(--card-bg); min-height: 80px; border-radius: 14px; padding: 10px; color: var(--text-main); gap: 4px; flex-wrap: nowrap; overflow: hidden; }
        .cipher-chord { display: flex; align-items: flex-start; gap: 1px; font-family: 'Fira Code', monospace; }
        .roman-main { font-size: 16px; font-weight: 900; color: var(--accent); line-height: 1.2; }
        .inversion-stack { display: flex; flex-direction: column; font-size: 8px; font-weight: 900; line-height: 0.95; color: var(--text-main); opacity: 0.8; padding-top: 1px; }
        .separator-dash { font-size: 12px; opacity: 0.2; margin: 0 2px; font-weight: bold; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 500; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); color: var(--text-main); max-width: 450px; width: 100%; border-radius: 24px; padding: 24px; border: 1px solid var(--border-ui); }

        .combo-counter { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); font-weight: 900; color: #f59e0b; text-shadow: 0 2px 4px rgba(0,0,0,0.1); opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 160; }
        .combo-active { opacity: 1; transform: translateX(-50%) scale(1.2); }

        #session-bar-container { width: 100%; height: 4px; background: rgba(0,0,0,0.05); position: absolute; top: 0; left: 0; z-index: 160; display: none; }
        #session-progress { height: 100%; background: #10b981; width: 0%; transition: width 0.3s ease; }

        .bottom-dock { padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .dock-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; transition: all 0.1s; cursor: pointer; height: 52px; position: relative; }
        .btn-main-action { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white !important; border: none; }

        #cadence-display { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .chord-label { padding: 10px 15px; border-radius: 12px; background: var(--bg-piano); color: #64748b; font-family: 'Fira Code', monospace; font-weight: 900; font-size: 18px; transition: all 0.2s; border: 2px solid transparent; }
        .chord-label.active { background: var(--accent); color: white; transform: scale(1.15); box-shadow: var(--active-glow); border-color: rgba(255,255,255,0.3); }

        .heatmap-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 10px; }
        .heatmap-cell { height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; color: white; border: 1px solid rgba(0,0,0,0.1); }
    </style>
</head>
<body class="select-none relative flex flex-col h-screen overflow-hidden">

    <div id="combo-display" class="combo-counter text-xl">COMBO x2</div>
    <div id="session-bar-container"><div id="session-progress"></div></div>
    
    <div id="session-time-remaining" class="hidden absolute top-1 left-1/2 transform -translate-x-1/2 z-[160] bg-slate-800/80 text-white text-[10px] font-bold px-3 py-1 rounded-b-lg backdrop-blur-sm shadow-md flex items-center gap-2">
        <span id="session-timer-text">00:00</span>
        <span class="text-[8px] opacity-70 uppercase" id="session-name-text">Entrenamiento</span>
        <button onclick="requestExit()" class="ml-2 text-rose-400 font-bold text-xs bg-white/10 hover:bg-white/20 px-2 py-0.5 rounded transition-colors uppercase">Salir</button>
    </div>

    <!-- START MODAL -->
    <div id="start-modal" class="modal" style="display: flex;">
        <div class="modal-content text-center p-8 max-w-sm">
            <h2 class="text-3xl font-black text-slate-800 dark:text-white mb-2">Formar O√≠do <span class="text-violet-500">Pro</span></h2>
            <p class="text-slate-500 dark:text-slate-300 mb-8 font-semibold text-sm">Entrenamiento inteligente con racha.</p>
            <div class="space-y-3" id="start-main-view">
                <button id="btn-continue-session" onclick="resumeActiveSession()" class="hidden w-full bg-orange-500 hover:bg-orange-600 text-white font-black uppercase py-4 rounded-xl text-sm tracking-widest shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2">
                    <svg class="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Continuar Sesi√≥n
                </button>
                <button onclick="showDailyOptions()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-black uppercase py-4 rounded-xl text-sm tracking-widest shadow-lg transform active:scale-95 transition-all">Rutina Diaria</button>
                <button onclick="selectGameMode('free')" class="w-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-black uppercase py-4 rounded-xl text-sm tracking-widest shadow-sm hover:bg-slate-200">Entrenamiento Libre</button>
            </div>
            <div id="start-daily-view" class="hidden space-y-4">
                <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl mb-2 border border-slate-100 dark:border-slate-700">
                    <p class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest leading-none mb-1">Racha Actual</p>
                    <p id="streak-indicator" class="text-2xl font-black text-orange-500">0 D√≠as üî•</p>
                </div>
                <button onclick="selectGameMode('daily', 'minimal')" class="w-full bg-emerald-100 dark:bg-emerald-900/30 border-2 border-emerald-500 p-4 rounded-xl text-left hover:bg-emerald-200 transition-all"><span class="block font-black text-emerald-700 dark:text-emerald-400 uppercase text-xs">M√≠nima (5 min)</span><p class="text-[10px] text-emerald-600 dark:text-emerald-400/80">Dificultad adaptada a tu racha.</p></button>
                <button onclick="selectGameMode('daily', 'optimal')" class="w-full bg-violet-100 dark:bg-violet-900/30 border-2 border-violet-500 p-4 rounded-xl text-left hover:bg-violet-200 transition-all"><span class="block font-black text-violet-700 dark:text-violet-400 uppercase text-xs">√ìptima (20 min)</span><p class="text-[10px] text-violet-600 dark:text-violet-400/80">Desaf√≠o completo y progresivo.</p></button>
                <button onclick="backToMainStart()" class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase hover:text-slate-600 transition-colors">Volver</button>
            </div>
        </div>
    </div>

    <!-- RESULT MODAL -->
    <div id="result-modal" class="modal" style="display: none;">
        <div class="modal-content text-center p-8 max-w-sm" id="result-card">
            <div id="confetti-container" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
            <div id="result-icon" class="text-5xl mb-4"></div>
            <h2 id="result-title" class="text-3xl font-black uppercase mb-2 leading-none"></h2>
            <div class="w-full h-px bg-slate-200 dark:bg-slate-700 my-4"></div>
            
            <div id="harmony-result-detail" class="hidden text-left space-y-3 mb-6">
                <div>
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Cifrado Americano</p>
                    <div id="res-american" class="font-mono text-xs font-bold bg-slate-50 dark:bg-slate-800 p-2 rounded-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300"></div>
                </div>
                <div>
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Cifrado Romano</p>
                    <div id="res-roman" class="flex items-center gap-3 bg-slate-50 dark:bg-slate-800 p-2 rounded-lg border border-slate-200 dark:border-slate-700 overflow-x-auto no-scrollbar"></div>
                </div>
            </div>

            <p id="result-user" class="font-mono text-lg font-bold mb-4 opacity-75 dark:text-slate-200 leading-none"></p>
            <div id="correct-block" class="hidden w-full">
                <p class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest mb-1 leading-none">Correcto</p>
                <div id="result-correct" class="font-mono text-xl font-black text-emerald-600 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900/30 p-2 rounded-lg border border-emerald-500/30"></div>
            </div>
            <button onclick="handleContinue()" class="mt-4 w-full py-3 rounded-xl font-black uppercase tracking-widest text-xs transition-colors shadow-lg text-white bg-slate-800 hover:bg-slate-700">Continuar</button>
        </div>
    </div>

    <header class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 p-2 sm:p-3 flex justify-between items-center shadow-sm z-[150] shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-violet-600 p-1.5 rounded-xl"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg></div>
            <h1 class="font-black text-xs sm:text-sm tracking-tight uppercase italic text-slate-800 dark:text-white leading-tight">Formar <br class="sm:hidden"> O√≠do <span class="text-violet-500">Pro</span></h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="openStats()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></button>
            <button onclick="toggleTheme()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300"><svg id="sun-icon" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 2.293a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 010-1.414zm4.707 4.707a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.414A1 1 0 016.464 5l.707.707a1 1 0 01-1.414 1.414l-.707-.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z"/></svg></button>
            <div class="bg-white dark:bg-slate-850 px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 font-mono text-violet-600 dark:text-violet-400 font-bold text-xs leading-none"><span id="score-val">0</span></div>
        </div>
    </header>

    <main id="main-scroll-container" class="flex-1 relative overflow-y-auto no-scrollbar bg-gradient-to-b from-transparent to-slate-100/50 dark:to-black/20 pb-[100px]">
        <div class="p-3 sm:p-5 flex flex-col gap-4 max-w-4xl mx-auto w-full">
            
            <div id="levels-mel-har" class="flex flex-col gap-1.5">
                <div class="flex justify-between items-center px-1">
                    <span class="text-[9px] uppercase font-black text-slate-400 dark:text-slate-500 tracking-widest leading-none">Niveles Mel√≥dicos</span>
                    <div class="flex items-center gap-2 bg-white dark:bg-slate-800 px-2 py-1 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm">
                        <span class="text-[8px] font-bold text-slate-500 dark:text-slate-400 uppercase">Notas:</span>
                        <input type="number" id="note-count-input" min="1" max="10" value="1" class="w-8 bg-transparent text-center font-bold text-xs text-violet-600 dark:text-violet-400 outline-none">
                    </div>
                </div>
                <div class="control-group grid grid-cols-3 gap-1">
                    <button onclick="setLevel('basic1')" id="lvl-basic1" class="control-btn active-choice">B√ÅSICO 1</button>
                    <button onclick="setLevel('basic2')" id="lvl-basic2" class="control-btn">B√ÅSICO 2</button>
                    <button onclick="setLevel('inter')" id="lvl-inter" class="control-btn">INTERMEDIO</button>
                    <button onclick="setLevel('adv1')" id="lvl-adv1" class="control-btn">AVANZADO 1</button>
                    <button onclick="setLevel('adv2')" id="lvl-adv2" class="control-btn">AVANZADO 2</button>
                    <button onclick="setLevel('total')" id="lvl-total" class="control-btn">TOTAL</button>
                </div>
            </div>

            <div id="levels-interval" class="hidden flex flex-col gap-1.5">
                <div class="flex justify-between items-center px-1"><span class="text-[9px] uppercase font-black text-slate-400 dark:text-slate-500 tracking-widest leading-none">Dificultad Intervalos</span></div>
                <div class="control-group grid grid-cols-3 gap-1">
                    <button onclick="setIntervalLevel(1)" id="int-lvl-1" class="control-btn active-choice">NIVEL 1</button>
                    <button onclick="setIntervalLevel(2)" id="int-lvl-2" class="control-btn">NIVEL 2</button>
                    <button onclick="setIntervalLevel(3)" id="int-lvl-3" class="control-btn">NIVEL 3</button>
                    <button onclick="setIntervalLevel(4)" id="int-lvl-4" class="control-btn">NIVEL 4</button>
                    <button onclick="setIntervalLevel(5)" id="int-lvl-5" class="control-btn">NIVEL 5</button>
                    <button onclick="setIntervalLevel(6)" id="int-lvl-6" class="control-btn">NIVEL 6</button>
                </div>
            </div>

            <div id="levels-harmony" class="hidden flex flex-col gap-1.5">
                <div class="flex justify-between items-center px-1"><span class="text-[9px] uppercase font-black text-slate-400 dark:text-slate-500 tracking-widest leading-none">Dificultad Armon√≠a</span></div>
                <div class="control-group grid grid-cols-3 gap-1">
                    <button onclick="setHarmonyLevel('basic')" id="har-lvl-basic" class="control-btn active-choice">B√ÅSICO</button>
                    <button onclick="setHarmonyLevel('inter')" id="har-lvl-inter" class="control-btn">INTERMEDIO</button>
                    <button onclick="setHarmonyLevel('expert')" id="har-lvl-expert" class="control-btn">EXPERTO</button>
                </div>
            </div>

            <div class="flex flex-col gap-1.5" id="tonality-controls">
                <div class="control-group grid grid-cols-3 gap-1">
                    <button onclick="setTonalityMode('major')" id="ton-major" class="control-btn active-choice">MAYOR</button>
                    <button onclick="setTonalityMode('minor')" id="ton-minor" class="control-btn">MENOR</button>
                    <button onclick="setTonalityMode('combined')" id="ton-combined" class="control-btn">COMBINADO</button>
                </div>
                <div class="control-group grid grid-cols-3 gap-1" id="main-mode-group">
                    <button onclick="setGlobalMode('melody')" id="mode-mel-btn" class="control-btn active-choice text-[10px] py-1.5">MELOD√çA</button>
                    <button onclick="setGlobalMode('interval')" id="mode-int-btn" class="control-btn text-[10px] py-1.5">INTERVALO</button>
                    <button onclick="setGlobalMode('harmony')" id="mode-har-btn" class="control-btn text-[10px] py-1.5">ARMON√çA</button>
                </div>
            </div>

            <div class="flex gap-2 items-center justify-between">
                <div id="key-badge" class="compact-badge">
                    <span id="key-root" class="text-xs font-black text-violet-400 leading-none">C</span>
                    <span id="key-quality-label" class="text-[7px] font-bold opacity-80 uppercase tracking-wide leading-none text-slate-500 dark:text-slate-200">MAYOR</span>
                </div>
                <div id="buffer-dots" class="buffer-indicator flex-1"></div>
            </div>
            
            <div id="practice-module" class="flex flex-wrap justify-center gap-3 py-4 w-full">
                <div id="practice-chips-container" class="flex flex-wrap justify-center gap-3"></div>
            </div>
            <div id="harmony-grid" class="hidden w-full grid grid-cols-1 sm:grid-cols-2 gap-3 pb-6"></div>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 w-full z-[200] bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 bottom-dock">
        <div class="piano-viewport no-scrollbar"><div id="piano-stage" class="piano-stage"></div></div>
        <div class="flex items-center justify-between px-3 py-2 gap-2 bg-slate-50 dark:bg-slate-950/50">
            <div class="flex gap-2">
                <button onclick="toggleMixer()" class="dock-btn w-12 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg></button>
                <button onclick="toggleImagina()" id="btn-imagina" class="dock-btn w-12 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg><div id="imagina-dot-active" class="absolute top-1 right-1 w-1.5 h-1.5 rounded-full bg-violet-500 hidden"></div></button>
                <button id="btn-repeat-target" onclick="repeatTargetSound()" class="dock-btn w-12 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg></button>
            </div>
            <button id="btn-init" onclick="startGame()" class="dock-btn btn-main-action flex-1 ml-2"><span class="text-sm font-black tracking-tighter uppercase leading-none">Nueva Pregunta</span></button>
        </div>
    </div>

    <script>
        function midiToFreq(m) { return 440 * Math.pow(2, (m - 69) / 12); }

        const DEGREES = ['1', 'b2', '2', 'b3', '3', '4', '#4', '5', 'b6', '6', 'b7', '7', '8'];
        const ROOT_INDICES = { 'C': 0, 'Db': 1, 'C#': 1, 'D': 2, 'Eb': 3, 'E': 4, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'Ab': 8, 'G#': 8, 'A': 9, 'Bb': 10, 'B': 11 };
        const RESOLUTIONS = { 0: [0, -5, 0], 1: [1, 0], 2: [2, 0], 3: [3, 2, 0], 4: [4, 2, 0], 5: [5, 4, 2, 0], 6: [6, 7, 4, 0], 7: [7, 4, 0], 8: [8, 7, 12], 9: [9, 7, 12], 10: [10, 11, 12], 11: [11, 12], 12: [12, 7, 12] };
        const INTERVAL_NAMES = { 0: "Un√≠sono", 1: "2da m", 2: "2da M", 3: "3ra m", 4: "3ra M", 5: "4ta J", 6: "Tritono", 7: "5ta J", 8: "6ta m", 9: "6ta M", 10: "7ma m", 11: "7ma M", 12: "8va J" };
        const INTERVAL_LEVELS = { 1: [0, 5, 7, 12], 2: [0, 1, 2, 5, 7, 12], 3: [0, 1, 2, 3, 4, 5, 7, 12], 4: [0, 1, 2, 3, 4, 5, 6, 7, 12], 5: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 12], 6: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12] };

        const HARMONY_LEVELS = {
            'basic': { 'major': ["I - IV - V - I", "I - V - I", "I - IV - I"], 'minor': ["i - iv - V - i", "i - V - i", "i - iv - i"] },
            'inter': { 'major': ["I - IV - V - I", "ii - V - I", "I - vi - ii - V", "I - iii - IV - V"], 'minor': ["i - iv - V - i", "ii¬∞ - V - i", "i - bVI - V - i", "i - v - bVI - iv"] },
            'expert': { 'major': ["I - IV7 - V7 - I", "ii7 - V7 - I", "I - vi - ii7 - V7", "I - bVI - V7 - I", "I - IV - iv - I", "I - V/V - V - I"], 'minor': ["i - iv7 - V7 - i", "ii¬∞7 - V7 - i", "i - bVI - V7", "i - IV7 - V7 - i", "i - iv - bVII - i"] }
        };

        let audioCtx;
        let state = { level:'basic1', intervalLevel: 1, harmonyLevel: 'basic', tonalityMode:'major', currentRoundTonality:'major', mode:'melody', keyIndex:48, keyLabel:'C', score:0, streak: 0, dailyStreak: 0, imagina:false, userBuffer:[], isPlaying:false, target:null, activeOscillators: [], timeouts: [], cadenceType: 0, errorMap: {}, firstFreeLoad: true };
        let sessionState = { active: false, type: 'free', totalDuration: 0, timeLeft: 0, timerId: null };

        // PERSISTENCIA
        try {
            state.dailyStreak = parseInt(localStorage.getItem('trainer_streak_v3') || 0);
            state.errorMap = JSON.parse(localStorage.getItem('trainer_errors_v3') || '{}');
            const savedSession = localStorage.getItem('trainer_active_session_v3');
            if(savedSession) {
                const sessionData = JSON.parse(savedSession);
                if(sessionData.timeLeft > 5) document.getElementById('btn-continue-session')?.classList.remove('hidden');
            }
        } catch(e) {}

        function initAudio() {
            if(!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const comp = audioCtx.createDynamicsCompressor(); comp.connect(audioCtx.destination); state.masterOut = comp;
            }
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playTone(freq, dur, type='triangle', start=0, vol=0.2) { 
            if(!audioCtx) return;
            const t = start + audioCtx.currentTime; const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, t);
            g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(vol, t + 0.04);
            g.gain.exponentialRampToValueAtTime(vol * 0.7, t + 0.2); g.gain.exponentialRampToValueAtTime(0.001, t + dur);
            osc.connect(g); g.connect(state.masterOut); osc.start(t); osc.stop(t + dur + 0.1);
            state.activeOscillators.push(osc); 
        }

        function stopAllSounds() {
            state.activeOscillators.forEach(osc => { try { osc.stop(); } catch(e) {} });
            state.activeOscillators = []; state.isPlaying = false;
            state.timeouts.forEach(clearTimeout); state.timeouts = [];
        }

        function getFunctionalClass(idx, tonality) {
            if (idx === 0 || idx === 12) return 'tonic';
            if (tonality === 'major') {
                if (idx === 4 || idx === 7) return 'stable';
                if ([2, 5, 9].includes(idx)) return 'semi';
            } else {
                if (idx === 3 || idx === 7) return 'stable';
                if ([2, 5, 8, 10].includes(idx)) return 'semi';
            }
            return 'unstable';
        }

        function getChordLabelHTML(roman, inversion, has7th) {
            let stack = "";
            if (has7th) {
                if (inversion === 0) stack = "7";
                else if (inversion === 1) stack = "<span>6</span><span>5</span>";
                else if (inversion === 2) stack = "<span>4</span><span>3</span>";
                else if (inversion === 3) stack = "<span>4</span><span>2</span>";
            } else {
                if (inversion === 1) stack = "6";
                else if (inversion === 2) stack = "<span>6</span><span>4</span>";
            }
            return `<div class="cipher-chord"><span class="roman-main">${roman}</span><div class="inversion-stack">${stack}</div></div>`;
        }

        function getNoteName(rootName, semitones) {
            const notes = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
            const start = ROOT_INDICES[rootName]; return notes[(start + semitones + 120) % 12];
        }

        function getAmericanChordName(rootName, tonality, roman, inv, has7th) {
            const isMaj = tonality === 'major';
            const baseDegree = roman.replace('7', '').replace('ii¬∞', 'ii').replace('V/V', 'V');
            const degMap = { 'I':0, 'i':0, 'ii':2, 'iii':4, 'IV':5, 'V':7, 'vi':9, 'bVI':8, 'modal':5, 'v':7, 'bVII':10 };
            const semitones = degMap[baseDegree] || 0;
            const rootNote = getNoteName(rootName, semitones);
            
            let quality = "";
            if (roman.toLowerCase() === roman) quality = "m";
            if (roman === 'ii¬∞') quality = "dim";
            if (has7th) quality += "7";

            const voices = getChordVoices(roman, tonality, inv);
            const bassNote = getNoteName(rootName, voices[0]);
            
            return rootNote + quality + (inv > 0 ? "/" + bassNote : "");
        }

        function getChordVoices(degree, tonality, inversion = 0) {
            const isMaj = tonality === 'major';
            const has7th = degree.includes('7');
            const d = degree.replace('7', '');
            
            let n = { 
                'I': isMaj ? [0, 4, 7] : [0, 3, 7], 'i': [0, 3, 7],
                'ii': isMaj ? [2, 5, 9] : [2, 5, 8], 'ii¬∞': [2, 5, 8],
                'iii': isMaj ? [4, 7, 11] : [3, 7, 10], 'IV': isMaj ? [5, 9, 12] : [5, 8, 12], 
                'V': [7, 11, 14], 'vi': isMaj ? [9, 12, 16] : [8, 12, 15],
                'bVI': [8, 12, 15], 'iv': [5, 8, 12], 'v': [7, 10, 14], 'bVII': [10, 14, 17], 'V/V': [2, 6, 9]
            }[d] || [0, 4, 7];

            if (has7th) {
                const seventh = { 'I':11, 'ii':1, 'ii¬∞':1, 'IV':4, 'V':5, 'i':10, 'iv':10, 'IV7':17 }[d] || (n[0] + 10);
                if(!n.includes(seventh)) n.push(seventh);
            }
            for (let i = 0; i < inversion; i++) { if(n.length > 1) { let first = n.shift(); n.push(first + 12); } }
            return n;
        }

        function playCadence(cb) {
            initAudio(); state.isPlaying = true;
            const progs = [[0, -7, -5, 0], [0, 2, -5, 0], [0, 9, 2, -5, 0]];
            const currentProgDegs = progs[state.cadenceType % progs.length]; state.cadenceType++;
            const display = document.getElementById('cadence-display');
            if(display) {
                display.innerHTML = '';
                const romMap = { 0:'I', 5:'IV', 7:'V', 2:'ii', 9:'vi', [-7]:'IV', [-5]:'V' };
                currentProgDegs.forEach((d, i) => {
                    let text = romMap[d]; if(state.currentRoundTonality === 'minor') text = text.toLowerCase();
                    if(d === 9 && state.currentRoundTonality === 'minor') text = 'bVI';
                    display.innerHTML += `<div class="chord-label" id="chord-${i}">${text}</div>`;
                });
            }
            const cadModal = document.getElementById('cadence-modal'); if(cadModal) cadModal.style.display = 'flex';
            let t = 0, currentVoicing = null;
            const vB = parseFloat(document.getElementById('vol-bass')?.value || 0.5);
            const vC = parseFloat(document.getElementById('vol-cadence')?.value || 0.2);
            currentProgDegs.forEach((deg, i) => {
                const bassMidi = state.keyIndex + deg - 12;
                currentVoicing = getBestVoicingTriadOnly(deg, state.currentRoundTonality, currentVoicing);
                state.timeouts.push(setTimeout(() => {
                    document.querySelectorAll('.chord-label').forEach(l => l.classList.remove('active'));
                    document.getElementById(`chord-${i}`)?.classList.add('active');
                }, t * 1000));
                playTone(midiToFreq(bassMidi), 1.0, 'sine', t, vB); 
                currentVoicing.forEach(note => playTone(midiToFreq(note), 0.8, 'triangle', t, vC));
                t += 0.9;
            });
            const tid = setTimeout(() => { if(cadModal) cadModal.style.display = 'none'; state.isPlaying = false; if(cb) cb(); }, (t + 0.3) * 1000);
            state.timeouts.push(tid);
        }

        function getBestVoicingTriadOnly(deg, ton, prev) {
            const root = ((deg % 12) + 12) % 12;
            const notes = ton === 'major' ? [root, root+4, root+7] : [root, root+3, root+7];
            if (!prev) return notes.map(n => { let m = n + state.keyIndex; while(m<58) m+=12; while(m>74) m-=12; return m; }).sort();
            return notes.map(targetPC => {
                const pc = (targetPC + state.keyIndex) % 12;
                let best = prev[0], minDiff = 100;
                for (let oct = -1; oct <= 1; oct++) {
                    const testNote = pc + (state.keyIndex - (state.keyIndex%12)) + (oct*12);
                    prev.forEach(prevNote => { const diff = Math.abs(testNote - prevNote); if(diff < minDiff){ minDiff=diff; best=testNote; }});
                }
                return best;
            }).sort();
        }

        function startGame() { 
            initAudio(); stopAllSounds(); state.target = null; 
            const isInitialFreeEntry = (sessionState.active && sessionState.type === 'free' && state.firstFreeLoad);
            if(sessionState.active && sessionState.type !== 'free') {
                const noteProg = [1, 1, 2, 2, 3, 3, 4, 4, 5];
                const nVal = noteProg[Math.min(noteProg.length - 1, state.dailyStreak)];
                const input = document.getElementById('note-count-input'); if(input) input.value = nVal;
            }
            const keys = ['C','G','D','A','E','B','F','Bb','Eb','Ab'];
            state.keyLabel = keys[Math.floor(Math.random()*keys.length)];
            state.keyIndex = 48 + ROOT_INDICES[state.keyLabel];
            state.currentRoundTonality = state.tonalityMode === 'combined' ? (Math.random() > 0.5 ? 'major' : 'minor') : state.tonalityMode;
            document.getElementById('key-root').innerText = state.keyLabel;
            document.getElementById('key-quality-label').innerText = state.currentRoundTonality === 'major' ? 'MAYOR' : 'MENOR';
            resetUI(); 
            if (isInitialFreeEntry) { state.firstFreeLoad = false; return; }
            playCadence(() => generateQuestion()); 
        }

        function generateQuestion() {
            state.userBuffer = []; const vQ = parseFloat(document.getElementById('vol-question')?.value || 0.4);
            const isMin = state.currentRoundTonality === 'minor';
            if(state.mode === 'melody') {
                const count = parseInt(document.getElementById('note-count-input')?.value || 1);
                const possible = getMelodicPossibleIntervals(); const sequence = [];
                for(let i=0; i<count; i++){ const int = possible[Math.floor(Math.random()*possible.length)]; sequence.push({ interval: int, midi: state.keyIndex + int }); }
                state.target = { type: 'melody', sequence };
                renderBufferDots(count);
                if(!state.imagina){ let t = 0; sequence.forEach(s => { playTone(midiToFreq(s.midi), 0.9, 'triangle', t, vQ); t += 0.8; }); }
            } else if(state.mode === 'interval') {
                const possible = INTERVAL_LEVELS[state.intervalLevel], int = possible[Math.floor(Math.random()*possible.length)];
                const scaleDegs = isMin ? [0, 2, 3, 5, 7, 8, 10, 12] : [0, 2, 4, 5, 7, 9, 11, 12];
                const startMidi = state.keyIndex + scaleDegs[Math.floor(Math.random() * scaleDegs.length)];
                const isH = Math.random() > 0.5, isDesc = Math.random() > 0.5;
                const m1 = startMidi, m2 = isDesc ? startMidi - int : startMidi + int;
                state.target = { type: 'interval', answer: INTERVAL_NAMES[int], m1, m2, isH };
                renderHarmonyOptions([INTERVAL_NAMES[int], ...Object.values(INTERVAL_NAMES).filter(v=>v!==INTERVAL_NAMES[int]).sort(()=>0.5-Math.random()).slice(0,3)].sort());
                if(!state.imagina) { 
                    if(isH) { playTone(midiToFreq(m1),1.5,'triangle',0,vQ*0.7); playTone(midiToFreq(m2),1.5,'triangle',0,vQ*0.7); }
                    else { playTone(midiToFreq(m1),0.8,'triangle',0,vQ); playTone(midiToFreq(m2),1.2,'triangle',0.8,vQ); }
                }
            } else {
                const list = HARMONY_LEVELS[state.harmonyLevel][state.currentRoundTonality];
                const rawProg = list[Math.floor(Math.random()*list.length)];
                const chords = rawProg.split(' - ');
                const len = chords.length;
                let maxInvTriad = state.harmonyLevel === 'basic' ? 0 : (state.harmonyLevel === 'inter' ? 1 : 2);
                
                const progressionData = chords.map(c => {
                    const has7th = c.includes('7');
                    const inv = Math.floor(Math.random() * (has7th ? 4 : (maxInvTriad + 1)));
                    return { roman: c.trim(), inv: inv, has7th: has7th };
                });

                const fullAnswerHTML = progressionData.map(d => getChordLabelHTML(d.roman, d.inv, d.has7th)).join('<span class="separator-dash">-</span>');
                const fullAnswerText = progressionData.map(d => d.roman + d.inv).join('-'); 
                state.target = { type: 'harmony', answer: fullAnswerText, data: progressionData };

                const sameLenProgs = list.filter(p => p.split(' - ').length === len);
                const options = [{text: fullAnswerText, html: fullAnswerHTML}];
                let pool = [...sameLenProgs]; 
                while(options.length < 4 && pool.length > 0) {
                    const dp = pool.splice(Math.floor(Math.random() * pool.length), 1)[0];
                    const dData = dp.split(' - ').map(c => ({ roman: c.trim(), inv: Math.floor(Math.random() * (c.includes('7') ? 4 : (maxInvTriad + 1))), has7th: c.includes('7') }));
                    const dText = dData.map(d => d.roman + d.inv).join('-');
                    const dHTML = dData.map(d => getChordLabelHTML(d.roman, d.inv, d.has7th)).join('<span class="separator-dash">-</span>');
                    if(dText !== fullAnswerText && !options.some(x => x.text === dText)) options.push({ text: dText, html: dHTML });
                }
                renderHarmonyOptions(options.sort(() => 0.5 - Math.random()));
                
                if(!state.imagina) {
                    let t = 0, vc = null; const vB = parseFloat(document.getElementById('vol-bass')?.value || 0.5);
                    progressionData.forEach(d => {
                        const notes = getChordVoices(d.roman, state.currentRoundTonality, d.inv);
                        const bassMidi = state.keyIndex + notes[0] - 12;
                        vc = getBestVoicingForHarmony(notes, vc);
                        playTone(midiToFreq(bassMidi), 1.2, 'sine', t, vB);
                        vc.forEach(n => playTone(midiToFreq(n), 1.2, 'triangle', t, 0.1));
                        t += 1.3;
                    });
                }
            }
        }

        function getBestVoicingForHarmony(notes, prev) {
            const absNotes = notes.slice(1);
            if (!prev) return absNotes.map(n => { let m = n + state.keyIndex; while(m<58) m+=12; while(m>74) m-=12; return m; }).sort();
            return absNotes.map(targetPC => {
                const pc = (targetPC + state.keyIndex) % 12;
                let best = prev[0], minDiff = 100;
                for (let oct = -1; oct <= 1; oct++) {
                    const testNote = pc + (state.keyIndex - (state.keyIndex%12)) + (oct*12);
                    prev.forEach(prevNote => { const diff = Math.abs(testNote - prevNote); if(diff < minDiff){ minDiff=diff; best=testNote; }});
                }
                return best;
            }).sort();
        }

        function getMelodicPossibleIntervals() {
            const isMin = state.currentRoundTonality === 'minor';
            switch(state.level) {
                case 'basic1': return isMin ? [0, 2, 3, 5] : [0, 2, 4, 5];
                case 'basic2': return isMin ? [7, 8, 10, 12] : [7, 9, 11, 12];
                case 'inter': return isMin ? [0, 2, 3, 5, 7, 8, 10, 12] : [0, 2, 4, 5, 7, 9, 11, 12];
                default: return Array.from({length:13},(_,i)=>i);
            }
        }

        function checkAnswer(val) {
            if(!state.target || state.isPlaying) return;
            if(state.mode === 'melody') {
                state.userBuffer.push(val); const dots = document.querySelectorAll('.buffer-dot');
                if(dots[state.userBuffer.length-1]) dots[state.userBuffer.length-1].classList.add('active');
                if(state.userBuffer.length === state.target.sequence.length) {
                    const ok = state.userBuffer.every((v,i)=>v===state.target.sequence[i].interval);
                    showResult(ok, state.userBuffer.map(s => getNoteName(state.keyLabel, s)).join('-'), state.target.sequence.map(s => getNoteName(state.keyLabel, s.interval)).join('-'));
                }
            } else showResult(val === state.target.answer, val, state.target.answer);
        }

        function showResult(ok, u, c) {
            const comboEl = document.getElementById('combo-display');
            if(ok) { 
                state.score++; state.streak++; if(state.streak > 1 && comboEl) { comboEl.innerText = `COMBO x${state.streak} üî•`; comboEl.classList.add('combo-active'); }
                triggerConfetti(); 
            } else { state.streak = 0; if(comboEl) comboEl.classList.remove('combo-active'); trackError(state.mode === 'melody' ? state.target.sequence[0].interval : 0); }
            document.getElementById('score-val').innerText = state.score;
            const m = document.getElementById('result-modal'); const rt = document.getElementById('result-title');
            const detail = document.getElementById('harmony-result-detail');
            
            if(m) {
                m.style.display = 'flex'; document.getElementById('result-icon').innerHTML = ok ? "üéâ" : "‚ùå";
                rt.innerText = ok ? "¬°Excelente!" : "Casi...";
                rt.className = `text-3xl font-black uppercase mb-2 ${ok ? 'text-emerald-500' : 'text-rose-500'}`;
                
                if(state.mode === 'harmony') {
                    detail.classList.remove('hidden');
                    document.getElementById('res-american').innerText = state.target.data.map(d => getAmericanChordName(state.keyLabel, state.currentRoundTonality, d.roman, d.inv, d.has7th)).join(' - ');
                    document.getElementById('res-roman').innerHTML = state.target.data.map(d => getChordLabelHTML(d.roman, d.inv, d.has7th)).join('<span class="separator-dash">-</span>');
                    document.getElementById('result-user').classList.add('hidden');
                    document.getElementById('correct-block').classList.add('hidden');
                } else {
                    detail.classList.add('hidden');
                    document.getElementById('result-user').classList.remove('hidden');
                    document.getElementById('result-user').innerText = u;
                    document.getElementById('correct-block').classList.toggle('hidden', ok);
                    document.getElementById('result-correct').innerText = c;
                }
            }

            if(ok) {
                if(state.mode === 'harmony') {
                    // REQUISITO: Repetir los bajos de la respuesta correcta
                    setTimeout(() => {
                        let t = 0; const vB = parseFloat(document.getElementById('vol-bass')?.value || 0.5);
                        state.target.data.forEach(d => {
                            const notes = getChordVoices(d.roman, state.currentRoundTonality, d.inv);
                            const bassMidi = state.keyIndex + notes[0] - 12;
                            playTone(midiToFreq(bassMidi), 0.8, 'sine', t, vB);
                            t += 0.9;
                        });
                    }, 500);
                } else if(state.mode === 'interval') playIntervalFeedback(state.target.m1, state.target.m2, () => {});
                else executeRes(state.target.sequence[state.target.sequence.length-1].interval, () => {});
            }
        }

        function playIntervalFeedback(m1, m2, callback) {
            const vQ = parseFloat(document.getElementById('vol-question')?.value || 0.4);
            highlightKey(m1); playTone(midiToFreq(m1), 0.7, 'triangle', 0, vQ);
            setTimeout(() => { highlightKey(m2); playTone(midiToFreq(m2), 0.8, 'triangle', 0, vQ); }, 600);
            setTimeout(() => { highlightKey(m1); highlightKey(m2); playTone(midiToFreq(m1), 1.2, 'triangle', 0, vQ*0.7); playTone(midiToFreq(m2), 1.2, 'triangle', 0, vQ*0.7); }, 1400);
            if(callback) setTimeout(callback, 2600);
        }

        function highlightKey(midi) {
            const norm = ((midi - state.keyIndex) % 12 + 12) % 12;
            const cat = getFunctionalClass(norm, state.currentRoundTonality);
            const colorGlow = cat === 'tonic' ? 'res-tonic-glow' : (cat === 'stable' ? 'res-stable-glow' : (cat === 'semi' ? 'res-semi-glow' : 'res-unstable-glow'));
            document.querySelectorAll(`[data-interval="${norm}"]`).forEach(k => {
                k.classList.add('highlight-res', colorGlow);
                setTimeout(() => k.classList.remove('highlight-res', colorGlow), 500);
            });
        }

        function executeRes(idx, callback) {
            const path = RESOLUTIONS[idx] || [idx]; let t = 0;
            path.forEach((step, i) => {
                const midi = state.keyIndex + step;
                playTone(midiToFreq(midi), (i===path.length-1?1.5:0.5), 'triangle', t, 0.4);
                setTimeout(() => {
                    const norm = ((step % 12) + 12) % 12;
                    const cat = getFunctionalClass(norm, state.currentRoundTonality);
                    const colorGlow = cat === 'tonic' ? 'res-tonic-glow' : (cat === 'stable' ? 'res-stable-glow' : (cat === 'semi' ? 'res-semi-glow' : 'res-unstable-glow'));
                    document.querySelectorAll(`[data-interval="${norm}"]`).forEach(k => {
                        k.classList.add('highlight-res', colorGlow);
                        setTimeout(() => k.classList.remove('highlight-res', colorGlow), 400);
                    });
                }, t * 1000);
                t += 0.55;
            });
            if(callback) setTimeout(callback, t * 1000);
        }

        function renderUI() {
            const stage = document.getElementById('piano-stage'), container = document.getElementById('practice-chips-container');
            if(!stage || !container) return; stage.innerHTML = ''; container.innerHTML = '';
            const offsets = [0, 0.6, 1, 1.6, 2, 3, 3.6, 4, 4.6, 5, 5.6, 6]; const isMin = state.currentRoundTonality === 'minor';
            for(let i=0; i<25; i++) {
                const midi = 48 + i, abs = midi % 12, relPos = (Math.floor(i/12)*7) + offsets[abs];
                const btn = document.createElement('button'); btn.className = [1,3,6,8,10].includes(abs) ? 'key-black' : 'key-white'; btn.style.left = `calc(${relPos} * (100% / 15))`;
                const func = ((midi - state.keyIndex) % 12 + 12) % 12; btn.setAttribute('data-interval', func);
                const cat = getFunctionalClass(func, state.currentRoundTonality);
                const colorClass = `bg-${cat} ${cat==='tonic'?'animate-pulse-tonic':''}`;
                let label = DEGREES[func]; if(isMin && [3,8,10].includes(func)) label = 'b' + (func===3?'3':(func===8?'6':'7'));
                btn.innerHTML = `<div class="degree-tag ${colorClass}">${label}</div>`;
                btn.onclick = () => { initAudio(); executeRes(func); checkAnswer(func); };
                stage.appendChild(btn);
            }
            getMelodicPossibleIntervals().forEach(idx => {
                const chip = document.createElement('div'); const cat = getFunctionalClass(idx, state.currentRoundTonality);
                const colorClass = `bg-${cat} ${cat==='tonic'?'animate-pulse-tonic':''}`;
                let label = DEGREES[idx]; if(isMin && [3,8,10].includes(idx)) label = 'b' + (idx===3?'3':(idx===8?'6':'7'));
                chip.className = `practice-card border-2 border-slate-200 dark:border-slate-700 ${colorClass}`; chip.innerText = label;
                chip.onclick = () => { initAudio(); executeRes(idx); }; container.appendChild(chip);
            });
        }

        function trackError(k) { state.errorMap[k] = (state.errorMap[k] || 0) + 1; localStorage.setItem('trainer_errors_v3', JSON.stringify(state.errorMap)); }
        function selectGameMode(m, t) { initAudio(); sessionState.active = true; sessionState.type = m; state.firstFreeLoad = (m === 'free'); document.getElementById('start-modal').style.display='none'; if(m==='daily') startDailySession(t); else startGame(); }
        function showDailyOptions() { document.getElementById('start-main-view').classList.add('hidden'); document.getElementById('start-daily-view').classList.remove('hidden'); document.getElementById('streak-indicator').innerText = `${state.dailyStreak} D√≠as üî•`; }
        function backToMainStart() { document.getElementById('start-daily-view').classList.add('hidden'); document.getElementById('start-main-view').classList.remove('hidden'); }
        function setLevel(l) { state.level = l; document.querySelectorAll('#levels-mel-har .control-btn').forEach(b => b.classList.remove('active-choice')); document.getElementById(`lvl-${l}`)?.classList.add('active-choice'); renderUI(); }
        function setIntervalLevel(l) { state.intervalLevel = l; document.querySelectorAll('#levels-interval .control-btn').forEach(b => b.classList.remove('active-choice')); document.getElementById(`int-lvl-${l}`)?.classList.add('active-choice'); }
        function setHarmonyLevel(l) { state.harmonyLevel = l; document.querySelectorAll('#levels-harmony .control-btn').forEach(b => b.classList.remove('active-choice')); document.getElementById(`har-lvl-${l}`)?.classList.add('active-choice'); }
        function setTonalityMode(m) { state.tonalityMode = m; document.querySelectorAll('#tonality-controls .control-btn').forEach(b => b.classList.remove('active-choice')); document.getElementById(`ton-${m}`)?.classList.add('active-choice'); state.currentRoundTonality = m === 'combined' ? state.currentRoundTonality : m; renderUI(); }
        function setGlobalMode(m) { stopAllSounds(); state.mode = m; document.querySelectorAll('#main-mode-group .control-btn').forEach(b => b.classList.remove('active-choice')); document.getElementById(`mode-${m.slice(0,3)}-btn`)?.classList.add('active-choice'); document.getElementById('levels-mel-har').classList.toggle('hidden', m!=='melody'); document.getElementById('levels-interval').classList.toggle('hidden', m!=='interval'); document.getElementById('levels-harmony').classList.toggle('hidden', m!=='harmony'); document.getElementById('practice-module').classList.toggle('hidden', m==='harmony' || m==='interval'); document.getElementById('piano-stage').classList.toggle('hidden', m==='harmony' || m==='interval'); document.getElementById('harmony-grid').classList.toggle('hidden', m!=='harmony' && m!=='interval'); resetUI(); }
        function toggleMixer() { const p = document.getElementById('mixer-panel'); if(p) p.classList.toggle('hidden'); if(p && !p.classList.contains('hidden')) p.style.display = 'flex'; }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); }
        function toggleImagina() { state.imagina = !state.imagina; document.getElementById('imagina-dot-active')?.classList.toggle('hidden', !state.imagina); }
        function closeStats() { document.getElementById('stats-modal').style.display='none'; }
        function openStats() { const h = document.getElementById('heatmap-grid'); if(h) { h.innerHTML = ''; DEGREES.forEach((d, i) => { const count = state.errorMap[i] || 0; const op = Math.min(1, count / 10); h.innerHTML += `<div class="heatmap-cell" style="background: rgba(239, 68, 68, ${op}); border-color: #ef4444">${d}</div>`; }); } document.getElementById('stats-modal').style.display='flex'; }
        function renderHarmonyOptions(opts) { const g = document.getElementById('harmony-grid'); if(!g) return; g.innerHTML=''; opts.forEach(o=>{ const b = document.createElement('button'); b.className="border-2 border-slate-200 dark:border-slate-700 hover:border-violet-400 transition-all"; b.innerHTML = o.html || `<div class="cipher-text">${o.text || o}</div>`; b.onclick=()=>checkAnswer(o.text || o); g.appendChild(b); }); }
        function renderBufferDots(c) { const b = document.getElementById('buffer-dots'); if(!b) return; b.innerHTML=''; for(let i=0; i<c; i++) b.innerHTML+='<div class="buffer-dot"></div>'; }
        function showHint(t) { const f = document.getElementById('feedback-text'); const fb = document.getElementById('feedback-ui'); if(f && fb) { f.innerText=t; fb.classList.remove('hidden'); } }
        function handleContinue() { document.getElementById('result-modal').style.display = 'none'; startGame(); }
        function triggerConfetti() { const c = document.getElementById('confetti-container'); if(!c) return; c.innerHTML=''; for(let i=0; i<15; i++){ const p=document.createElement('div'); p.className='absolute w-2 h-4 bg-violet-500 animate-confetti'; p.style.left=Math.random()*100+'%'; c.appendChild(p); } }
        function repeatTargetSound() { if(state.target){ const vQ = parseFloat(document.getElementById('vol-question')?.value || 0.4); if(state.mode==='melody') state.target.sequence.forEach((s,i)=>playTone(midiToFreq(s.midi), 0.9, 'triangle', i*0.8, vQ)); else if(state.mode==='interval') { if(state.target.isH){ playTone(midiToFreq(state.target.m1),1.5,'triangle',0,vQ*0.7); playTone(midiToFreq(state.target.m2),1.5,'triangle',0,vQ*0.7); } else { playTone(midiToFreq(state.target.m1),0.8,'triangle',0,vQ); playTone(midiToFreq(state.target.m2),1.2,'triangle',0.8,vQ); } } else { let t=0,vc=null; const vB = parseFloat(document.getElementById('vol-bass')?.value || 0.5); state.target.data.forEach(d => { const notes = getChordVoices(d.roman, state.currentRoundTonality, d.inv); const bassMidi = state.keyIndex + notes[0] - 12; vc=getBestVoicingForHarmony(notes, vc); playTone(midiToFreq(bassMidi), 1.2, 'sine', t, vB); vc.forEach(n => playTone(midiToFreq(n), 1.2, 'triangle', t, 0.1)); t+=1.3; }); } } }
        function resetUI() { document.getElementById('result-modal').style.display = 'none'; document.getElementById('feedback-ui')?.classList.add('hidden'); renderUI(); }
        function resetAllData() { localStorage.clear(); location.reload(); }
        function requestExit() { document.getElementById('exit-confirm-modal').style.display = 'flex'; }
        function closeExitModal() { document.getElementById('exit-confirm-modal').style.display = 'none'; }
        function confirmExit() { localStorage.removeItem('trainer_active_session_v3'); location.reload(); }
        function saveSession() { if(!sessionState.active) return; localStorage.setItem('trainer_active_session_v3', JSON.stringify({ type: sessionState.type, totalDuration: sessionState.totalDuration, timeLeft: sessionState.timeLeft, score: state.score })); }
        function resumeActiveSession() { const saved = JSON.parse(localStorage.getItem('trainer_active_session_v3')); if(saved) { state.score = saved.score; document.getElementById('score-val').innerText = state.score; startDailySession(saved.type, saved.timeLeft, saved.totalDuration); document.getElementById('start-modal').style.display = 'none'; } }
        function startDailySession(type, resumeTime = null, resumeTotal = null) { const d = resumeTotal || (type==='minimal'?300:1200); sessionState = { active: true, type: type, totalDuration: d, timeLeft: resumeTime || d, timerId: null }; document.getElementById('session-bar-container').style.display='block'; document.getElementById('session-time-remaining').classList.remove('hidden'); if(state.dailyStreak<3) setLevel('basic1'); else if(state.dailyStreak<7) setLevel('inter'); else setLevel('adv2'); setIntervalLevel(Math.min(6, Math.floor(state.dailyStreak/2)+1)); if(sessionState.timerId) clearInterval(sessionState.timerId); sessionState.timerId = setInterval(() => { sessionState.timeLeft--; saveSession(); const pct = ((sessionState.totalDuration-sessionState.timeLeft)/sessionState.totalDuration)*100; document.getElementById('session-progress').style.width=pct+"%"; const m=Math.floor(sessionState.timeLeft/60), s=sessionState.timeLeft%60; document.getElementById('session-timer-text').innerText=`${m}:${s<10?'0':''}${s}`; if(sessionState.timeLeft<=0){ clearInterval(sessionState.timerId); state.dailyStreak++; localStorage.setItem('trainer_streak_v3', state.dailyStreak); localStorage.setItem('trainer_date_v2', new Date().toDateString()); localStorage.removeItem('trainer_active_session_v3'); location.reload(); } }, 1000); startGame(); }
        window.onload = () => { renderUI(); };
    </script>
</body>
</html>
